{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Microsoft Exchange Server Support Scripts This project contains scripts for supporting and troubleshooting Microsoft Exchange Server. Popular Scripts Script Docs Download HealthChecker.ps1 Docs Download ExchangeExtendedProtectionManagement.ps1 Docs Download SetupAssist.ps1 Docs Download SourceSideValidations.ps1 Docs Download Test-AMSI.ps1 Docs Download","title":"Microsoft Exchange Server Support Scripts"},{"location":"#microsoft-exchange-server-support-scripts","text":"This project contains scripts for supporting and troubleshooting Microsoft Exchange Server.","title":"Microsoft Exchange Server Support Scripts"},{"location":"#popular-scripts","text":"Script Docs Download HealthChecker.ps1 Docs Download ExchangeExtendedProtectionManagement.ps1 Docs Download SetupAssist.ps1 Docs Download SourceSideValidations.ps1 Docs Download Test-AMSI.ps1 Docs Download","title":"Popular Scripts"},{"location":"Emerging-Issues/","text":"Emerging Issues for Exchange On-Premises This page lists emerging issues for Exchange On-Premises deployments, possible root cause and solution/workaround to fix the issues. The page will be consistently updated with new issues found and reflect current status of the issues mentioned. Updated on 11/8/2022 Issue Possible reason Workaround/Solution Zero-day vulnerabilities reported in Microsoft Exchange Server, CVE-2022-41040 and CVE-2022-41082 N/A Install November 2022 Exchange Server Security Updates to address the vulnerability Updated on 5/11/2022 Issue Possible reason Workaround/Solution After installing March 2022 Security Update For Exchange Server 2013, 2016, 2019 , the Microsoft Exchange Service Host service may crash repeatedly with Event ID 7031 in system log and Event ID 4999 in application log. Event ID 4999 Watson report about to be sent for process id: 4564, with parameters: E12IIS, c-RTL-AMD64, 15.01.2375.024, M.Exchange.ServiceHost, M.Exchange.Diagnostics, M.E.D.ChainedSerializationBinder.LoadType, M.E.Diagnostics.BlockedDeserializeTypeException, c0e9-dumptidset, 15.01.2375.024. The issue can occur if there are any expired certificates present on or any certificates nearing expiry on the server Install May 2022 Exchange Server Security Updates to resolve the issue Updated on 3/16/2022 Issue Possible reason Workaround/Solution After installing March 2022 Security Update For Exchange Server 2013, 2016, 2019 , the Microsoft Exchange Service Host service may crash repeatedly with Event ID 7031 in system log and Event ID 4999 in application log. Event ID 4999 Watson report about to be sent for process id: 4564, with parameters: E12IIS, c-RTL-AMD64, 15.01.2375.024, M.Exchange.ServiceHost, M.Exchange.Diagnostics, M.E.D.ChainedSerializationBinder.LoadType, M.E.Diagnostics.BlockedDeserializeTypeException, c0e9-dumptidset, 15.01.2375.024. The issue can occur if there are any expired certificates present on or any certificates nearing expiry on the server Update 3/16/2022 Follow the steps from KB 5013118 to resolve the issue Old Issues Email Stuck in Transport Queues Issue Possible reason Workaround/Solution You may observe emails building up in the transport queues of Exchange Server 2016 and Exchange Server 2019. The issue does not impact Exchange 2013 servers. Following events may be noticed in the application log: Log Name: Application Source: FIPFS Logged: 1/1/2022 1:03:42 AM Event ID: 5300 Level: Error Computer: server1.contoso.com Description: The FIP-FS \"Microsoft\" Scan Engine failed to load. PID: 23092, Error Code: 0x80004005. Error Description: Can't convert \"2201010001\" to long. Log Name: Application Source: FIPFS Logged: 1/1/2022 11:47:16 AM Event ID: 1106 Level: Error Computer: server1.contoso.com Description: The FIP-FS Scan Process failed initialization. Error: 0x80004005. Error Details: Unspecified error. The problem relates to a date check failure with the change of the new year and it not a failure of the AV engine itself. This is not an issue with malware scanning or the malware engine, and it is not a security-related issue. The version checking performed against the signature file is causing the malware engine to crash, resulting in messages being stuck in transport queues. Run this script on each Exchange server in your organization. You can run this script on multiple servers in parallel. Check this article for detailed steps. November 2021 Security Update Following are the known issues after installing November 2021 Security Updates for Exchange On-Premises servers Issue Possible reason Workaround/Solution Hybrid OWA Redirect is broken after application of November SU for Exchange 2013/2016 and 2019. Users using Exchange 2016 and 2019 server will see error \":-( Something went wrong. We can't get that information right now. Please try again later. Exchange 2013 users will see error \"External component has thrown an exception.\" Some On-Premises environments, that are not using FBA, may also see cross-site OWA redirection fail with similar errors. After installing November SU, the OWA redirection URL for hybrid users is providing an encoded URL for &., causing the redirect to fail Update 1/12/2022 The OWA redirection issue is fixed in January 2022 security updates . Please install the relevant update to fix the issue. Alternatively, you can also use the workarounds provided in KB article 5008997 September Cumulative Updates Following are the known issues after installing September 2021 Cumulative Updates for Exchange On-Premises servers Issue Possible reason Workaround/Solution After installing the September 2021 CU, the Microsoft Exchange Transport Services will continue to crash. You can see the following message for the 4999 crash event Watson report about to be sent for process id: 10072, with parameters: E12IIS, c-RTL-AMD64, 15.02.0986.005, MSExchangeDelivery, M.Exchange.Transport, M.E.T.AcceptedDomainTable..ctor, System.FormatException, 28d7-dumptidset, 15.02.0986.005. Having a Wild Card Only (*) Accepted Domain Set on an Internal Relay. This is an open relay and is very bad to have set. Remove the Accepted Domain that is set to * and properly configure an anonymous relay on a receive connector or change to an External Relay. More Information: Allow anonymous relay on Exchange servers July 2021 Security Update/Cumulative Updates Following are the known issues after installing July 2021 Security Updates/Cumulative Updates for Exchange On-Premises servers Issue Possible reason Workaround/Solution OWA/ECP stops working after installing July Security Update with following error: ASSERT: HMACProvider.GetCertificates:protectionCertificates.Length<1 The issue occurs if OAuth certificate is missing or expired Follow steps on this article to re-publish the Oauth certificate. Do note it takes up to an hour for certificate to change place OWA/ECP stops working when accessed from load balanced URL, but works if directly accessed from the server URL The root cause for the issue is under investigation Follow steps in this article to fix the issue PrepareAD with Exchange 2016 CU21/Exchange 2019 CU10 error: Used domain controller dc1.contoso.com to read object CN=AdminSDHolder,CN=System,DC=Contoso,DC=COM. [ERROR] Object reference not set to an instance of an object. The issue is under investigation Follow steps in this article to fix the issue PrepareSchema in environments that have empty root AD domain July Security Update for Exchange 2013 have shipped schema changes and needs Exchange role installed for PrepareSchema, this makes it difficult for environments that have Exchange 2013 as the highest installed Exchange server and do not have an Exchange server installed in the same AD site as that of root AD domain. Option 1 Introduce a new server that meets system requirements for Exchange 2013 Management tools, in the root AD domain. Install just the Exchange 2013 Management Tools role on this server. Install the July security fix, perform Schema update. Option 2 PrepareSchema using Exchange 2016 21/Exchange 2019 CU10 media, as the CU\u2019s have the changes. However, once Exchange 2016/2019 media is used to perform schema update, you will need to continue using Exchange 2016/2019 media in the future as well. The Schema Version number for Exchange 2013 environment remains on 15312, even after installing SU and performing PrepareSchema This is expected behavior. The schema version is going to remain 15312 after installing Security Update and performing PrepareSchema After installing Exchange 2016 CU21/Exchange 2019 CU10, the values added to custom attributes using EAC are not retained. The scenario works fine in Exchange 2016 CU20/Exchange 2019 CU9 The issue is under investigation Workaround 1: Use EAC from Internet Explorer Workaround 2: Add the values using Exchange Management Shell","title":"Emerging Issues"},{"location":"Emerging-Issues/#emerging-issues-for-exchange-on-premises","text":"This page lists emerging issues for Exchange On-Premises deployments, possible root cause and solution/workaround to fix the issues. The page will be consistently updated with new issues found and reflect current status of the issues mentioned. Updated on 11/8/2022 Issue Possible reason Workaround/Solution Zero-day vulnerabilities reported in Microsoft Exchange Server, CVE-2022-41040 and CVE-2022-41082 N/A Install November 2022 Exchange Server Security Updates to address the vulnerability Updated on 5/11/2022 Issue Possible reason Workaround/Solution After installing March 2022 Security Update For Exchange Server 2013, 2016, 2019 , the Microsoft Exchange Service Host service may crash repeatedly with Event ID 7031 in system log and Event ID 4999 in application log. Event ID 4999 Watson report about to be sent for process id: 4564, with parameters: E12IIS, c-RTL-AMD64, 15.01.2375.024, M.Exchange.ServiceHost, M.Exchange.Diagnostics, M.E.D.ChainedSerializationBinder.LoadType, M.E.Diagnostics.BlockedDeserializeTypeException, c0e9-dumptidset, 15.01.2375.024. The issue can occur if there are any expired certificates present on or any certificates nearing expiry on the server Install May 2022 Exchange Server Security Updates to resolve the issue Updated on 3/16/2022 Issue Possible reason Workaround/Solution After installing March 2022 Security Update For Exchange Server 2013, 2016, 2019 , the Microsoft Exchange Service Host service may crash repeatedly with Event ID 7031 in system log and Event ID 4999 in application log. Event ID 4999 Watson report about to be sent for process id: 4564, with parameters: E12IIS, c-RTL-AMD64, 15.01.2375.024, M.Exchange.ServiceHost, M.Exchange.Diagnostics, M.E.D.ChainedSerializationBinder.LoadType, M.E.Diagnostics.BlockedDeserializeTypeException, c0e9-dumptidset, 15.01.2375.024. The issue can occur if there are any expired certificates present on or any certificates nearing expiry on the server Update 3/16/2022 Follow the steps from KB 5013118 to resolve the issue","title":"Emerging Issues for Exchange On-Premises"},{"location":"Emerging-Issues/#old-issues","text":"","title":"Old Issues"},{"location":"Emerging-Issues/#email-stuck-in-transport-queues","text":"Issue Possible reason Workaround/Solution You may observe emails building up in the transport queues of Exchange Server 2016 and Exchange Server 2019. The issue does not impact Exchange 2013 servers. Following events may be noticed in the application log: Log Name: Application Source: FIPFS Logged: 1/1/2022 1:03:42 AM Event ID: 5300 Level: Error Computer: server1.contoso.com Description: The FIP-FS \"Microsoft\" Scan Engine failed to load. PID: 23092, Error Code: 0x80004005. Error Description: Can't convert \"2201010001\" to long. Log Name: Application Source: FIPFS Logged: 1/1/2022 11:47:16 AM Event ID: 1106 Level: Error Computer: server1.contoso.com Description: The FIP-FS Scan Process failed initialization. Error: 0x80004005. Error Details: Unspecified error. The problem relates to a date check failure with the change of the new year and it not a failure of the AV engine itself. This is not an issue with malware scanning or the malware engine, and it is not a security-related issue. The version checking performed against the signature file is causing the malware engine to crash, resulting in messages being stuck in transport queues. Run this script on each Exchange server in your organization. You can run this script on multiple servers in parallel. Check this article for detailed steps.","title":"Email Stuck in Transport Queues"},{"location":"Emerging-Issues/#november-2021-security-update","text":"Following are the known issues after installing November 2021 Security Updates for Exchange On-Premises servers Issue Possible reason Workaround/Solution Hybrid OWA Redirect is broken after application of November SU for Exchange 2013/2016 and 2019. Users using Exchange 2016 and 2019 server will see error \":-( Something went wrong. We can't get that information right now. Please try again later. Exchange 2013 users will see error \"External component has thrown an exception.\" Some On-Premises environments, that are not using FBA, may also see cross-site OWA redirection fail with similar errors. After installing November SU, the OWA redirection URL for hybrid users is providing an encoded URL for &., causing the redirect to fail Update 1/12/2022 The OWA redirection issue is fixed in January 2022 security updates . Please install the relevant update to fix the issue. Alternatively, you can also use the workarounds provided in KB article 5008997","title":"November 2021 Security Update"},{"location":"Emerging-Issues/#september-cumulative-updates","text":"Following are the known issues after installing September 2021 Cumulative Updates for Exchange On-Premises servers Issue Possible reason Workaround/Solution After installing the September 2021 CU, the Microsoft Exchange Transport Services will continue to crash. You can see the following message for the 4999 crash event Watson report about to be sent for process id: 10072, with parameters: E12IIS, c-RTL-AMD64, 15.02.0986.005, MSExchangeDelivery, M.Exchange.Transport, M.E.T.AcceptedDomainTable..ctor, System.FormatException, 28d7-dumptidset, 15.02.0986.005. Having a Wild Card Only (*) Accepted Domain Set on an Internal Relay. This is an open relay and is very bad to have set. Remove the Accepted Domain that is set to * and properly configure an anonymous relay on a receive connector or change to an External Relay. More Information: Allow anonymous relay on Exchange servers","title":"September Cumulative Updates"},{"location":"Emerging-Issues/#july-2021-security-updatecumulative-updates","text":"Following are the known issues after installing July 2021 Security Updates/Cumulative Updates for Exchange On-Premises servers Issue Possible reason Workaround/Solution OWA/ECP stops working after installing July Security Update with following error: ASSERT: HMACProvider.GetCertificates:protectionCertificates.Length<1 The issue occurs if OAuth certificate is missing or expired Follow steps on this article to re-publish the Oauth certificate. Do note it takes up to an hour for certificate to change place OWA/ECP stops working when accessed from load balanced URL, but works if directly accessed from the server URL The root cause for the issue is under investigation Follow steps in this article to fix the issue PrepareAD with Exchange 2016 CU21/Exchange 2019 CU10 error: Used domain controller dc1.contoso.com to read object CN=AdminSDHolder,CN=System,DC=Contoso,DC=COM. [ERROR] Object reference not set to an instance of an object. The issue is under investigation Follow steps in this article to fix the issue PrepareSchema in environments that have empty root AD domain July Security Update for Exchange 2013 have shipped schema changes and needs Exchange role installed for PrepareSchema, this makes it difficult for environments that have Exchange 2013 as the highest installed Exchange server and do not have an Exchange server installed in the same AD site as that of root AD domain. Option 1 Introduce a new server that meets system requirements for Exchange 2013 Management tools, in the root AD domain. Install just the Exchange 2013 Management Tools role on this server. Install the July security fix, perform Schema update. Option 2 PrepareSchema using Exchange 2016 21/Exchange 2019 CU10 media, as the CU\u2019s have the changes. However, once Exchange 2016/2019 media is used to perform schema update, you will need to continue using Exchange 2016/2019 media in the future as well. The Schema Version number for Exchange 2013 environment remains on 15312, even after installing SU and performing PrepareSchema This is expected behavior. The schema version is going to remain 15312 after installing Security Update and performing PrepareSchema After installing Exchange 2016 CU21/Exchange 2019 CU10, the values added to custom attributes using EAC are not retained. The scenario works fine in Exchange 2016 CU20/Exchange 2019 CU9 The issue is under investigation Workaround 1: Use EAC from Internet Explorer Workaround 2: Add the values using Exchange Management Shell","title":"July 2021 Security Update/Cumulative Updates"},{"location":"Admin/Clear-MailboxPermission/","text":"Clear-MailboxPermission Download the latest release: Clear-MailboxPermission.ps1 Attempting to Add-MailboxPermission or Remove-MailboxPermission sometimes fails with the following message: The ACL for object is not in canonical order (Deny/Allow/Inherited) and will be ignored. This indicates that the ACEs that make up the ACL do not follow canonical ordering, which generally means denies before allows, and explicit before inherited. When the mailbox security descriptor is in this state, the cmdlets can no longer modify it. This script can be used to return it to a working state. The script does this by clearing all permissions and resetting it to the default permissions that a brand new mailbox would have. Common Usage The easiest way to use the script is to pipe the affected mailboxes to it: Get-Mailbox joe@contoso.com | .\\Clear-MailboxPermission.ps1 Note the script also supports -WhatIf and -Confirm. It will prompt for confirmation by default.","title":"Clear-MailboxPermission"},{"location":"Admin/Clear-MailboxPermission/#clear-mailboxpermission","text":"Download the latest release: Clear-MailboxPermission.ps1 Attempting to Add-MailboxPermission or Remove-MailboxPermission sometimes fails with the following message: The ACL for object is not in canonical order (Deny/Allow/Inherited) and will be ignored. This indicates that the ACEs that make up the ACL do not follow canonical ordering, which generally means denies before allows, and explicit before inherited. When the mailbox security descriptor is in this state, the cmdlets can no longer modify it. This script can be used to return it to a working state. The script does this by clearing all permissions and resetting it to the default permissions that a brand new mailbox would have.","title":"Clear-MailboxPermission"},{"location":"Admin/Clear-MailboxPermission/#common-usage","text":"The easiest way to use the script is to pipe the affected mailboxes to it: Get-Mailbox joe@contoso.com | .\\Clear-MailboxPermission.ps1 Note the script also supports -WhatIf and -Confirm. It will prompt for confirmation by default.","title":"Common Usage"},{"location":"Admin/Find-AmbiguousSids/","text":"Find-AmbiguousSids Download the latest release: Find-AmbiguousSids.ps1 Useful when Exchange throws NonUniqueRecipientException , but doesn't log the objects causing it. Syntax Find-AmbiguousSids . ps1 [ -GCName < string >] [ -IgnoreWellKnown < bool >] [ -Verbose ] Examples Find all ambiguous SIDs: .\\ Find-AmbiguousSids . ps1 Find all ambiguous SIDs while not ignoring the well-known ones, such as Everyone and other SIDs that always appear in multiple places: .\\ Find-AmbiguousSids . ps1 -IgnoreWellKnown $false Show each object being checked: .\\Find-AmbiguousSids.ps1 -Verbose","title":"Find-AmbiguousSids"},{"location":"Admin/Find-AmbiguousSids/#find-ambiguoussids","text":"Download the latest release: Find-AmbiguousSids.ps1 Useful when Exchange throws NonUniqueRecipientException , but doesn't log the objects causing it.","title":"Find-AmbiguousSids"},{"location":"Admin/Find-AmbiguousSids/#syntax","text":"Find-AmbiguousSids . ps1 [ -GCName < string >] [ -IgnoreWellKnown < bool >] [ -Verbose ]","title":"Syntax"},{"location":"Admin/Find-AmbiguousSids/#examples","text":"Find all ambiguous SIDs: .\\ Find-AmbiguousSids . ps1 Find all ambiguous SIDs while not ignoring the well-known ones, such as Everyone and other SIDs that always appear in multiple places: .\\ Find-AmbiguousSids . ps1 -IgnoreWellKnown $false Show each object being checked: .\\Find-AmbiguousSids.ps1 -Verbose","title":"Examples"},{"location":"Admin/Get-EASMailboxLogs/","text":"Get-EASMailboxLogs Download the latest release: Get-EASMailboxLogs.ps1 Used for when you need to get EAS Mailbox Logging over a long period of time. It will collect the logs and re-enable the Active Sync Logging enabled to avoid it being disabled after 72 hours. Syntax Get-EASMailboxLogs . ps1 [ -Mailbox < string []>] [ -OutputPath < string >] [ -Interval < int >] [ -EnableMailboxLoggingVerboseMode < bool >] Examples The following example collects logs for two mailbox every hour: .\\Get-EASMailboxLogs.ps1 -mailbox @(\"jim\",\"zeke\") -OutputPath C:\\EASLogs -interval 60 The following example collects logs for a mailbox: .\\Get-EASMailboxLogs.ps1 -Mailbox \"jim\" -OutputPath c:\\EASLogs The following example enables Verbose Logging on the current on premise server and collects logs for a mailbox: .\\Get-EASMailboxLogs.ps1 -Mailbox \"jim\" -OutputPath c:\\EASLogs -EnableMailboxLoggingVerboseMode $true","title":"Get-EASMailboxLogs"},{"location":"Admin/Get-EASMailboxLogs/#get-easmailboxlogs","text":"Download the latest release: Get-EASMailboxLogs.ps1 Used for when you need to get EAS Mailbox Logging over a long period of time. It will collect the logs and re-enable the Active Sync Logging enabled to avoid it being disabled after 72 hours.","title":"Get-EASMailboxLogs"},{"location":"Admin/Get-EASMailboxLogs/#syntax","text":"Get-EASMailboxLogs . ps1 [ -Mailbox < string []>] [ -OutputPath < string >] [ -Interval < int >] [ -EnableMailboxLoggingVerboseMode < bool >]","title":"Syntax"},{"location":"Admin/Get-EASMailboxLogs/#examples","text":"The following example collects logs for two mailbox every hour: .\\Get-EASMailboxLogs.ps1 -mailbox @(\"jim\",\"zeke\") -OutputPath C:\\EASLogs -interval 60 The following example collects logs for a mailbox: .\\Get-EASMailboxLogs.ps1 -Mailbox \"jim\" -OutputPath c:\\EASLogs The following example enables Verbose Logging on the current on premise server and collects logs for a mailbox: .\\Get-EASMailboxLogs.ps1 -Mailbox \"jim\" -OutputPath c:\\EASLogs -EnableMailboxLoggingVerboseMode $true","title":"Examples"},{"location":"Admin/Get-SimpleAuditLogReport/","text":"Get-SimpleAuditLogReport Download the latest release: Get-SimpleAuditLogReport.ps1 Exchange admin audit logs are not readily human readable. All of the data needed to understand what Cmdlet has been run is in the data but it is not very easy to read. Get-SimpleAuditLogReport will take the results of an audit log search and provide a significantly more human readable version of the data. It will parse the audit log and attempt to reconstruct the actual Cmdlet that was run. Common Usage $Search = Search-AdminAuditLog $search | C:\\Scripts\\Get-SimpleAuditLogReport.ps1 -agree How to use Gather admin audit log results using Search-AdminAuditLog . Pipe the results into the Get-SimpleAuditLogReport script. Open the CSV file created in the same directory with the script.","title":"Get-SimpleAuditLogReport"},{"location":"Admin/Get-SimpleAuditLogReport/#get-simpleauditlogreport","text":"Download the latest release: Get-SimpleAuditLogReport.ps1 Exchange admin audit logs are not readily human readable. All of the data needed to understand what Cmdlet has been run is in the data but it is not very easy to read. Get-SimpleAuditLogReport will take the results of an audit log search and provide a significantly more human readable version of the data. It will parse the audit log and attempt to reconstruct the actual Cmdlet that was run.","title":"Get-SimpleAuditLogReport"},{"location":"Admin/Get-SimpleAuditLogReport/#common-usage","text":"$Search = Search-AdminAuditLog $search | C:\\Scripts\\Get-SimpleAuditLogReport.ps1 -agree","title":"Common Usage"},{"location":"Admin/Get-SimpleAuditLogReport/#how-to-use","text":"Gather admin audit log results using Search-AdminAuditLog . Pipe the results into the Get-SimpleAuditLogReport script. Open the CSV file created in the same directory with the script.","title":"How to use"},{"location":"Admin/Remove-CertExpiryNotifications/","text":"Remove-CertExpiryNotifications Download the latest release: Remove-CertExpiryNotifications.ps1 This script deletes all AsyncOperationNotification items from the Exchange SystemMailbox that contains them. This corrects the BlockedDeserializeTypeException error described in KB5013118 . NOTE: This script only supports Exchange 2016 and Exchange 2019. It will not work on Exchange 2013. Syntax Remove-CertExpiryNotifications . ps1 [ -Server < string >] [[ -Credential ] < pscredential >] [ -WhatIf ] [ -Confirm ] Usage NOTE: If an error occurs please see Common Errors . The user running the script must be granted full access to the arbitration mailbox prior to running the script. That can be accomplished with this command: Get-Mailbox -Arbitration \"SystemMailbox{e0dc1c29-89c3-4034-b678-e6c29d823ed9}\" | Add-MailboxPermission -User SomeAdmin -AccessRights FullAccess Next, the same user that was granted access should run the script from Exchange Management Shell. Start by running the script with -WhatIf. Optionally, the -Credential switch can be provided. Otherwise, the current user will be used. .\\ Remove-CertExpiryNotifications . ps1 -Server exch1 . contoso . com -WhatIf If this succeeds, it will list all the messages that would be deleted. The output should look something like this: To remove the messages, the script can be run without -WhatIf: .\\ Remove-CertExpiryNotifications . ps1 -Server exch1 . contoso . com This syntax will cause it to prompt for each message: Or, the script can be run with -Confirm:$false to skip the prompts: .\\ Remove-CertExpiryNotifications . ps1 -Server exch1 . contoso . com -Confirm : $false After the script has run successfully, it should report that there are no messages present in the folder: Finally, remember to remove the permission that was granted to the user: Get-Mailbox -Arbitration \"SystemMailbox{e0dc1c29-89c3-4034-b678-e6c29d823ed9}\" | Remove-MailboxPermission -User SomeAdmin -AccessRights FullAccess Common errors Invoke-RestMethod : The underlying connection was closed : An unexpected error occurred on a send . \"Unexpected error occurred on a send\" usually means that the name in the certificate on the target server does not match what was specified in the -Server parameter. In other words, navigating to https://the.server.you.specified/owa must not return a certificate error. If it does, the script will fail. The specified server must be the name in the certificate bound to IIS. Invoke-RestMethod : The remote server returned an error : ( 401 ) Unauthorized . This can occur if the user running the script does not have full access to the mailbox. Be sure the Add-MailboxPermission command was successful. This can also occur if the server name specified is the local server, due to the loopback check. This can be resolved by passing a different name.","title":"Remove-CertExpiryNotifications"},{"location":"Admin/Remove-CertExpiryNotifications/#remove-certexpirynotifications","text":"Download the latest release: Remove-CertExpiryNotifications.ps1 This script deletes all AsyncOperationNotification items from the Exchange SystemMailbox that contains them. This corrects the BlockedDeserializeTypeException error described in KB5013118 . NOTE: This script only supports Exchange 2016 and Exchange 2019. It will not work on Exchange 2013.","title":"Remove-CertExpiryNotifications"},{"location":"Admin/Remove-CertExpiryNotifications/#syntax","text":"Remove-CertExpiryNotifications . ps1 [ -Server < string >] [[ -Credential ] < pscredential >] [ -WhatIf ] [ -Confirm ]","title":"Syntax"},{"location":"Admin/Remove-CertExpiryNotifications/#usage","text":"NOTE: If an error occurs please see Common Errors . The user running the script must be granted full access to the arbitration mailbox prior to running the script. That can be accomplished with this command: Get-Mailbox -Arbitration \"SystemMailbox{e0dc1c29-89c3-4034-b678-e6c29d823ed9}\" | Add-MailboxPermission -User SomeAdmin -AccessRights FullAccess Next, the same user that was granted access should run the script from Exchange Management Shell. Start by running the script with -WhatIf. Optionally, the -Credential switch can be provided. Otherwise, the current user will be used. .\\ Remove-CertExpiryNotifications . ps1 -Server exch1 . contoso . com -WhatIf If this succeeds, it will list all the messages that would be deleted. The output should look something like this: To remove the messages, the script can be run without -WhatIf: .\\ Remove-CertExpiryNotifications . ps1 -Server exch1 . contoso . com This syntax will cause it to prompt for each message: Or, the script can be run with -Confirm:$false to skip the prompts: .\\ Remove-CertExpiryNotifications . ps1 -Server exch1 . contoso . com -Confirm : $false After the script has run successfully, it should report that there are no messages present in the folder: Finally, remember to remove the permission that was granted to the user: Get-Mailbox -Arbitration \"SystemMailbox{e0dc1c29-89c3-4034-b678-e6c29d823ed9}\" | Remove-MailboxPermission -User SomeAdmin -AccessRights FullAccess","title":"Usage"},{"location":"Admin/Remove-CertExpiryNotifications/#common-errors","text":"Invoke-RestMethod : The underlying connection was closed : An unexpected error occurred on a send . \"Unexpected error occurred on a send\" usually means that the name in the certificate on the target server does not match what was specified in the -Server parameter. In other words, navigating to https://the.server.you.specified/owa must not return a certificate error. If it does, the script will fail. The specified server must be the name in the certificate bound to IIS. Invoke-RestMethod : The remote server returned an error : ( 401 ) Unauthorized . This can occur if the user running the script does not have full access to the mailbox. Be sure the Add-MailboxPermission command was successful. This can also occur if the server name specified is the local server, due to the loopback check. This can be resolved by passing a different name.","title":"Common errors"},{"location":"Admin/Reset-ScanEngineVersion/","text":"Reset-ScanEngineVersion Download the latest release: Reset-ScanEngineVersion.ps1 Syntax Reset-ScanEngineVersion . ps1 [ -Force < switch >] [ -EngineUpdatePath < string >] Usage Copy the script to an affected Exchange server and run it with no parameters. It can be run from EMS or plain PowerShell. In scenarios where centralized distribution of scan engines is used, add the -EngineUpdatePath switch to point to the share containing the engines. For example: .\\ Reset-ScanEngineVersion . ps1 -EngineUpdatePath \\\\ fileserver1 \\ ScanEngineUpdates","title":"Reset-ScanEngineVersion"},{"location":"Admin/Reset-ScanEngineVersion/#reset-scanengineversion","text":"Download the latest release: Reset-ScanEngineVersion.ps1","title":"Reset-ScanEngineVersion"},{"location":"Admin/Reset-ScanEngineVersion/#syntax","text":"Reset-ScanEngineVersion . ps1 [ -Force < switch >] [ -EngineUpdatePath < string >]","title":"Syntax"},{"location":"Admin/Reset-ScanEngineVersion/#usage","text":"Copy the script to an affected Exchange server and run it with no parameters. It can be run from EMS or plain PowerShell. In scenarios where centralized distribution of scan engines is used, add the -EngineUpdatePath switch to point to the share containing the engines. For example: .\\ Reset-ScanEngineVersion . ps1 -EngineUpdatePath \\\\ fileserver1 \\ ScanEngineUpdates","title":"Usage"},{"location":"Admin/SetUnifiedContentPath/","text":"SetUnifiedContentPath Download the latest release: SetUnifiedContentPath.ps1 Sets the CleanupFolderREsponderFolderPaths in the AntiMalware.xml file that is responsible for having Exchange automatically clean up the Unified Content that is left behind. If this isn't properly set, you can have large amount of files left on the computer that is just using up space and can cause issues with Exchange. The script will keep the default values of D:\\ExchangeTemp\\TransportCts\\UnifiedContent , C:\\Windows\\Temp\\UnifiedContent , and $ExInstall\\TransportRoles\\data\\Temp\\UnifiedContent within the value and will include TemporaryStoragePath from the EdgeTransport.exe.config if different from the install path. In order for the new settings to take effect right away, use the -RestartService switch to have the MSExchangeHM service take in the new changes right away. Common Usage The easiest way to run the script is against all the servers and restart the service. Get-ExchangeServer | .\\ SetUnifiedContentPath . ps1 -RestartService If you don't want to change anything just yet, use the -WhatIf switch to see what servers will have something changed. Get-ExchangeServer | .\\ SetUnifiedContentPath . ps1 -WhatIf Or you can just run it locally on the server .\\ SetUnifiedContentPath . ps1 -RestartService NOTE: The switch -RestartService is only going to restart the service if a change has been detected and done. Otherwise, it will not restart the service.","title":"SetUnifiedContentPath"},{"location":"Admin/SetUnifiedContentPath/#setunifiedcontentpath","text":"Download the latest release: SetUnifiedContentPath.ps1 Sets the CleanupFolderREsponderFolderPaths in the AntiMalware.xml file that is responsible for having Exchange automatically clean up the Unified Content that is left behind. If this isn't properly set, you can have large amount of files left on the computer that is just using up space and can cause issues with Exchange. The script will keep the default values of D:\\ExchangeTemp\\TransportCts\\UnifiedContent , C:\\Windows\\Temp\\UnifiedContent , and $ExInstall\\TransportRoles\\data\\Temp\\UnifiedContent within the value and will include TemporaryStoragePath from the EdgeTransport.exe.config if different from the install path. In order for the new settings to take effect right away, use the -RestartService switch to have the MSExchangeHM service take in the new changes right away.","title":"SetUnifiedContentPath"},{"location":"Admin/SetUnifiedContentPath/#common-usage","text":"The easiest way to run the script is against all the servers and restart the service. Get-ExchangeServer | .\\ SetUnifiedContentPath . ps1 -RestartService If you don't want to change anything just yet, use the -WhatIf switch to see what servers will have something changed. Get-ExchangeServer | .\\ SetUnifiedContentPath . ps1 -WhatIf Or you can just run it locally on the server .\\ SetUnifiedContentPath . ps1 -RestartService NOTE: The switch -RestartService is only going to restart the service if a change has been detected and done. Otherwise, it will not restart the service.","title":"Common Usage"},{"location":"Admin/Test-AMSI/","text":"Test-AMSI The Windows Antimalware Scan Interface (AMSI) is a versatile standard that allows applications and services to integrate with any antimalware product present on a machine. Seeing that Exchange administrators might not be familiar with AMSI, we wanted to provide a script that would make life a bit easier to test, enable, disable, or Check your AMSI Providers. Download Download the latest release: Test-AMSI.ps1 Common Usage After you download the script, you will need to run it within an elevated Exchange Management Shell Session If you want to test to see if AMSI integration is working you can run: .\\Test-AMSI.ps1 -ExchangeServerFQDN mail.contoso.com If you want to see what AMSI Providers are installed on the local machine you can run: .\\Test-AMSI.ps1 -CheckAMSIProviders If you want to enable AMSI on the Exchange Server, you can run: .\\Test-AMSI.ps1 -EnableAMSI If you want to disable AMSI on the Exchange Server, you can run: .\\Test-AMSI.ps1 -DisableAMSI If you want to restart the Internet Information Services (IIS) you can run: .\\Test-AMSI.ps1 -RestartIIS If you need to test and ignoring the certificate check you can run: .\\Test-AMSI.ps1 -IgnoreSSL More to come We will be adding the ability to review the web.config to make sure that the HttpRequestFilteringModule line is present We will be working on better output for PowerShell 7","title":"Test-AMSI"},{"location":"Admin/Test-AMSI/#test-amsi","text":"The Windows Antimalware Scan Interface (AMSI) is a versatile standard that allows applications and services to integrate with any antimalware product present on a machine. Seeing that Exchange administrators might not be familiar with AMSI, we wanted to provide a script that would make life a bit easier to test, enable, disable, or Check your AMSI Providers.","title":"Test-AMSI"},{"location":"Admin/Test-AMSI/#download","text":"Download the latest release: Test-AMSI.ps1","title":"Download"},{"location":"Admin/Test-AMSI/#common-usage","text":"After you download the script, you will need to run it within an elevated Exchange Management Shell Session If you want to test to see if AMSI integration is working you can run: .\\Test-AMSI.ps1 -ExchangeServerFQDN mail.contoso.com If you want to see what AMSI Providers are installed on the local machine you can run: .\\Test-AMSI.ps1 -CheckAMSIProviders If you want to enable AMSI on the Exchange Server, you can run: .\\Test-AMSI.ps1 -EnableAMSI If you want to disable AMSI on the Exchange Server, you can run: .\\Test-AMSI.ps1 -DisableAMSI If you want to restart the Internet Information Services (IIS) you can run: .\\Test-AMSI.ps1 -RestartIIS If you need to test and ignoring the certificate check you can run: .\\Test-AMSI.ps1 -IgnoreSSL","title":"Common Usage"},{"location":"Admin/Test-AMSI/#more-to-come","text":"We will be adding the ability to review the web.config to make sure that the HttpRequestFilteringModule line is present We will be working on better output for PowerShell 7","title":"More to come"},{"location":"Databases/Analyze-SpaceDump/","text":"Analyze-SpaceDump Download the latest release: Analyze-SpaceDump.ps1 This script reports the space taken up by various tables based on a database space dump. Usage The space dump must be obtained while the database is dismounted, or on a suspended copy if the issue is happening there. To obtain the space dump, use the following syntax: eseutil /ms /v > C:\\spacedump.txt Then, feed that file to this script as follows: .\\Analyze-SpaceDump.ps1 -File C:\\spacedump.txt This script will only work with Exchange 2013 and later space dumps.","title":"Analyze-SpaceDump"},{"location":"Databases/Analyze-SpaceDump/#analyze-spacedump","text":"Download the latest release: Analyze-SpaceDump.ps1 This script reports the space taken up by various tables based on a database space dump.","title":"Analyze-SpaceDump"},{"location":"Databases/Analyze-SpaceDump/#usage","text":"The space dump must be obtained while the database is dismounted, or on a suspended copy if the issue is happening there. To obtain the space dump, use the following syntax: eseutil /ms /v > C:\\spacedump.txt Then, feed that file to this script as follows: .\\Analyze-SpaceDump.ps1 -File C:\\spacedump.txt This script will only work with Exchange 2013 and later space dumps.","title":"Usage"},{"location":"Databases/Compare-MailboxStatistics/","text":"Compare-MailboxStatistics Download the latest release: Compare-MailboxStatistics.ps1 Usage This script compares two sets of mailbox statistics from the same database and highlights mailbox growth that occurred between the two snapshots. For a growing database, a typical approach would be to start by exporting the statistics for the database: Get-MailboxStatistics -Database DB1 | Export-CliXML C :\\ stats-before . xml After the initial export is obtained, wait until significant growth is observed. That could mean waiting an hour, or a day, depending on the scenario. At that point, compare the stats-before.xml with the live data by using this script as follows: .\\ Compare-MailboxStatistics . ps1 -Before ( Import-CliXml C :\\ stats-before . xml ) -After ( Get-MailboxStatistics -Database DB1 ) This makes it easy to see which mailboxes grew the most.","title":"Compare-MailboxStatistics"},{"location":"Databases/Compare-MailboxStatistics/#compare-mailboxstatistics","text":"Download the latest release: Compare-MailboxStatistics.ps1","title":"Compare-MailboxStatistics"},{"location":"Databases/Compare-MailboxStatistics/#usage","text":"This script compares two sets of mailbox statistics from the same database and highlights mailbox growth that occurred between the two snapshots. For a growing database, a typical approach would be to start by exporting the statistics for the database: Get-MailboxStatistics -Database DB1 | Export-CliXML C :\\ stats-before . xml After the initial export is obtained, wait until significant growth is observed. That could mean waiting an hour, or a day, depending on the scenario. At that point, compare the stats-before.xml with the live data by using this script as follows: .\\ Compare-MailboxStatistics . ps1 -Before ( Import-CliXml C :\\ stats-before . xml ) -After ( Get-MailboxStatistics -Database DB1 ) This makes it easy to see which mailboxes grew the most.","title":"Usage"},{"location":"Databases/VSSTester/","text":"VSSTester Download the latest release: VSSTester.ps1 The script is self-explanatory. You can test run diskshadow on a single Exchange database to ensure backups are working properly (i.e. all the Microsoft components). If the issue only happens with a 3rd-party backup solution, you can utilize operation mode 2 to enable just the logging while you execute a backup with the 3rd-party solution. More information https://techcommunity.microsoft.com/t5/exchange-team-blog/troubleshoot-your-exchange-2010-database-backup-functionality/ba-p/594367 https://techcommunity.microsoft.com/t5/exchange-team-blog/vsstester-script-updated-8211-troubleshoot-exchange-2013-and/ba-p/610976 COM+ Security Here are the steps to verify that the local Administrators group is allowed to the COM+ Security on the computer. The script will detect if this is a possibility if we can not see the Exchange Writers and we have the registry settings set that determine this is a possibility. Run \"dcomcnfg\" from the run box or command prompt on the problem machine Expand Component Services then Computers Right Click on My Computer and select Properties Select the COM Security tab and select Edit Default... under Access Permissions If the local Administrators group is not here for Allow for Local and Remote Access, click Add... to add the local Administrators group to the Default Security permissions Change the locations to the computer name Type in \"Administrators\" and select Check Names. Making sure the computer account comes up Add Local Access and Remote Access for Allow Click Okay Click Apply and Okay Restart the Computer","title":"VSSTester"},{"location":"Databases/VSSTester/#vsstester","text":"Download the latest release: VSSTester.ps1 The script is self-explanatory. You can test run diskshadow on a single Exchange database to ensure backups are working properly (i.e. all the Microsoft components). If the issue only happens with a 3rd-party backup solution, you can utilize operation mode 2 to enable just the logging while you execute a backup with the 3rd-party solution.","title":"VSSTester"},{"location":"Databases/VSSTester/#more-information","text":"https://techcommunity.microsoft.com/t5/exchange-team-blog/troubleshoot-your-exchange-2010-database-backup-functionality/ba-p/594367 https://techcommunity.microsoft.com/t5/exchange-team-blog/vsstester-script-updated-8211-troubleshoot-exchange-2013-and/ba-p/610976","title":"More information"},{"location":"Databases/VSSTester/#com-security","text":"Here are the steps to verify that the local Administrators group is allowed to the COM+ Security on the computer. The script will detect if this is a possibility if we can not see the Exchange Writers and we have the registry settings set that determine this is a possibility. Run \"dcomcnfg\" from the run box or command prompt on the problem machine Expand Component Services then Computers Right Click on My Computer and select Properties Select the COM Security tab and select Edit Default... under Access Permissions If the local Administrators group is not here for Allow for Local and Remote Access, click Add... to add the local Administrators group to the Default Security permissions Change the locations to the computer name Type in \"Administrators\" and select Check Names. Making sure the computer account comes up Add Local Access and Remote Access for Allow Click Okay Click Apply and Okay Restart the Computer","title":"COM+ Security"},{"location":"Diagnostics/ExTRA/","text":"ExTRA Download the latest release: ExTRA.ps1 The goal of this script is to replace the ExTRA UI that was included with older versions of Exchange. The script can be run on any machine where a modern browser (Edge/Chrome/Firefox) is set as the default browser. It does not need to be run on an Exchange server. It will not work if Internet Explorer is the default browser. Usage Generally, you will want to run this script on a user workstation and use it to generate the EnabledTraces.config file. Then, that file can be copied to the Exchange server, and a logman command can be used to start and stop the ExTRA trace. The script can be run directly on a server if desired, but remember that IE cannot be the default browser in that case. To use, download the latest release. Then run the script with no parameters: .\\ExTRA.ps1 The default browser will launch with a tag selection interface. Once the desired tags are selected, click Save and go back to the PowerShell window. You should see some output indicating that the EnabledTraces.config file was saved in the folder. That EnabledTraces.config should be placed at the root of C:\\ on the server being traced. The output also provides example logman syntax for creating, starting, and stopping the trace.","title":"ExTRA"},{"location":"Diagnostics/ExTRA/#extra","text":"Download the latest release: ExTRA.ps1 The goal of this script is to replace the ExTRA UI that was included with older versions of Exchange. The script can be run on any machine where a modern browser (Edge/Chrome/Firefox) is set as the default browser. It does not need to be run on an Exchange server. It will not work if Internet Explorer is the default browser.","title":"ExTRA"},{"location":"Diagnostics/ExTRA/#usage","text":"Generally, you will want to run this script on a user workstation and use it to generate the EnabledTraces.config file. Then, that file can be copied to the Exchange server, and a logman command can be used to start and stop the ExTRA trace. The script can be run directly on a server if desired, but remember that IE cannot be the default browser in that case. To use, download the latest release. Then run the script with no parameters: .\\ExTRA.ps1 The default browser will launch with a tag selection interface. Once the desired tags are selected, click Save and go back to the PowerShell window. You should see some output indicating that the EnabledTraces.config file was saved in the folder. That EnabledTraces.config should be placed at the root of C:\\ on the server being traced. The output also provides example logman syntax for creating, starting, and stopping the trace.","title":"Usage"},{"location":"Diagnostics/ExchangeLogCollector/","text":"Exchange Log Collector Download the latest release: ExchangeLogCollector.ps1 This script is intended to collect the Exchange default logging data from the server in a consistent manner to make it easier to troubleshoot an issue when large amounts of data is needed to be collected. You can specify what logs you want to collect by the switches that are available, then the script has logic built in to determine how to collect the data. How to Run The script must be run as Administrator in PowerShell session on an Exchange Server or Tools box. Supported to run and collected logs against Exchange 2013 and greater. The intent of the script is to collect logs only that you need from X servers quickly without needing to have to manually collect it yourself and label zip them all up for you. If you don't know what logs to collect, it is recommended to use -AllPossibleLogs . This script no longer supports collecting logs from Exchange 2010. However, the last release of v2 should still work just fine. You can download that here . The script is able to collect from the large set of servers while using the Invoke-Command. Prior to executing the main script, we check to make sure the server is up and that we are able to use Invoke-Command against the server. If Invoke-Command works remotely, then we will allow you to attempt to collect the data. You can still utilize the script to collect locally as it used to be able to, if the target OS doesn't allow this. Prior to collecting the data, we check to make sure that there is at least 10GB of free space at the location of where we are trying to save the data of the target server. The script will continue to keep track of all the logs and data that is being copied over and will stop if we have less than 10GB of free space. You are able to use a config file to load up all the parameters you wish to choose and the servers you wish to run the script against. Just create a file called ExchangeLogCollector.ps1.json and place at the same location as the script. Then provide the switches you would like to use in the file like so: { \"Servers\": [ \"ADT-E16A\", \"ADT-E16B\", \"ADT-E16C\" ], \"FilePath\": \"C:\\\\MS_Logs\", \"IISLogs\": true, \"AcceptEULA\": true, \"AppSysLogsToXml\": false, \"ScriptDebug\": true } NOTE: It is import that you use \\\\ for the file path otherwise the settings will fail to load. Examples: This cmdlet will collect all default logs of the local Exchange Server and store them in the default location of \"C:\\MS_Logs_Collection\" .\\ExchangeLogCollector.ps1 -AllPossibleLogs This cmdlet will collect all relevant data regarding database failovers from server EXCH1 and EXCH2 and store them at Z:\\Data\\Logs. Note: at the end of the collection, the script will copy over the data to the local host execution server to make data collection even easier. .\\ExchangeLogCollector.ps1 -DatabaseFailoverIssue -Servers EXCH1,EXCH2 -FilePath Z:\\Data\\Logs This cmdlet will collect all relevant data regarding IIS Logs (within the last 3 days by default) and all RPC type logs from the servers EXCH1 and EXCH2 and store them at the default location of \"C:\\MS_Logs_Collection\" .\\ExchangeLogCollector.ps1 -Servers EXCH1,EXCH2 -IISLogs -RPCLogs This cmdlet will collect all relevant data regarding Message Tracking Logs and Protocol Logs for the past 3 hours from the servers EXCH1 and EXCH2 and store them at the default location of \"C:\\MS_Logs_Collection\" .\\ExchangeLogCollector.ps1 -Servers EXCH1,EXCH2 -MessageTrackingLogs -ProtocolLogs -LogAge \"03:00:00\" Parameters Parameter Description FilePath The Location of where you would like the data to be copied over to. This location must be the same and accessible on all servers if you use the Servers parameter. Default value: C:\\MS_Logs_Collection Servers An array of servers that you would like to collect data from. ADDriverLogs Enable to collect AD Driver Logs. Location: V15\\Logging\\ADDriver AppSysLogs Collects the Windows Event Application, System, and MSExchange Management Logs. Default value $true AppSysLogsToXml Collects the Windows Event Application and System and saves them out to XML. The time range only is from the time the script run and the value set on LogAge . Default value: $true AutoDLogs Enable to collect AutoDiscover Logs. Location: V15\\Logging\\Autodiscover and V15\\Logging\\HttpProxy\\Autodiscover CollectFailoverMetrics Enable to run the CollectOverMetrics.ps1 script against the DAG. Only able to be run on an Exchange tools box or an Exchange Server. DAGInformation Enable to collect the DAG Information from all different DAGs that are in the list of servers. DailyPerformanceLogs Enable to collect Daily Performance Logs. Default Location: V15\\Logging\\Diagnostics\\DailyPerformanceLogs DefaultTransportLogging Enables the following switches and their logs to be collected. FrontEndConnectivityLogs , FrontEndProtocolLogs , HubConnectivityLogs , MailboxConnectivityLogs , MailboxDeliveryThrottlingLogs , MessageTrackingLogs , QueueInformation , ReceiveConnectors , SendConnectors , and TransportConfig EASLogs Enable to collect Exchange Active Sync Logging. Location: V15\\Logging\\HttpProxy\\Eas ECPLogs Enable to collect ECP Logs. Location: V15\\Logging\\ECP and V15\\Logging\\HttpProxy\\Ecp EWSLogs Enable to collect EWS Logs. Location: V15\\Logging\\HttpProxy\\Ews and V15\\Logging\\Ews ExchangeServerInformation Enable to collect Exchange Information like Get-ExchangeServer, Get-MailboxServer, etc... This is also collected when -ServerInformation is also enabled. Exmon Enable to collect exmon data from the server. Experfwiz Enable to collect Experfwiz data if found. FrontEndConnectivityLogs Enable to collect the connectivity logging on the FE. Location: (Get-FrontendTransportService $server).ConnectivityLogPath FrontEndProtocolLogs Enable to collect the protocol logging on the FE. Location: (Get-FrontendTransportService $server).ReceiveProtocolLogPath and (Get-FrontendTransportService $server).SendProtocolLogPath GetVdirs Enable to collect the Virtual Directories of the environment. HighAvailabilityLogs Enable to collect High Availability Logs. Windows Event Logs like: Microsoft-Exchange-HighAvailability , Microsoft-Exchange-MailboxDatabaseFailureItems , and Microsoft-Windows-FailoverClustering HubConnectivityLogs Enable to collect the Hub connectivity logging. Location: (Get-TransportService $server).ConnectivityLogPath HubProtocolLogs Enable to collect the protocol logging. Location: (Get-TransportService $server).ReceiveProtocolLogPath and (Get-TransportService $server).SendProtocolLogPath IISLogs Enable to collect IIS Logs and HTTPErr Logs from the Exchange Server. Default Location: C:\\inetpub\\logs\\LogFiles\\W3SVC1 , C:\\inetpub\\logs\\LogFiles\\W3SVC2 , and C:\\Windows\\System32\\LogFiles\\HTTPERR . IISlogs do not collect all logs on CollectAllLogsBasedOnLogAge:$false, just works based on log age. ImapLogs Enable to collect IMAP logging. Location: (Get-ImapSettings -Server $server).LogFileLocation MailboxAssistantsLogs Enable to collect Mailbox Assistants logging. Location: V15\\Logging\\MailboxAssistantsLog , V15\\Logging\\MailboxAssistantsSlaReportLog , and V15\\Logging\\MailboxAssistantsDatabaseSlaLog MailboxConnectivityLogs Enable to collect the connectivity logging on the mailbox server. Location: (Get-MailboxTransportService $server).ConnectivityLogPath MailboxDeliveryThrottlingLogs Enable to collect the mailbox delivery throttling logs on the server. Location: (Get-MailboxTransportService $server).MailboxDeliveryThrottlingLogPath MailboxProtocolLogs Enable to collect protocol logging on the mailbox server. Location: (Get-MailboxTransportService $server).ReceiveProtocolLogPath and (Get-MailboxTransportService $server).SendProtocolLogPath ManagedAvailabilityLogs Enable to collect the Managed Availability Logs. Location: V15\\Logging\\Monitoring and Windows Event logs like Microsoft-Exchange-ManagedAvailability MapiLogs Enable to collect MAPI Logs. Location: V15\\Logging\\MAPI Client Access , V15\\Logging\\MapiHttp\\Mailbox , and V15\\Logging\\HttpProxy\\Mapi MessageTrackingLogs Enable to collect the Message Tracking Logs. Location: (Get-TransportService $server).MessageTrackingLogPath MitigationService Enable to collect the Mitigation Service logs. Location: V15\\Logging\\MitigationService OABLogs Enable to collect OAB Logs. Location: V15\\Logging\\HttpProxy\\OAB , V15\\Logging\\OABGeneratorLog , V15\\Logging\\OABGeneratorSimpleLog , and V15\\Logging\\MAPI AddressBook Service OrganizationConfig Enable to collect the Organization Configuration from the environment. OWALogs Enable to collect OWA Logs. Location: V15\\Logging\\OWA , Logging\\HttpProxy\\OwaCalendar , and V15\\Logging\\HttpProxy\\Owa PopLogs Enable to collect POP logging. Location: (Get-PopSettings -Server $server).LogFileLocation PowerShellLogs Enable to collect the PowerShell Logs. Location: V15\\Logging\\HttpProxy\\PowerShell QueueInformation Enable to collect the historical queue information. Location: (Get-TransportService $server).QueueLogPath ReceiveConnectors Enable to collect the Receive Connector information from the server. RPCLogs Enable to collect RPC Logs. Location: V15\\Logging\\RPC Client Access , V15\\Logging\\HttpProxy\\RpcHttp , and V15\\Logging\\RpcHttp SearchLogs Enable to collect Search Logs. Location: V15\\Bin\\Search\\Ceres\\Diagnostics\\Logs , V15\\Bin\\Search\\Ceres\\Diagnostics\\ETLTraces , V15\\Logging\\Search . On 2019 only we also include V15\\Logging\\BigFunnelMetricsCollectionAssistant , V15\\Logging\\BigFunnelQueryParityAssistant , and V15\\Logging\\BigFunnelRetryFeederTimeBasedAssistant SendConnectors Enable to collect the send connector information from the environment. ServerInformation Enable to collect general server information. TransportAgentLogs Enable to collect the Agnet Logs. Location: (Get-TransportService $server).AgentLogPath , (Get-FrontendTransportService $server).AgentLogPath , (Get-MailboxTransportService $server).MailboxSubmissionAgentLogPath , and (Get-MailboxTransportService $server).MailboxDeliveryAgentLogPath TransportConfig Enable to collect the Transport Configuration files from the Server and Get-TransportConfig from the org. Files: EdgeTransport.exe.config , MSExchangeFrontEndTransport.exe.config , MSExchangeDelivery.exe.config , and MSExchangeSubmission.exe.config TransportRoutingTableLogs Enable to collect the Routing Table Logs. Location: (Get-TransportService $server).RoutingTableLogPath , (Get-FrontendTransportService $server).RoutingTableLogPath , and (Get-MailboxTransportService $server).RoutingTableLogPath WindowsSecurityLogs Enable to collect the Windows Security Logs. Default Location: 'C:\\Windows\\System32\\Winevt\\Logs\\Security.evtx' AcceptEULA Enable to accept the conditions of the script and not get prompted. AllPossibleLogs Enables the collection of all default logging collection on the Server. CollectAllLogsBasedOnLogAge Boolean to determine if you collect all the logs based off the log's age or all the logs in that directory. Default value $true ConnectivityLogs Enables the following switches and their logs to be collected: FrontEndConnectivityLogs , HubConnectivityLogs , and MailboxConnectivityLogs DatabaseFailoverIssue Enables the following switches and their logs to be collected. DAGInformation , DailyPerformanceLogs , ExchangeServerInformation , Experfwiz , HighAvailabilityLogs , ManagedAvailabilityLogs , and ServerInformation . DaysWorth The number of days to go back to be included int the time span for log collection. Default value: 3 HoursWorth The number of hours to go back to be included in the time span for the log collection. Default Value 0. LogStartDate Set the starting time for the log collection (DateTime). LogEndDate Set the ending time for the log collection (DateTime). DisableConfigImport Enable to not import the ExchangeLogCollector.ps1.json file if it exists. ExmonLogmanName A list of names that we want to collect for Exmon data. The default name is Exmon_Trace . ExperfwizLogmanName A list of names that we want to collect performance data logs from. The default names are Exchange_Perfwiz , ExPerfwiz , and SimplePerf . (For both styles of Experfwiz) LogAge A Time Span value to use instead of the DaysWorth and HoursWorth parameters. Default Value: 3.00:00:00 OutlookConnectivityIssues Enables the following switches and their logs to be collected: AutoDLogs , DailyPerformanceLogs , EWSLogs , Experfwiz , IISLogs , MAPILogs , RPCLogs , and ServerInformation PerformanceIssues Enables the following switches and their logs to be collected: DailyPerformanceLogs , Experfwiz , and ManagedAvailabilityLogs PerformanceMailflowIssues Enables the following switches and their logs to be collected: DailyPerformanceLogs , Experfwiz , MessageTrackingLogs , QueueInformation , and TransportConfig ProtocolLogs Enables the following switches and their logs to be collected: FrontEndProtocolLogs , HubProtocolLogs , and MailboxProtocolLogs ScriptDebug Enable to display all the verbose lines in the script. SkipEndCopyOver If the Servers parameter is used, by default we will attempt to collect all the data back over to the local server after all the data was collected on each server.","title":"ExchangeLogCollector"},{"location":"Diagnostics/ExchangeLogCollector/#exchange-log-collector","text":"Download the latest release: ExchangeLogCollector.ps1 This script is intended to collect the Exchange default logging data from the server in a consistent manner to make it easier to troubleshoot an issue when large amounts of data is needed to be collected. You can specify what logs you want to collect by the switches that are available, then the script has logic built in to determine how to collect the data.","title":"Exchange Log Collector"},{"location":"Diagnostics/ExchangeLogCollector/#how-to-run","text":"The script must be run as Administrator in PowerShell session on an Exchange Server or Tools box. Supported to run and collected logs against Exchange 2013 and greater. The intent of the script is to collect logs only that you need from X servers quickly without needing to have to manually collect it yourself and label zip them all up for you. If you don't know what logs to collect, it is recommended to use -AllPossibleLogs . This script no longer supports collecting logs from Exchange 2010. However, the last release of v2 should still work just fine. You can download that here . The script is able to collect from the large set of servers while using the Invoke-Command. Prior to executing the main script, we check to make sure the server is up and that we are able to use Invoke-Command against the server. If Invoke-Command works remotely, then we will allow you to attempt to collect the data. You can still utilize the script to collect locally as it used to be able to, if the target OS doesn't allow this. Prior to collecting the data, we check to make sure that there is at least 10GB of free space at the location of where we are trying to save the data of the target server. The script will continue to keep track of all the logs and data that is being copied over and will stop if we have less than 10GB of free space. You are able to use a config file to load up all the parameters you wish to choose and the servers you wish to run the script against. Just create a file called ExchangeLogCollector.ps1.json and place at the same location as the script. Then provide the switches you would like to use in the file like so: { \"Servers\": [ \"ADT-E16A\", \"ADT-E16B\", \"ADT-E16C\" ], \"FilePath\": \"C:\\\\MS_Logs\", \"IISLogs\": true, \"AcceptEULA\": true, \"AppSysLogsToXml\": false, \"ScriptDebug\": true } NOTE: It is import that you use \\\\ for the file path otherwise the settings will fail to load.","title":"How to Run"},{"location":"Diagnostics/ExchangeLogCollector/#examples","text":"This cmdlet will collect all default logs of the local Exchange Server and store them in the default location of \"C:\\MS_Logs_Collection\" .\\ExchangeLogCollector.ps1 -AllPossibleLogs This cmdlet will collect all relevant data regarding database failovers from server EXCH1 and EXCH2 and store them at Z:\\Data\\Logs. Note: at the end of the collection, the script will copy over the data to the local host execution server to make data collection even easier. .\\ExchangeLogCollector.ps1 -DatabaseFailoverIssue -Servers EXCH1,EXCH2 -FilePath Z:\\Data\\Logs This cmdlet will collect all relevant data regarding IIS Logs (within the last 3 days by default) and all RPC type logs from the servers EXCH1 and EXCH2 and store them at the default location of \"C:\\MS_Logs_Collection\" .\\ExchangeLogCollector.ps1 -Servers EXCH1,EXCH2 -IISLogs -RPCLogs This cmdlet will collect all relevant data regarding Message Tracking Logs and Protocol Logs for the past 3 hours from the servers EXCH1 and EXCH2 and store them at the default location of \"C:\\MS_Logs_Collection\" .\\ExchangeLogCollector.ps1 -Servers EXCH1,EXCH2 -MessageTrackingLogs -ProtocolLogs -LogAge \"03:00:00\"","title":"Examples:"},{"location":"Diagnostics/ExchangeLogCollector/#parameters","text":"Parameter Description FilePath The Location of where you would like the data to be copied over to. This location must be the same and accessible on all servers if you use the Servers parameter. Default value: C:\\MS_Logs_Collection Servers An array of servers that you would like to collect data from. ADDriverLogs Enable to collect AD Driver Logs. Location: V15\\Logging\\ADDriver AppSysLogs Collects the Windows Event Application, System, and MSExchange Management Logs. Default value $true AppSysLogsToXml Collects the Windows Event Application and System and saves them out to XML. The time range only is from the time the script run and the value set on LogAge . Default value: $true AutoDLogs Enable to collect AutoDiscover Logs. Location: V15\\Logging\\Autodiscover and V15\\Logging\\HttpProxy\\Autodiscover CollectFailoverMetrics Enable to run the CollectOverMetrics.ps1 script against the DAG. Only able to be run on an Exchange tools box or an Exchange Server. DAGInformation Enable to collect the DAG Information from all different DAGs that are in the list of servers. DailyPerformanceLogs Enable to collect Daily Performance Logs. Default Location: V15\\Logging\\Diagnostics\\DailyPerformanceLogs DefaultTransportLogging Enables the following switches and their logs to be collected. FrontEndConnectivityLogs , FrontEndProtocolLogs , HubConnectivityLogs , MailboxConnectivityLogs , MailboxDeliveryThrottlingLogs , MessageTrackingLogs , QueueInformation , ReceiveConnectors , SendConnectors , and TransportConfig EASLogs Enable to collect Exchange Active Sync Logging. Location: V15\\Logging\\HttpProxy\\Eas ECPLogs Enable to collect ECP Logs. Location: V15\\Logging\\ECP and V15\\Logging\\HttpProxy\\Ecp EWSLogs Enable to collect EWS Logs. Location: V15\\Logging\\HttpProxy\\Ews and V15\\Logging\\Ews ExchangeServerInformation Enable to collect Exchange Information like Get-ExchangeServer, Get-MailboxServer, etc... This is also collected when -ServerInformation is also enabled. Exmon Enable to collect exmon data from the server. Experfwiz Enable to collect Experfwiz data if found. FrontEndConnectivityLogs Enable to collect the connectivity logging on the FE. Location: (Get-FrontendTransportService $server).ConnectivityLogPath FrontEndProtocolLogs Enable to collect the protocol logging on the FE. Location: (Get-FrontendTransportService $server).ReceiveProtocolLogPath and (Get-FrontendTransportService $server).SendProtocolLogPath GetVdirs Enable to collect the Virtual Directories of the environment. HighAvailabilityLogs Enable to collect High Availability Logs. Windows Event Logs like: Microsoft-Exchange-HighAvailability , Microsoft-Exchange-MailboxDatabaseFailureItems , and Microsoft-Windows-FailoverClustering HubConnectivityLogs Enable to collect the Hub connectivity logging. Location: (Get-TransportService $server).ConnectivityLogPath HubProtocolLogs Enable to collect the protocol logging. Location: (Get-TransportService $server).ReceiveProtocolLogPath and (Get-TransportService $server).SendProtocolLogPath IISLogs Enable to collect IIS Logs and HTTPErr Logs from the Exchange Server. Default Location: C:\\inetpub\\logs\\LogFiles\\W3SVC1 , C:\\inetpub\\logs\\LogFiles\\W3SVC2 , and C:\\Windows\\System32\\LogFiles\\HTTPERR . IISlogs do not collect all logs on CollectAllLogsBasedOnLogAge:$false, just works based on log age. ImapLogs Enable to collect IMAP logging. Location: (Get-ImapSettings -Server $server).LogFileLocation MailboxAssistantsLogs Enable to collect Mailbox Assistants logging. Location: V15\\Logging\\MailboxAssistantsLog , V15\\Logging\\MailboxAssistantsSlaReportLog , and V15\\Logging\\MailboxAssistantsDatabaseSlaLog MailboxConnectivityLogs Enable to collect the connectivity logging on the mailbox server. Location: (Get-MailboxTransportService $server).ConnectivityLogPath MailboxDeliveryThrottlingLogs Enable to collect the mailbox delivery throttling logs on the server. Location: (Get-MailboxTransportService $server).MailboxDeliveryThrottlingLogPath MailboxProtocolLogs Enable to collect protocol logging on the mailbox server. Location: (Get-MailboxTransportService $server).ReceiveProtocolLogPath and (Get-MailboxTransportService $server).SendProtocolLogPath ManagedAvailabilityLogs Enable to collect the Managed Availability Logs. Location: V15\\Logging\\Monitoring and Windows Event logs like Microsoft-Exchange-ManagedAvailability MapiLogs Enable to collect MAPI Logs. Location: V15\\Logging\\MAPI Client Access , V15\\Logging\\MapiHttp\\Mailbox , and V15\\Logging\\HttpProxy\\Mapi MessageTrackingLogs Enable to collect the Message Tracking Logs. Location: (Get-TransportService $server).MessageTrackingLogPath MitigationService Enable to collect the Mitigation Service logs. Location: V15\\Logging\\MitigationService OABLogs Enable to collect OAB Logs. Location: V15\\Logging\\HttpProxy\\OAB , V15\\Logging\\OABGeneratorLog , V15\\Logging\\OABGeneratorSimpleLog , and V15\\Logging\\MAPI AddressBook Service OrganizationConfig Enable to collect the Organization Configuration from the environment. OWALogs Enable to collect OWA Logs. Location: V15\\Logging\\OWA , Logging\\HttpProxy\\OwaCalendar , and V15\\Logging\\HttpProxy\\Owa PopLogs Enable to collect POP logging. Location: (Get-PopSettings -Server $server).LogFileLocation PowerShellLogs Enable to collect the PowerShell Logs. Location: V15\\Logging\\HttpProxy\\PowerShell QueueInformation Enable to collect the historical queue information. Location: (Get-TransportService $server).QueueLogPath ReceiveConnectors Enable to collect the Receive Connector information from the server. RPCLogs Enable to collect RPC Logs. Location: V15\\Logging\\RPC Client Access , V15\\Logging\\HttpProxy\\RpcHttp , and V15\\Logging\\RpcHttp SearchLogs Enable to collect Search Logs. Location: V15\\Bin\\Search\\Ceres\\Diagnostics\\Logs , V15\\Bin\\Search\\Ceres\\Diagnostics\\ETLTraces , V15\\Logging\\Search . On 2019 only we also include V15\\Logging\\BigFunnelMetricsCollectionAssistant , V15\\Logging\\BigFunnelQueryParityAssistant , and V15\\Logging\\BigFunnelRetryFeederTimeBasedAssistant SendConnectors Enable to collect the send connector information from the environment. ServerInformation Enable to collect general server information. TransportAgentLogs Enable to collect the Agnet Logs. Location: (Get-TransportService $server).AgentLogPath , (Get-FrontendTransportService $server).AgentLogPath , (Get-MailboxTransportService $server).MailboxSubmissionAgentLogPath , and (Get-MailboxTransportService $server).MailboxDeliveryAgentLogPath TransportConfig Enable to collect the Transport Configuration files from the Server and Get-TransportConfig from the org. Files: EdgeTransport.exe.config , MSExchangeFrontEndTransport.exe.config , MSExchangeDelivery.exe.config , and MSExchangeSubmission.exe.config TransportRoutingTableLogs Enable to collect the Routing Table Logs. Location: (Get-TransportService $server).RoutingTableLogPath , (Get-FrontendTransportService $server).RoutingTableLogPath , and (Get-MailboxTransportService $server).RoutingTableLogPath WindowsSecurityLogs Enable to collect the Windows Security Logs. Default Location: 'C:\\Windows\\System32\\Winevt\\Logs\\Security.evtx' AcceptEULA Enable to accept the conditions of the script and not get prompted. AllPossibleLogs Enables the collection of all default logging collection on the Server. CollectAllLogsBasedOnLogAge Boolean to determine if you collect all the logs based off the log's age or all the logs in that directory. Default value $true ConnectivityLogs Enables the following switches and their logs to be collected: FrontEndConnectivityLogs , HubConnectivityLogs , and MailboxConnectivityLogs DatabaseFailoverIssue Enables the following switches and their logs to be collected. DAGInformation , DailyPerformanceLogs , ExchangeServerInformation , Experfwiz , HighAvailabilityLogs , ManagedAvailabilityLogs , and ServerInformation . DaysWorth The number of days to go back to be included int the time span for log collection. Default value: 3 HoursWorth The number of hours to go back to be included in the time span for the log collection. Default Value 0. LogStartDate Set the starting time for the log collection (DateTime). LogEndDate Set the ending time for the log collection (DateTime). DisableConfigImport Enable to not import the ExchangeLogCollector.ps1.json file if it exists. ExmonLogmanName A list of names that we want to collect for Exmon data. The default name is Exmon_Trace . ExperfwizLogmanName A list of names that we want to collect performance data logs from. The default names are Exchange_Perfwiz , ExPerfwiz , and SimplePerf . (For both styles of Experfwiz) LogAge A Time Span value to use instead of the DaysWorth and HoursWorth parameters. Default Value: 3.00:00:00 OutlookConnectivityIssues Enables the following switches and their logs to be collected: AutoDLogs , DailyPerformanceLogs , EWSLogs , Experfwiz , IISLogs , MAPILogs , RPCLogs , and ServerInformation PerformanceIssues Enables the following switches and their logs to be collected: DailyPerformanceLogs , Experfwiz , and ManagedAvailabilityLogs PerformanceMailflowIssues Enables the following switches and their logs to be collected: DailyPerformanceLogs , Experfwiz , MessageTrackingLogs , QueueInformation , and TransportConfig ProtocolLogs Enables the following switches and their logs to be collected: FrontEndProtocolLogs , HubProtocolLogs , and MailboxProtocolLogs ScriptDebug Enable to display all the verbose lines in the script. SkipEndCopyOver If the Servers parameter is used, by default we will attempt to collect all the data back over to the local server after all the data was collected on each server.","title":"Parameters"},{"location":"Diagnostics/ManagedAvailabilityTroubleshooter/","text":"ManagedAvailabilityTroubleshooter Download the latest release: ManagedAvailabilityTroubleshooter.ps1","title":"ManagedAvailabilityTroubleshooter"},{"location":"Diagnostics/ManagedAvailabilityTroubleshooter/#managedavailabilitytroubleshooter","text":"Download the latest release: ManagedAvailabilityTroubleshooter.ps1","title":"ManagedAvailabilityTroubleshooter"},{"location":"Diagnostics/Test-ExchAVExclusions/","text":"Test-ExchAVExclusions Download the latest release: Test-ExchAVExclusions.ps1 Assists with testing Exchange Servers to determine if AV Exclusions have been properly set according to our documentation. AV Exclusions Exchange 2016/2019 AV Exclusions Exchange 2013 Usage Writes an EICAR test file to all paths specified in our AV Exclusions documentation and verifies all extensions in the documentation in a temporary folder. If the file is removed then the path is not properly excluded from AV Scanning. IF the file is not removed then it should be properly excluded. Once the files are created it will wait 5 minutes for AV to \"see\" and remove the file. ... .\\Test-ExchAVExclusions.ps1 ... Parameters Parameter Description Recurse Places an EICAR file in all subfolders as well as the root. OpenLog Opens the script log file. Outputs Log file: $env:LOCALAPPDATA\\ExchAvExclusions.log List of Folders and extensions Scanned by AV: $env:LOCALAPPDATA\\BadExclusions.txt","title":"Test-ExchAVExclusions"},{"location":"Diagnostics/Test-ExchAVExclusions/#test-exchavexclusions","text":"Download the latest release: Test-ExchAVExclusions.ps1 Assists with testing Exchange Servers to determine if AV Exclusions have been properly set according to our documentation. AV Exclusions Exchange 2016/2019 AV Exclusions Exchange 2013","title":"Test-ExchAVExclusions"},{"location":"Diagnostics/Test-ExchAVExclusions/#usage","text":"Writes an EICAR test file to all paths specified in our AV Exclusions documentation and verifies all extensions in the documentation in a temporary folder. If the file is removed then the path is not properly excluded from AV Scanning. IF the file is not removed then it should be properly excluded. Once the files are created it will wait 5 minutes for AV to \"see\" and remove the file. ... .\\Test-ExchAVExclusions.ps1 ...","title":"Usage"},{"location":"Diagnostics/Test-ExchAVExclusions/#parameters","text":"Parameter Description Recurse Places an EICAR file in all subfolders as well as the root. OpenLog Opens the script log file.","title":"Parameters"},{"location":"Diagnostics/Test-ExchAVExclusions/#outputs","text":"Log file: $env:LOCALAPPDATA\\ExchAvExclusions.log List of Folders and extensions Scanned by AV: $env:LOCALAPPDATA\\BadExclusions.txt","title":"Outputs"},{"location":"Diagnostics/HealthChecker/","text":"HealthChecker Download the latest release: HealthChecker.ps1 The Exchange Server Health Checker script helps detect common configuration issues that are known to cause performance issues and other long running issues that are caused by a simple configuration change within an Exchange Environment. It also helps collect useful information of your server to help speed up the process of common information gathering of your server. Requirements Supported Exchange Server Versions: The script can be used to validate the configuration of the following Exchange Server versions: - Exchange Server 2013 - Exchange Server 2016 - Exchange Server 2019 Required Permissions: Please make sure that the account used is a member of the Local Administrator group. This should be fulfilled on Exchange servers by being a member of the Organization Management group. However, if the group membership was adjusted or in case the script is executed on a non-Exchange system like a management server, you need to add your account to the Local Administrator group. You also need to be a member of the following groups: Organization Management Domain Admins (only necessary for the DCCoreRatio parameter) Syntax HealthChecker . ps1 [ -Server < string []>] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -Server < string []>] [ -MailboxReport ] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -LoadBalancingReport ] [ -ServerList < string []>] [ -SiteName < string >] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -BuildHtmlServersReport ] [ -XMLDirectoryPath < string >] [ -HtmlReportFile < string >] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -AnalyzeDataOnly ] [ -XMLDirectoryPath < string >] [ -HtmlReportFile < string >] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -DCCoreRatio ] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -ScriptUpdateOnly ] [ -OutputFilePath < string >] [ -SaveDebugLog ] HealthChecker . ps1 [ -VulnerabilityReport ] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] How To Run This script must be run as Administrator in Exchange Management Shell on an Exchange Server. You can provide no parameters and the script will just run against the local server and provide the detail output of the configuration of the server. Examples: This cmdlet with run Health Checker Script by default and run against the local server. PS C :\\> .\\ HealthChecker . ps1 This cmdlet will run the Health Checker Script against the specified server. PS C :\\> .\\ HealthChecker . ps1 -Server EXCH1 This cmdlet will run the Health Checker Script against a list of servers. PS C :\\> .\\ HealthChecker . ps1 -Server EXCH1 , EXCH2 , EXCH3 This cmdlet will build the HTML report for all the XML files located in the same location as the Health Checker Script. PS C :\\> .\\ HealthChecker . ps1 -BuildHtmlServersReport This cmdlet will build the HTML report for all the XML files located in the directory specified in the XMLDirectoryPath Parameter. PS C :\\> .\\ HealthChecker . ps1 -BuildHtmlServersReport -XMLDirectoryPath C :\\ Location This cmdlet will run the Health Checker Load Balancing Report for all the Exchange 2013+ CAS (Front End connections only) and MBX servers (BackEnd connections) in the Organization. PS C :\\> .\\ HealthChecker . ps1 -LoadBalancingReport This cmdlet will run the Health Checker Load Balancing Report for these Servers EXCH1, EXCH2, and EXCH3 CAS (Front End connections) and MBX (BackEnd Connections) PS C :\\> .\\ HealthChecker . ps1 -LoadBalancingReport -ServerList EXCH1 , EXCH2 , EXCH3 This cmdlet will run the Health Checker Load Balancing Report for the Exchange 2013+ servers in the site SiteA. PS C :\\> .\\ HealthChecker . ps1 -LoadBalancingReport -SiteName SiteA This cmdlet will run the Health Checker Mailbox Report against the Server EXCH1 PS C :\\> .\\ HealthChecker . ps1 -MailboxReport -Server EXCH1 This cmdlet will run the Health Checker against all your Exchange Servers, then run the HTML report and open it. PS C :\\> Get-ExchangeServer | ?{ $_ . AdminDisplayVersion -Match \"^Version 15\" } | .\\ HealthChecker . ps1 ; .\\ HealthChecker . ps1 -BuildHtmlServersReport ; .\\ ExchangeAllServersReport . html This cmdlet will run Health Checker Vulnerability Report feature against all your Exchange Servers. Then Export out the data to a json file. PS C :\\> .\\ HealthChecker . ps1 -VulnerabilityReport Parameters Parameter Description Server The server that you would like to run the Health Checker Script against. Parameter not valid with -BuildHTMLServersReport or LoadBalancingReport. Default is the localhost. OutputFilePath The output location for the log files that the script produces. Default is the current directory. MailboxReport Produces the Mailbox Report for the server provided. LoadBalancingReport Runs the Load Balancing Report for the Script ServerList Used in combination with the LoadBalancingReport switch for letting the script to know which servers to run against. SiteName Used in combination with the LoadBalancingReport switch for letting the script to know which servers to run against in the site. XMLDirectoryPath Used in combination with BuildHtmlServersReport switch for the location of the HealthChecker XML files for servers which you want to be included in the report. Default location is the current directory. BuildHtmlServersReport Switch to enable the script to build the HTML report for all the servers XML results in the XMLDirectoryPath location. HtmlReportFile Name of the HTML output file from the BuildHtmlServersReport. Default is ExchangeAllServersReport.html DCCoreRatio Gathers the Exchange to DC/GC Core ratio and displays the results in the current site that the script is running in. AnalyzeDataOnly Switch to analyze the existing HealthChecker XML files. The results are displayed on the screen and an HTML report is generated. VulnerabilityReport Switch to collect the Vulnerability Information for all the servers in the environment and export it out to json file. SkipVersionCheck No version check is performed when this switch is used. SaveDebugLog The debug log is kept even if the script is executed successfully. ScriptUpdateOnly Switch to check for the latest version of the script and perform an auto update if a newer version was found. Can be run on any machine with internet connectivity. No elevated permissions or EMS are required.","title":"HealthChecker"},{"location":"Diagnostics/HealthChecker/#healthchecker","text":"Download the latest release: HealthChecker.ps1 The Exchange Server Health Checker script helps detect common configuration issues that are known to cause performance issues and other long running issues that are caused by a simple configuration change within an Exchange Environment. It also helps collect useful information of your server to help speed up the process of common information gathering of your server.","title":"HealthChecker"},{"location":"Diagnostics/HealthChecker/#requirements","text":"","title":"Requirements"},{"location":"Diagnostics/HealthChecker/#supported-exchange-server-versions","text":"The script can be used to validate the configuration of the following Exchange Server versions: - Exchange Server 2013 - Exchange Server 2016 - Exchange Server 2019","title":"Supported Exchange Server Versions:"},{"location":"Diagnostics/HealthChecker/#required-permissions","text":"Please make sure that the account used is a member of the Local Administrator group. This should be fulfilled on Exchange servers by being a member of the Organization Management group. However, if the group membership was adjusted or in case the script is executed on a non-Exchange system like a management server, you need to add your account to the Local Administrator group. You also need to be a member of the following groups: Organization Management Domain Admins (only necessary for the DCCoreRatio parameter)","title":"Required Permissions:"},{"location":"Diagnostics/HealthChecker/#syntax","text":"HealthChecker . ps1 [ -Server < string []>] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -Server < string []>] [ -MailboxReport ] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -LoadBalancingReport ] [ -ServerList < string []>] [ -SiteName < string >] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -BuildHtmlServersReport ] [ -XMLDirectoryPath < string >] [ -HtmlReportFile < string >] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -AnalyzeDataOnly ] [ -XMLDirectoryPath < string >] [ -HtmlReportFile < string >] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -DCCoreRatio ] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ] HealthChecker . ps1 [ -ScriptUpdateOnly ] [ -OutputFilePath < string >] [ -SaveDebugLog ] HealthChecker . ps1 [ -VulnerabilityReport ] [ -OutputFilePath < string >] [ -SkipVersionCheck ] [ -SaveDebugLog ]","title":"Syntax"},{"location":"Diagnostics/HealthChecker/#how-to-run","text":"This script must be run as Administrator in Exchange Management Shell on an Exchange Server. You can provide no parameters and the script will just run against the local server and provide the detail output of the configuration of the server.","title":"How To Run"},{"location":"Diagnostics/HealthChecker/#examples","text":"This cmdlet with run Health Checker Script by default and run against the local server. PS C :\\> .\\ HealthChecker . ps1 This cmdlet will run the Health Checker Script against the specified server. PS C :\\> .\\ HealthChecker . ps1 -Server EXCH1 This cmdlet will run the Health Checker Script against a list of servers. PS C :\\> .\\ HealthChecker . ps1 -Server EXCH1 , EXCH2 , EXCH3 This cmdlet will build the HTML report for all the XML files located in the same location as the Health Checker Script. PS C :\\> .\\ HealthChecker . ps1 -BuildHtmlServersReport This cmdlet will build the HTML report for all the XML files located in the directory specified in the XMLDirectoryPath Parameter. PS C :\\> .\\ HealthChecker . ps1 -BuildHtmlServersReport -XMLDirectoryPath C :\\ Location This cmdlet will run the Health Checker Load Balancing Report for all the Exchange 2013+ CAS (Front End connections only) and MBX servers (BackEnd connections) in the Organization. PS C :\\> .\\ HealthChecker . ps1 -LoadBalancingReport This cmdlet will run the Health Checker Load Balancing Report for these Servers EXCH1, EXCH2, and EXCH3 CAS (Front End connections) and MBX (BackEnd Connections) PS C :\\> .\\ HealthChecker . ps1 -LoadBalancingReport -ServerList EXCH1 , EXCH2 , EXCH3 This cmdlet will run the Health Checker Load Balancing Report for the Exchange 2013+ servers in the site SiteA. PS C :\\> .\\ HealthChecker . ps1 -LoadBalancingReport -SiteName SiteA This cmdlet will run the Health Checker Mailbox Report against the Server EXCH1 PS C :\\> .\\ HealthChecker . ps1 -MailboxReport -Server EXCH1 This cmdlet will run the Health Checker against all your Exchange Servers, then run the HTML report and open it. PS C :\\> Get-ExchangeServer | ?{ $_ . AdminDisplayVersion -Match \"^Version 15\" } | .\\ HealthChecker . ps1 ; .\\ HealthChecker . ps1 -BuildHtmlServersReport ; .\\ ExchangeAllServersReport . html This cmdlet will run Health Checker Vulnerability Report feature against all your Exchange Servers. Then Export out the data to a json file. PS C :\\> .\\ HealthChecker . ps1 -VulnerabilityReport","title":"Examples:"},{"location":"Diagnostics/HealthChecker/#parameters","text":"Parameter Description Server The server that you would like to run the Health Checker Script against. Parameter not valid with -BuildHTMLServersReport or LoadBalancingReport. Default is the localhost. OutputFilePath The output location for the log files that the script produces. Default is the current directory. MailboxReport Produces the Mailbox Report for the server provided. LoadBalancingReport Runs the Load Balancing Report for the Script ServerList Used in combination with the LoadBalancingReport switch for letting the script to know which servers to run against. SiteName Used in combination with the LoadBalancingReport switch for letting the script to know which servers to run against in the site. XMLDirectoryPath Used in combination with BuildHtmlServersReport switch for the location of the HealthChecker XML files for servers which you want to be included in the report. Default location is the current directory. BuildHtmlServersReport Switch to enable the script to build the HTML report for all the servers XML results in the XMLDirectoryPath location. HtmlReportFile Name of the HTML output file from the BuildHtmlServersReport. Default is ExchangeAllServersReport.html DCCoreRatio Gathers the Exchange to DC/GC Core ratio and displays the results in the current site that the script is running in. AnalyzeDataOnly Switch to analyze the existing HealthChecker XML files. The results are displayed on the screen and an HTML report is generated. VulnerabilityReport Switch to collect the Vulnerability Information for all the servers in the environment and export it out to json file. SkipVersionCheck No version check is performed when this switch is used. SaveDebugLog The debug log is kept even if the script is executed successfully. ScriptUpdateOnly Switch to check for the latest version of the script and perform an auto update if a newer version was found. Can be run on any machine with internet connectivity. No elevated permissions or EMS are required.","title":"Parameters"},{"location":"Diagnostics/HealthChecker/ADSiteCount/","text":"AD Site Count Check In large environments that contains a lot of sites, can cause a performance issue with Exchange. In particular Autodiscover app pool will peg the CPU at 4-hour intervals when there are many AD sites. It is recommended to reduce the number of AD Sites within the environment to address this issue. However, there is a workaround that would prevent the issue from occurring every 4-hours and just every 24-hours. In the %ExchangeInstallPath%\\Bin\\Microsoft.Exchange.Directory.TopologyService.exe.config file, change the ExchangeTopologyCacheLifetime value to be 1.00:00:00,00:20:00 instead to have the cache lifetime increase from 4-hours to 24-hours. It is not recommended to go beyond 24-hours. Included in HTML Report? Yes Additional resources: Original Issue","title":"ADSiteCount"},{"location":"Diagnostics/HealthChecker/ADSiteCount/#ad-site-count-check","text":"In large environments that contains a lot of sites, can cause a performance issue with Exchange. In particular Autodiscover app pool will peg the CPU at 4-hour intervals when there are many AD sites. It is recommended to reduce the number of AD Sites within the environment to address this issue. However, there is a workaround that would prevent the issue from occurring every 4-hours and just every 24-hours. In the %ExchangeInstallPath%\\Bin\\Microsoft.Exchange.Directory.TopologyService.exe.config file, change the ExchangeTopologyCacheLifetime value to be 1.00:00:00,00:20:00 instead to have the cache lifetime increase from 4-hours to 24-hours. It is not recommended to go beyond 24-hours. Included in HTML Report? Yes Additional resources: Original Issue","title":"AD Site Count Check"},{"location":"Diagnostics/HealthChecker/AMSIIntegration/","text":"AMSI Check The Windows Antimalware Scan Interface (AMSI) is a versatile standard that allows applications and services to integrate with any antimalware product present on a machine. AMSI is vendor agnostic and designed to allow for the most common malware scanning and protection techniques provided by today's products to be integrated into applications. It only scans the HTTP protocol, and is not meant to be a replacement to existing server-level or message hygiene protections. AMSI integration is available on the following Operating System / Exchange Server version combinations: - Windows Server 2016, or higher - Exchange Server 2016 CU21, or higher - Exchange Server 2019 CU10, or higher - AMSI is not available on Edge Transport Servers If you use Microsoft Defender, AV engine version at or higher than 1.1.18300.4 is also required. Alternatively, a compatible AMSI capable third-party AV provider. This check verifies if an override exists which disables the AMSI integration with Exchange Server. It does that, by running the following query: Get-SettingOverride | Where-Object { ($_.ComponentName -eq \"Cafe\") -and ($_.SectionName -eq \"HttpRequestFiltering\") } Included in HTML Report? Yes Additional resources: Released: June 2021 Quarterly Exchange Updates More about AMSI integration with Exchange Server","title":"AMSICheck"},{"location":"Diagnostics/HealthChecker/AMSIIntegration/#amsi-check","text":"The Windows Antimalware Scan Interface (AMSI) is a versatile standard that allows applications and services to integrate with any antimalware product present on a machine. AMSI is vendor agnostic and designed to allow for the most common malware scanning and protection techniques provided by today's products to be integrated into applications. It only scans the HTTP protocol, and is not meant to be a replacement to existing server-level or message hygiene protections. AMSI integration is available on the following Operating System / Exchange Server version combinations: - Windows Server 2016, or higher - Exchange Server 2016 CU21, or higher - Exchange Server 2019 CU10, or higher - AMSI is not available on Edge Transport Servers If you use Microsoft Defender, AV engine version at or higher than 1.1.18300.4 is also required. Alternatively, a compatible AMSI capable third-party AV provider. This check verifies if an override exists which disables the AMSI integration with Exchange Server. It does that, by running the following query: Get-SettingOverride | Where-Object { ($_.ComponentName -eq \"Cafe\") -and ($_.SectionName -eq \"HttpRequestFiltering\") } Included in HTML Report? Yes Additional resources: Released: June 2021 Quarterly Exchange Updates More about AMSI integration with Exchange Server","title":"AMSI Check"},{"location":"Diagnostics/HealthChecker/CTSProcessorAffinityPercentageCheck/","text":"CTS Processor Affinity Percentage Check Description: We check if the CtsProcessorAffinityPercentage DWORD value unter HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\ExchangeServer\\V15\\Search\\SystemParameters exists and is set to any other value than 0 . This setting can be used to limit CPU utilization of a process. This can cause an impact to the server's search performance. This should never be used as a long term solution! Included in HTML Report? Yes","title":"CTSProcessorAffinityCheck"},{"location":"Diagnostics/HealthChecker/CTSProcessorAffinityPercentageCheck/#cts-processor-affinity-percentage-check","text":"Description: We check if the CtsProcessorAffinityPercentage DWORD value unter HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\ExchangeServer\\V15\\Search\\SystemParameters exists and is set to any other value than 0 . This setting can be used to limit CPU utilization of a process. This can cause an impact to the server's search performance. This should never be used as a long term solution! Included in HTML Report? Yes","title":"CTS Processor Affinity Percentage Check"},{"location":"Diagnostics/HealthChecker/CertificateCheck/","text":"Certificate Check This check retrieves all certificates from the Exchange server by using the Get-ExchangeCertificate cmdlet. We display the following information: FriendlyName Thumbprint Lifetime in days Key size Signature algorithm Signature hash algorithm Bound to services Current Auth Certificate SAN Certificate Namespaces We also perform the following checks: Certificate lifetime check: We show a green output, if the certificate is valid for 60 or more days. We show a yellow warning, if the certificate lifetime is between 30 and 59 days. We show a red warning if the lifetime is < 30 days. Weak key size check: We show a red warning, if the key size is lower than 2048 bit. Weak hash algorithm check: We show a yellow warning if the hash algorithm used to sign a certificate is weak. Valid Auth certificate check: We check if the certificate which is set as current Auth certificate is available on the server. Included in HTML Report? Yes","title":"CertificateCheck"},{"location":"Diagnostics/HealthChecker/CertificateCheck/#certificate-check","text":"This check retrieves all certificates from the Exchange server by using the Get-ExchangeCertificate cmdlet. We display the following information: FriendlyName Thumbprint Lifetime in days Key size Signature algorithm Signature hash algorithm Bound to services Current Auth Certificate SAN Certificate Namespaces We also perform the following checks: Certificate lifetime check: We show a green output, if the certificate is valid for 60 or more days. We show a yellow warning, if the certificate lifetime is between 30 and 59 days. We show a red warning if the lifetime is < 30 days. Weak key size check: We show a red warning, if the key size is lower than 2048 bit. Weak hash algorithm check: We show a yellow warning if the hash algorithm used to sign a certificate is weak. Valid Auth certificate check: We check if the certificate which is set as current Auth certificate is available on the server. Included in HTML Report? Yes","title":"Certificate Check"},{"location":"Diagnostics/HealthChecker/CloudConnectorCheck/","text":"Cloud Connector Check This check performs testings against the Exchange Send- and Receive Connectors which are enabled for cloud usage if a hybrid configuration was detected. We run Get-HybridConfiguration to validate if hybrid has been configured for the environment. A proper configured Send- and Receive Connector is important - especially in hybrid scenarios. A misconfigured connector can lead to multiple issues including broken tenant attribution and email classification (internal / anonymous) which can then lead to false-positive/false-negative. We to make sure that the mail flow between Exchange on-premises and Exchange Online works as expected If a Send Connector has the following setting set, it means that the connector is eligable for cloud mail usage: CloudServicesMailEnabled If a Receive Connector has the following setting set, it means that the connector is eligable for cloud mail usage: TlsDomainCapabilities We only perform testings for the Receive Connectors if: TransportRole is set to FrontendTransport We run the following checks: Connector enabled check: We show a yellow warning, if the connector is not enabled Send Connector configured to relay emails via M365 check: If TlsAuthLevel is set to CertificateValidation If RequireTLS is set to true If TlsDomain is set (only performed if TlsAuthLevel is set to DomainValidation ) TlsCertificateName configuration check: We check if TlsCertificateName has been set We check if the certificate which is configured in TlsCertificateName exists on the server If a certificate was configured and detected on the system, we then check if it expires within the next 60 days If a certificate was configured, we compare it with the TlsCertificateName returned by Get-HybridConfiguration If a certificate was configured, we check if the syntax is correct and not corrupt. Expected syntax: <I>X.500Issuer<S>X.500Subject Included in HTML Report? Yes Additional resources: Certificate requirements for hybrid deployments Demystifying and troubleshooting hybrid mail flow: when is a message internal? Set up your email server to relay mail to the internet via Microsoft 365 or Office 365","title":"CloudConnectorCheck"},{"location":"Diagnostics/HealthChecker/CloudConnectorCheck/#cloud-connector-check","text":"This check performs testings against the Exchange Send- and Receive Connectors which are enabled for cloud usage if a hybrid configuration was detected. We run Get-HybridConfiguration to validate if hybrid has been configured for the environment. A proper configured Send- and Receive Connector is important - especially in hybrid scenarios. A misconfigured connector can lead to multiple issues including broken tenant attribution and email classification (internal / anonymous) which can then lead to false-positive/false-negative. We to make sure that the mail flow between Exchange on-premises and Exchange Online works as expected If a Send Connector has the following setting set, it means that the connector is eligable for cloud mail usage: CloudServicesMailEnabled If a Receive Connector has the following setting set, it means that the connector is eligable for cloud mail usage: TlsDomainCapabilities We only perform testings for the Receive Connectors if: TransportRole is set to FrontendTransport We run the following checks: Connector enabled check: We show a yellow warning, if the connector is not enabled Send Connector configured to relay emails via M365 check: If TlsAuthLevel is set to CertificateValidation If RequireTLS is set to true If TlsDomain is set (only performed if TlsAuthLevel is set to DomainValidation ) TlsCertificateName configuration check: We check if TlsCertificateName has been set We check if the certificate which is configured in TlsCertificateName exists on the server If a certificate was configured and detected on the system, we then check if it expires within the next 60 days If a certificate was configured, we compare it with the TlsCertificateName returned by Get-HybridConfiguration If a certificate was configured, we check if the syntax is correct and not corrupt. Expected syntax: <I>X.500Issuer<S>X.500Subject Included in HTML Report? Yes Additional resources: Certificate requirements for hybrid deployments Demystifying and troubleshooting hybrid mail flow: when is a message internal? Set up your email server to relay mail to the internet via Microsoft 365 or Office 365","title":"Cloud Connector Check"},{"location":"Diagnostics/HealthChecker/CredentialGuardCheck/","text":"Credential Guard Check Description: In this check we validate, weather Credential Guard was activated or not. Credential Guard is not supported on an Exchange Server. This can cause a performance hit on the server. Included in HTML Report? Yes Additional resources: Manage Windows Defender Credential Guard","title":"CredentialGuardCheck"},{"location":"Diagnostics/HealthChecker/CredentialGuardCheck/#credential-guard-check","text":"Description: In this check we validate, weather Credential Guard was activated or not. Credential Guard is not supported on an Exchange Server. This can cause a performance hit on the server. Included in HTML Report? Yes Additional resources: Manage Windows Defender Credential Guard","title":"Credential Guard Check"},{"location":"Diagnostics/HealthChecker/DownloadDomainCheck/","text":"Download Domain Check Description: In this check we validate if the Download Domain feature was configured or not. This feature was introduced to address CVE-2021-1730 . If the feature is enabled, we validate if the URL configured to download attachments, is not set to the same as the internal or external Outlook Web App (OWA) url. CVE-2021-1730 will not be addressed if the url configured to be used by the Download Domain feature points to the same url(s) which is/are used by OWA. The Download Domain feature is available on Microsoft Exchange Server 2016 and Microsoft Exchange Server 2019. Included in HTML Report? Yes Additional resources: How to configure the Download Domain feature (see FAQ section)","title":"DownloadDomainCheck"},{"location":"Diagnostics/HealthChecker/DownloadDomainCheck/#download-domain-check","text":"Description: In this check we validate if the Download Domain feature was configured or not. This feature was introduced to address CVE-2021-1730 . If the feature is enabled, we validate if the URL configured to download attachments, is not set to the same as the internal or external Outlook Web App (OWA) url. CVE-2021-1730 will not be addressed if the url configured to be used by the Download Domain feature points to the same url(s) which is/are used by OWA. The Download Domain feature is available on Microsoft Exchange Server 2016 and Microsoft Exchange Server 2019. Included in HTML Report? Yes Additional resources: How to configure the Download Domain feature (see FAQ section)","title":"Download Domain Check"},{"location":"Diagnostics/HealthChecker/EEMSCheck/","text":"Exchange Emergency Mitigation Service Check Description: The Exchange Emergency Mitigation Server also known as EEMS or EM was introduced with the Exchange Server 2019 Cumulative Update 11 and Exchange Server 2016 Cumulative Update 22 . The Exchange Emergency Mitigation service helps to keep your Exchange Servers secure by applying mitigations to address any potential threats against your servers. It uses the cloud-based Office Config Service (OCS) to check for and download available mitigations and to send diagnostic data to Microsoft. The EM service runs as a Windows service on an Exchange Mailbox server. The EM service will be installed automatically on servers with the Mailbox role. The EM service will not be installed on Edge Transport servers. The use of the EM service is optional. If you do not want Microsoft to automatically apply mitigations to your Exchange servers, you can disable the feature. This check performs the following testings to highlight the configuration state of the EEMS: Configuration Check Shows if the EEMS is enabled or not on Organizational level Shows if the EEMS is enabled or not on Server level Windows Service Check MSExchangeMitigation Windows service startup type should be: Automatic MSExchangeMitigation Windows service status should be: Running Pattern Service Check We validate if we can reach the OCS which is used to serve the latest mitigations OCS Mitigation Service url: https://officeclient.microsoft.com/getexchangemitigations Mitigations Check Shows which mitigations are currently being applied Shows which mitigations are currently being blocked Diagnostic Data Check Shows if the service is configured to provide diagnostic data to Microsoft or not Included in HTML Report? Yes Additional resources: New security feature in September 2021 Cumulative Update for Exchange Server Released: September 2021 Quarterly Exchange Updates Addressing Your Feedback on the Exchange Emergency Mitigation Service Exchange Emergency Mitigation (EM) service Mitigations Cloud endpoint is not reachable","title":"EEMSCheck"},{"location":"Diagnostics/HealthChecker/EEMSCheck/#exchange-emergency-mitigation-service-check","text":"Description: The Exchange Emergency Mitigation Server also known as EEMS or EM was introduced with the Exchange Server 2019 Cumulative Update 11 and Exchange Server 2016 Cumulative Update 22 . The Exchange Emergency Mitigation service helps to keep your Exchange Servers secure by applying mitigations to address any potential threats against your servers. It uses the cloud-based Office Config Service (OCS) to check for and download available mitigations and to send diagnostic data to Microsoft. The EM service runs as a Windows service on an Exchange Mailbox server. The EM service will be installed automatically on servers with the Mailbox role. The EM service will not be installed on Edge Transport servers. The use of the EM service is optional. If you do not want Microsoft to automatically apply mitigations to your Exchange servers, you can disable the feature. This check performs the following testings to highlight the configuration state of the EEMS: Configuration Check Shows if the EEMS is enabled or not on Organizational level Shows if the EEMS is enabled or not on Server level Windows Service Check MSExchangeMitigation Windows service startup type should be: Automatic MSExchangeMitigation Windows service status should be: Running Pattern Service Check We validate if we can reach the OCS which is used to serve the latest mitigations OCS Mitigation Service url: https://officeclient.microsoft.com/getexchangemitigations Mitigations Check Shows which mitigations are currently being applied Shows which mitigations are currently being blocked Diagnostic Data Check Shows if the service is configured to provide diagnostic data to Microsoft or not Included in HTML Report? Yes Additional resources: New security feature in September 2021 Cumulative Update for Exchange Server Released: September 2021 Quarterly Exchange Updates Addressing Your Feedback on the Exchange Emergency Mitigation Service Exchange Emergency Mitigation (EM) service Mitigations Cloud endpoint is not reachable","title":"Exchange Emergency Mitigation Service Check"},{"location":"Diagnostics/HealthChecker/ExchangeServerMaintenanceCheck/","text":"Exchange Server Maintenance Check Description: We validate the Maintenance State for the Exchange server. We run the following checks: We query the server component state by running Get-ServerComponentState We query cluster node information by running Get-ClusterNode We then check for each component if Component.State is not Active If this is the case, we query the Component.LocalStates and Component.RemoteStates We validate if both states LocalStates & RemoteStates are the same We add the information, if LocalStates & RemoteStates are different We show a green information Server is not in Maintenance Mode if the server is not in maintenance mode. We display a yellow warning Exchange Server Maintenance if components in maintenance state are detected. We also show additional information about the Database Copy Maintenance and Cluster Node state. Included in HTML Report? Yes Additional resources: Determine the requestor that changed Server component state","title":"MaintenanceCheck"},{"location":"Diagnostics/HealthChecker/ExchangeServerMaintenanceCheck/#exchange-server-maintenance-check","text":"Description: We validate the Maintenance State for the Exchange server. We run the following checks: We query the server component state by running Get-ServerComponentState We query cluster node information by running Get-ClusterNode We then check for each component if Component.State is not Active If this is the case, we query the Component.LocalStates and Component.RemoteStates We validate if both states LocalStates & RemoteStates are the same We add the information, if LocalStates & RemoteStates are different We show a green information Server is not in Maintenance Mode if the server is not in maintenance mode. We display a yellow warning Exchange Server Maintenance if components in maintenance state are detected. We also show additional information about the Database Copy Maintenance and Cluster Node state. Included in HTML Report? Yes Additional resources: Determine the requestor that changed Server component state","title":"Exchange Server Maintenance Check"},{"location":"Diagnostics/HealthChecker/FIPFSCheck/","text":"FIP-FS Check Description: We have addressed the issue causing messages to be stuck in transport queues of on-premises Exchange Server 2016 and Exchange Server 2019 . The problem relates to a date check failure with the change of the new year and it not a failure of the AV engine itself. This is not an issue with malware scanning or the malware engine, and it is not a security-related issue. The version checking performed against the signature file is causing the malware engine to crash, resulting in messages being stuck in transport queues. This check validates if the problematic signature file has already downloaded and processed. It shows a red warning indicating that the FIP-FS scan engine should be reset to avoid running into the transport or pattern update issue. Exchange 2013 is not affected by the transport queue issue, however, if invalid patterns has been applied, no newer update pattern with a lower version number (like 2112330001 ) will be applied. We check if a folder with number 2201010000 or greater exists under ExchangeInstallPath\\FIP-FS\\Data\\Engines\\amd64\\Microsoft\\Bin . We also check if the server runs a fixed Exchange build (March 2022 Security Update or higher) that does not crash when the problematic version is used. If we detect the problematic version folder and the server doesn't run a fixed build, we recommend to reset the scan engine version (see Email Stuck in Exchange On-premises Transport Queues in the \"Additional resources\" section). If we detect the problematic version folder but the server runs a fixed build, it should be safe to delete the folder without performing a scan engine reset. If the directory cannot be deleted, it means that the problematic version is in use. This is a problem because in this case, no new scan engine version will be applied. In this case, a reset of the scan engine must be performed. Please follow the instructions in the references below to reset the scan engine. Included in HTML Report? Yes Additional resources: Email Stuck in Exchange On-premises Transport Queues","title":"FIPFSCheck"},{"location":"Diagnostics/HealthChecker/FIPFSCheck/#fip-fs-check","text":"Description: We have addressed the issue causing messages to be stuck in transport queues of on-premises Exchange Server 2016 and Exchange Server 2019 . The problem relates to a date check failure with the change of the new year and it not a failure of the AV engine itself. This is not an issue with malware scanning or the malware engine, and it is not a security-related issue. The version checking performed against the signature file is causing the malware engine to crash, resulting in messages being stuck in transport queues. This check validates if the problematic signature file has already downloaded and processed. It shows a red warning indicating that the FIP-FS scan engine should be reset to avoid running into the transport or pattern update issue. Exchange 2013 is not affected by the transport queue issue, however, if invalid patterns has been applied, no newer update pattern with a lower version number (like 2112330001 ) will be applied. We check if a folder with number 2201010000 or greater exists under ExchangeInstallPath\\FIP-FS\\Data\\Engines\\amd64\\Microsoft\\Bin . We also check if the server runs a fixed Exchange build (March 2022 Security Update or higher) that does not crash when the problematic version is used. If we detect the problematic version folder and the server doesn't run a fixed build, we recommend to reset the scan engine version (see Email Stuck in Exchange On-premises Transport Queues in the \"Additional resources\" section). If we detect the problematic version folder but the server runs a fixed build, it should be safe to delete the folder without performing a scan engine reset. If the directory cannot be deleted, it means that the problematic version is in use. This is a problem because in this case, no new scan engine version will be applied. In this case, a reset of the scan engine must be performed. Please follow the instructions in the references below to reset the scan engine. Included in HTML Report? Yes Additional resources: Email Stuck in Exchange On-premises Transport Queues","title":"FIP-FS Check"},{"location":"Diagnostics/HealthChecker/GeneralHardwareInformation/","text":"General Hardware Information Description: We show some general information about the Processor/Hardware of the Exchange server against which the script was executed. Hardware Type: VMWare AmazonEC2 HyperV Physical Unknown We additionally show the following information, if HardwareType is Physical or AmazonEC2 : - Manufacturer - Model - Processor Number of Processors: We show an note if ServerType is VMWare [1] We show an error if we have more than 2 Processors installed Number of Physical/Logical Cores: We show a warning if we have more than 24 Physical Cores and running Exchange 2013/2016 [2] We show a warning if we have more than 48 Physical Cores and running Exchange 2019 [2] Hyper-Threading: We show if Hyper-Threading is enabled or not. NUMA BIOS Check: We check to see if we can properly see all cores on the server. [3], [4] Max Processor Speed: We return the MaxMegacyclesPerCore . This is the max speed that we can get out of the cores. We also check if the processor is throttled which may be a result of a misconfigured Power Plan. Physical Memory: We validate if the amount of installed memory meets our specifications. [5] Included in HTML Report? Yes Additional resources: 1 - Does corespersocket Affect Performance? 2 - Commodity servers 3 - CUSTOMER ADVISORY c04650594 4 - Exchange performance:HP NUMA BIOS settings 5 - Exchange 2013 Sizing 5 - Hardware requirements for Exchange 2016 5 - Hardware requirements for Exchange 2019","title":"GeneralHardwareInformation"},{"location":"Diagnostics/HealthChecker/GeneralHardwareInformation/#general-hardware-information","text":"Description: We show some general information about the Processor/Hardware of the Exchange server against which the script was executed. Hardware Type: VMWare AmazonEC2 HyperV Physical Unknown We additionally show the following information, if HardwareType is Physical or AmazonEC2 : - Manufacturer - Model - Processor Number of Processors: We show an note if ServerType is VMWare [1] We show an error if we have more than 2 Processors installed Number of Physical/Logical Cores: We show a warning if we have more than 24 Physical Cores and running Exchange 2013/2016 [2] We show a warning if we have more than 48 Physical Cores and running Exchange 2019 [2] Hyper-Threading: We show if Hyper-Threading is enabled or not. NUMA BIOS Check: We check to see if we can properly see all cores on the server. [3], [4] Max Processor Speed: We return the MaxMegacyclesPerCore . This is the max speed that we can get out of the cores. We also check if the processor is throttled which may be a result of a misconfigured Power Plan. Physical Memory: We validate if the amount of installed memory meets our specifications. [5] Included in HTML Report? Yes Additional resources: 1 - Does corespersocket Affect Performance? 2 - Commodity servers 3 - CUSTOMER ADVISORY c04650594 4 - Exchange performance:HP NUMA BIOS settings 5 - Exchange 2013 Sizing 5 - Hardware requirements for Exchange 2016 5 - Hardware requirements for Exchange 2019","title":"General Hardware Information"},{"location":"Diagnostics/HealthChecker/HyperThreadingCheck/","text":"Hyper-Threading Check Description: We validate if Hyper-Threading is enabled or not. We do this by checking if LogicalCores is greater than PhysicalCores which means that Hyper-Threading is enabled. We show a red error and recommend turning off Hyper-Threading. Included in HTML Report? Yes Additional resources: Exchange 2013 Sizing and Configuration Recommendations - Processing","title":"HyperThreadingCheck"},{"location":"Diagnostics/HealthChecker/HyperThreadingCheck/#hyper-threading-check","text":"Description: We validate if Hyper-Threading is enabled or not. We do this by checking if LogicalCores is greater than PhysicalCores which means that Hyper-Threading is enabled. We show a red error and recommend turning off Hyper-Threading. Included in HTML Report? Yes Additional resources: Exchange 2013 Sizing and Configuration Recommendations - Processing","title":"Hyper-Threading Check"},{"location":"Diagnostics/HealthChecker/IISWebConfigCheck/","text":"IIS Web Configuration Check Description: After a CU or an SU install, sometimes there can be issues with the web.config or the SharedWebConfig.config file that causes issues with the virtual directories from working properly. Most of these issues are from SU installs where they are installed from double clicking on the msi file. This prevents the process from starting as administrator and can cause multiple issues. This check detects to make sure all the default web.config and SharedWebConfig.config files exist and if they have any default variable values still set within it - %ExchangeInstallDir% . If Default Variable Detected file is found, open up that file and replace the %ExchangeInstallDir% with the Exchange Install path from (Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\ExchangeServer\\v15\\Setup).MsiInstallPath Included in HTML Report? Yes, if issue detected","title":"IISWebConfigCheck"},{"location":"Diagnostics/HealthChecker/IISWebConfigCheck/#iis-web-configuration-check","text":"Description: After a CU or an SU install, sometimes there can be issues with the web.config or the SharedWebConfig.config file that causes issues with the virtual directories from working properly. Most of these issues are from SU installs where they are installed from double clicking on the msi file. This prevents the process from starting as administrator and can cause multiple issues. This check detects to make sure all the default web.config and SharedWebConfig.config files exist and if they have any default variable values still set within it - %ExchangeInstallDir% . If Default Variable Detected file is found, open up that file and replace the %ExchangeInstallDir% with the Exchange Install path from (Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\ExchangeServer\\v15\\Setup).MsiInstallPath Included in HTML Report? Yes, if issue detected","title":"IIS Web Configuration Check"},{"location":"Diagnostics/HealthChecker/IPv6EnabledCheck/","text":"IPv6 Enabled Check Description: We check if IPv6 is enabled or not. If we determine that IPv6 has been disabled, we check to see if it's fully disabled as recommended. We determine if the IPv6 is fully disabled by checking to see if we have an IPv6 Address available on the NIC and that it matches what is found in the registry at SYSTEM\\CurrentControlSet\\Services\\Tcpip6\\Parameters\\DisabledComponents . If both places don't have IPv6 enabled/disabled properly a warning is thrown. This can cause communication issues if not properly disabled. Included in HTML Report? Yes Additional resources: Disabling IPv6 And Exchange \u2013 Going All The Way Guidance for configuring IPv6 in Windows for advanced users","title":"IPv6EnabledCheck"},{"location":"Diagnostics/HealthChecker/IPv6EnabledCheck/#ipv6-enabled-check","text":"Description: We check if IPv6 is enabled or not. If we determine that IPv6 has been disabled, we check to see if it's fully disabled as recommended. We determine if the IPv6 is fully disabled by checking to see if we have an IPv6 Address available on the NIC and that it matches what is found in the registry at SYSTEM\\CurrentControlSet\\Services\\Tcpip6\\Parameters\\DisabledComponents . If both places don't have IPv6 enabled/disabled properly a warning is thrown. This can cause communication issues if not properly disabled. Included in HTML Report? Yes Additional resources: Disabling IPv6 And Exchange \u2013 Going All The Way Guidance for configuring IPv6 in Windows for advanced users","title":"IPv6 Enabled Check"},{"location":"Diagnostics/HealthChecker/LMCompatibilityLevelInformationCheck/","text":"LM Compatibility Level Information Check LAN Manager authentication level setting determines which challenge/response authentication protocol is used for network logons. This choice affects the authentication protocol level that clients use, the session security level that the computers negotiate, and the authentication level that servers accept. Included in HTML Report? Yes Additional resources: Network security: LAN Manager authentication level","title":"LMCompatibilityLevelInformationCheck"},{"location":"Diagnostics/HealthChecker/LMCompatibilityLevelInformationCheck/#lm-compatibility-level-information-check","text":"LAN Manager authentication level setting determines which challenge/response authentication protocol is used for network logons. This choice affects the authentication protocol level that clients use, the session security level that the computers negotiate, and the authentication level that servers accept. Included in HTML Report? Yes Additional resources: Network security: LAN Manager authentication level","title":"LM Compatibility Level Information Check"},{"location":"Diagnostics/HealthChecker/MAPIFrontEndAppPoolGCModeCheck/","text":"MAPI Front End App Pool GC Mode Check Description: We validate the Garbage Collection (GC) configuration for MSExchangeMapiFrontEndAppPool App Pool if the check is executed against an Exchange 2013 server that is not running the EdgeTransport role. We check if: The server has a total memory of 21474836480 MB and gcServer.Enabled set to false \\ In this case we recommend to enable Server GC . gcServer.Enabled is neither true nor false \\ This case should be investigated. gcServer.Enabled is false In this case we're running Workstation GC.\\ You could be seeing some GC issues within the MSExchangeMapiFrontEndAppPool App Pool. However, you don't have enough memory installed on the system to recommend switching the GC mode by default without consulting a support professional. How to fix this: Go into the file MSExchangeMapiFrontEndAppPool_CLRConfig.config \\ You can find the file by running %windir%\\system32\\inetsrv\\appcmd.exe list apppool \"MSExchangeMapiFrontEndAppPool\" /text:\"CLRConfigFile\" via cmd.exe \\ It should be located here: %ExchangeInstallPath%\\bin\\MSExchangeMapiFrontEndAppPool_CLRConfig.config Open the file by using an elevated notepad.exe and change the gcServer Enabled value from false to true Recycle the MAPI Front End App Pool by running: Restart-WebAppPool MSExchangeMapiFrontEndAppPool via PowerShell or by running:\\ %windir%\\system32\\inetsrv\\appcmd.exe RECYCLE AppPool \"MSExchangeMapiFrontEndAppPool\" via cmd.exe Included in HTML Report? Yes Additional resources: Fundamentals of garbage collection Workstation and server garbage collection","title":"GCModeCheck"},{"location":"Diagnostics/HealthChecker/MAPIFrontEndAppPoolGCModeCheck/#mapi-front-end-app-pool-gc-mode-check","text":"Description: We validate the Garbage Collection (GC) configuration for MSExchangeMapiFrontEndAppPool App Pool if the check is executed against an Exchange 2013 server that is not running the EdgeTransport role. We check if: The server has a total memory of 21474836480 MB and gcServer.Enabled set to false \\ In this case we recommend to enable Server GC . gcServer.Enabled is neither true nor false \\ This case should be investigated. gcServer.Enabled is false In this case we're running Workstation GC.\\ You could be seeing some GC issues within the MSExchangeMapiFrontEndAppPool App Pool. However, you don't have enough memory installed on the system to recommend switching the GC mode by default without consulting a support professional. How to fix this: Go into the file MSExchangeMapiFrontEndAppPool_CLRConfig.config \\ You can find the file by running %windir%\\system32\\inetsrv\\appcmd.exe list apppool \"MSExchangeMapiFrontEndAppPool\" /text:\"CLRConfigFile\" via cmd.exe \\ It should be located here: %ExchangeInstallPath%\\bin\\MSExchangeMapiFrontEndAppPool_CLRConfig.config Open the file by using an elevated notepad.exe and change the gcServer Enabled value from false to true Recycle the MAPI Front End App Pool by running: Restart-WebAppPool MSExchangeMapiFrontEndAppPool via PowerShell or by running:\\ %windir%\\system32\\inetsrv\\appcmd.exe RECYCLE AppPool \"MSExchangeMapiFrontEndAppPool\" via cmd.exe Included in HTML Report? Yes Additional resources: Fundamentals of garbage collection Workstation and server garbage collection","title":"MAPI Front End App Pool GC Mode Check"},{"location":"Diagnostics/HealthChecker/NETFrameworkSupportabilityCheck/","text":".NET Framework Supportability Check Description: We check if the Exchange server is running a supported .NET Framework version. We do this based on the information provided by PG on Microsoft Docs (.NET Supportability Matrix). Included in HTML Report? Yes Additional resources: Microsoft .NET Framework Supportability Matrix","title":"NETFrameworkCheck"},{"location":"Diagnostics/HealthChecker/NETFrameworkSupportabilityCheck/#net-framework-supportability-check","text":"Description: We check if the Exchange server is running a supported .NET Framework version. We do this based on the information provided by PG on Microsoft Docs (.NET Supportability Matrix). Included in HTML Report? Yes Additional resources: Microsoft .NET Framework Supportability Matrix","title":".NET Framework Supportability Check"},{"location":"Diagnostics/HealthChecker/NumaBiosCheck/","text":"NUMA BIOS / All Processor Cores Visible Check Description: Check to see if the OS is able to see all the processor cores on the server. What normally happens is the OS is able to see 1 processor socket presented (aka half the number of cores) This can become a major problem on a server if you do not see all the processor cores for a few reasons. Logic is built into the Exchange Code to handle user workload management is based of the how much CPU the user is using or the process itself. When we aren't able to see all the cores on the system, the process can consume a higher amount than what logic dictates. We base this logic off of the number of cores presented to the OS by [System.Environment]::ProcessorCount . Because the underlying hardware has full access to all the processor cores, the process can go above what Exchange calculated out to set the threshold to be at and then throttling can occur. Sometimes the underlying setting isn't able to keep up and doesn't distribute the load between both the processor sockets, thus causing an issue because the application just lost half of its resources. You can see this occur when you look at the performance counter \"\\Processor Information(0,_Total)\\% Processor Time\" and \"\\Processor Information(1,_Total)\\% Processor Time\" as each one sees their own socket. One will go up while the other goes down. This might only happen for a few seconds, but there are health checks on the server that can be triggered to cause additional issues that will spiral the server. Included in HTML Report? Yes Additional resources: CUSTOMER ADVISORY c04650594 Exchange performance:HP NUMA BIOS settings Exchange 2016 users unable to edit Distribution Group membership using Outlook","title":"NumaBiosCheck"},{"location":"Diagnostics/HealthChecker/NumaBiosCheck/#numa-bios-all-processor-cores-visible-check","text":"Description: Check to see if the OS is able to see all the processor cores on the server. What normally happens is the OS is able to see 1 processor socket presented (aka half the number of cores) This can become a major problem on a server if you do not see all the processor cores for a few reasons. Logic is built into the Exchange Code to handle user workload management is based of the how much CPU the user is using or the process itself. When we aren't able to see all the cores on the system, the process can consume a higher amount than what logic dictates. We base this logic off of the number of cores presented to the OS by [System.Environment]::ProcessorCount . Because the underlying hardware has full access to all the processor cores, the process can go above what Exchange calculated out to set the threshold to be at and then throttling can occur. Sometimes the underlying setting isn't able to keep up and doesn't distribute the load between both the processor sockets, thus causing an issue because the application just lost half of its resources. You can see this occur when you look at the performance counter \"\\Processor Information(0,_Total)\\% Processor Time\" and \"\\Processor Information(1,_Total)\\% Processor Time\" as each one sees their own socket. One will go up while the other goes down. This might only happen for a few seconds, but there are health checks on the server that can be triggered to cause additional issues that will spiral the server. Included in HTML Report? Yes Additional resources: CUSTOMER ADVISORY c04650594 Exchange performance:HP NUMA BIOS settings Exchange 2016 users unable to edit Distribution Group membership using Outlook","title":"NUMA BIOS / All Processor Cores Visible Check"},{"location":"Diagnostics/HealthChecker/OpenRelayDomain/","text":"Open Relay Domain Description: We show a warning if we weren't able to run Get-AcceptedDomain and provide an unknown status. If we determine that an Open Relay Domain is set on the environment, we will throw an error in the results and provide which accepted domain ID is set with this. It is recommended to have an anonymous relay and scope down the receive connector for who can use it. Otherwise, you are allowing anybody to use your environment to send mail anywhere. NOTE: After installing the September 2021 CUs for Exchange 2016/2019, you can see crashes occur on your system for the transport services that look like this: Log Name: Application Source: MSExchange Common Date: 12/3/2021 12:40:35 PM Event ID: 4999 Task Category: General Level: Error Keywords: Classic User: N/A Computer: Contoso-E19A.Contoso.com Description: Watson report about to be sent for process id: 10072, with parameters: E12IIS, c-RTL-AMD64, 15.02.0986.005, MSExchangeDelivery, M.Exchange.Transport, M.E.T.AcceptedDomainTable..ctor, System.FormatException, 28d7-dumptidset, 15.02.0986.005. ErrorReportingEnabled: False This is caused by having an Internal Relay with an Accepted Domain of *. This is not a recommended configuration. Included in HTML Report? Yes Additional resources: Allow anonymous relay on Exchange servers","title":"OpenRelayDomainCheck"},{"location":"Diagnostics/HealthChecker/OpenRelayDomain/#open-relay-domain","text":"Description: We show a warning if we weren't able to run Get-AcceptedDomain and provide an unknown status. If we determine that an Open Relay Domain is set on the environment, we will throw an error in the results and provide which accepted domain ID is set with this. It is recommended to have an anonymous relay and scope down the receive connector for who can use it. Otherwise, you are allowing anybody to use your environment to send mail anywhere. NOTE: After installing the September 2021 CUs for Exchange 2016/2019, you can see crashes occur on your system for the transport services that look like this: Log Name: Application Source: MSExchange Common Date: 12/3/2021 12:40:35 PM Event ID: 4999 Task Category: General Level: Error Keywords: Classic User: N/A Computer: Contoso-E19A.Contoso.com Description: Watson report about to be sent for process id: 10072, with parameters: E12IIS, c-RTL-AMD64, 15.02.0986.005, MSExchangeDelivery, M.Exchange.Transport, M.E.T.AcceptedDomainTable..ctor, System.FormatException, 28d7-dumptidset, 15.02.0986.005. ErrorReportingEnabled: False This is caused by having an Internal Relay with an Accepted Domain of *. This is not a recommended configuration. Included in HTML Report? Yes Additional resources: Allow anonymous relay on Exchange servers","title":"Open Relay Domain"},{"location":"Diagnostics/HealthChecker/PacketsLossCheck/","text":"Packets Loss Check Description: We check if there are any PacketsReceivedDiscarded logged for the NIC. Large package loss can cause a performance impact on a system and should be investigated and fixed. Good: PacketsReceivedDiscarded is 0 Warning: PacketsReceivedDiscarded lower than 1000 Error: PacketsReceivedDiscarded greater than 1000 NOTE: This counter is accumulation from reboot, or if the NIC setting was changed, so the counter can be stale for some time. However, even though you might not be actively dropping packets, the counter should be at 0 in a healthy environment. Included in HTML Report? Yes Additional Information Large packet loss in the guest OS using VMXNET3 in ESXi (2039495) Disable \"adaptive rx ring sizing\" to avoid random interface reset (78343)","title":"PacketsLossCheck"},{"location":"Diagnostics/HealthChecker/PacketsLossCheck/#packets-loss-check","text":"Description: We check if there are any PacketsReceivedDiscarded logged for the NIC. Large package loss can cause a performance impact on a system and should be investigated and fixed. Good: PacketsReceivedDiscarded is 0 Warning: PacketsReceivedDiscarded lower than 1000 Error: PacketsReceivedDiscarded greater than 1000 NOTE: This counter is accumulation from reboot, or if the NIC setting was changed, so the counter can be stale for some time. However, even though you might not be actively dropping packets, the counter should be at 0 in a healthy environment. Included in HTML Report? Yes Additional Information Large packet loss in the guest OS using VMXNET3 in ESXi (2039495) Disable \"adaptive rx ring sizing\" to avoid random interface reset (78343)","title":"Packets Loss Check"},{"location":"Diagnostics/HealthChecker/PagefileSizeCheck/","text":"Pagefile Size Check Description: We check if the Pagefile is configured as recommended and that there is only 1 PageFile configured (multiple PageFiles can cause performance issues on Exchange server). Exchange 2019 Set the paging file minimum and maximum value to the same size: 25% of installed memory Exchange 2013/2016 Set the paging file minimum and maximum value to the same size: Less than 32 GB of RAM installed: Physical RAM plus 10MB, up to a maximum value of 32GB (32,778MB) 32 GB of RAM or more installed: 32GB How to set the pagefile to a static value? You can set the pagefile to a static size via wmic whereas InitialSize and MaximumSize is the size in megabytes calculated based on the Exchange Server version and memory installed in the server: wmic computersystem set AutomaticManagedPagefile=False wmic pagefileset set InitialSize=1024,MaximumSize=1024 Included in HTML Report? Yes Additional resources: PageFile requirements for Exchange 2019 PageFile requirements for Exchange 2016 PageFile requirements for Exchange 2013","title":"PagefileCheck"},{"location":"Diagnostics/HealthChecker/PagefileSizeCheck/#pagefile-size-check","text":"Description: We check if the Pagefile is configured as recommended and that there is only 1 PageFile configured (multiple PageFiles can cause performance issues on Exchange server).","title":"Pagefile Size Check"},{"location":"Diagnostics/HealthChecker/PagefileSizeCheck/#exchange-2019","text":"Set the paging file minimum and maximum value to the same size: 25% of installed memory","title":"Exchange 2019"},{"location":"Diagnostics/HealthChecker/PagefileSizeCheck/#exchange-20132016","text":"Set the paging file minimum and maximum value to the same size: Less than 32 GB of RAM installed: Physical RAM plus 10MB, up to a maximum value of 32GB (32,778MB) 32 GB of RAM or more installed: 32GB","title":"Exchange 2013/2016"},{"location":"Diagnostics/HealthChecker/PagefileSizeCheck/#how-to-set-the-pagefile-to-a-static-value","text":"You can set the pagefile to a static size via wmic whereas InitialSize and MaximumSize is the size in megabytes calculated based on the Exchange Server version and memory installed in the server: wmic computersystem set AutomaticManagedPagefile=False wmic pagefileset set InitialSize=1024,MaximumSize=1024 Included in HTML Report? Yes Additional resources: PageFile requirements for Exchange 2019 PageFile requirements for Exchange 2016 PageFile requirements for Exchange 2013","title":"How to set the pagefile to a static value?"},{"location":"Diagnostics/HealthChecker/ProcessorCheck/","text":"Number Of Processors Description: Number of Processors is the number of processor sockets detected on the server. It is only recommended to have up to 2 processors on the server. [3] An additional note is displayed if Type is set to VMware and greater than 2 processors. [1] How This Is Checked ([array](Get-WmiObject -Class Win32_Processor)).count Number Of Logical and Physical Cores Show the number of Physical and Logical cores presented to the OS. This is provided by the WmiObject class Win32_Processor . We show a warning if we have more than 24 Logical Cores and running Exchange 2013/2016 [2] We show a warning if we have more than 48 Logical Cores and running Exchange 2019 [2] How This Is Checked $processor = Get-WmiObject -Class Win32_Processor $processor |ForEach-Object {$logical += $_.NumberOfLogicalProcessors; $physical += $_.NumberOfCores} PS C:\\> $logical 24 PS C:\\> $physical 12 Max Processor Speed Check to see what the Max Processor Speed is set to for the processor. If the processor is throttled which may be a result of a misconfigured Power Plan. NOTE: If Power Plan isn't set to High Performance and the processor is being throttled, this will be flagged that Power Plan is the cause and to fix it ASAP. How This Is Checked $processor = Get-WmiObject -Class Win32_Processor $throttled = $processor | Where-Object {$_.CurrentClockSpeed -lt $_.MaxClockSpeed} if ($throttled) { Write-Host (\"Throttling your CPU\") } Included in HTML Report? Yes Additional resources: 1 - Does corespersocket Affect Performance? 2 - Commodity servers 3 - Hardware requirements for Exchange 2019 Exchange 2013 Sizing Hardware requirements for Exchange 2016","title":"ProcessorCheck"},{"location":"Diagnostics/HealthChecker/ProcessorCheck/#number-of-processors","text":"Description: Number of Processors is the number of processor sockets detected on the server. It is only recommended to have up to 2 processors on the server. [3] An additional note is displayed if Type is set to VMware and greater than 2 processors. [1]","title":"Number Of Processors"},{"location":"Diagnostics/HealthChecker/ProcessorCheck/#how-this-is-checked","text":"([array](Get-WmiObject -Class Win32_Processor)).count","title":"How This Is Checked"},{"location":"Diagnostics/HealthChecker/ProcessorCheck/#number-of-logical-and-physical-cores","text":"Show the number of Physical and Logical cores presented to the OS. This is provided by the WmiObject class Win32_Processor . We show a warning if we have more than 24 Logical Cores and running Exchange 2013/2016 [2] We show a warning if we have more than 48 Logical Cores and running Exchange 2019 [2]","title":"Number Of Logical and Physical Cores"},{"location":"Diagnostics/HealthChecker/ProcessorCheck/#how-this-is-checked_1","text":"$processor = Get-WmiObject -Class Win32_Processor $processor |ForEach-Object {$logical += $_.NumberOfLogicalProcessors; $physical += $_.NumberOfCores} PS C:\\> $logical 24 PS C:\\> $physical 12","title":"How This Is Checked"},{"location":"Diagnostics/HealthChecker/ProcessorCheck/#max-processor-speed","text":"Check to see what the Max Processor Speed is set to for the processor. If the processor is throttled which may be a result of a misconfigured Power Plan. NOTE: If Power Plan isn't set to High Performance and the processor is being throttled, this will be flagged that Power Plan is the cause and to fix it ASAP.","title":"Max Processor Speed"},{"location":"Diagnostics/HealthChecker/ProcessorCheck/#how-this-is-checked_2","text":"$processor = Get-WmiObject -Class Win32_Processor $throttled = $processor | Where-Object {$_.CurrentClockSpeed -lt $_.MaxClockSpeed} if ($throttled) { Write-Host (\"Throttling your CPU\") } Included in HTML Report? Yes Additional resources: 1 - Does corespersocket Affect Performance? 2 - Commodity servers 3 - Hardware requirements for Exchange 2019 Exchange 2013 Sizing Hardware requirements for Exchange 2016","title":"How This Is Checked"},{"location":"Diagnostics/HealthChecker/RPCMinConnectionTimeoutCheck/","text":"RPC Minimum Connection Timeout Check Description: By default, Outlook Anywhere opens two default connections to the Exchange CAS called RPC_InData and RPC_OutData . The Outlook Anywhere client to server used a default timeout of 12 minutes (720 seconds) of inactivity and the server to the client timeout is 15 minutes (900 seconds) . These default Keep-Alive intervals are not aggressive enough for some of today\u2019s home networking devices and/or aggressive network devices on the Internet. Some of those devices are dropping TCP connections after as little as 5 minutes (300 seconds) of inactivity. When one or both of the two default connections are dropped, the connection to the Exchange server is essentially broken and not useable. Included in HTML Report? Yes Additional resources: Outlook Anywhere Network Timeout Issue","title":"RPCMinConnectionTimeoutCheck"},{"location":"Diagnostics/HealthChecker/RPCMinConnectionTimeoutCheck/#rpc-minimum-connection-timeout-check","text":"Description: By default, Outlook Anywhere opens two default connections to the Exchange CAS called RPC_InData and RPC_OutData . The Outlook Anywhere client to server used a default timeout of 12 minutes (720 seconds) of inactivity and the server to the client timeout is 15 minutes (900 seconds) . These default Keep-Alive intervals are not aggressive enough for some of today\u2019s home networking devices and/or aggressive network devices on the Internet. Some of those devices are dropping TCP connections after as little as 5 minutes (300 seconds) of inactivity. When one or both of the two default connections are dropped, the connection to the Exchange server is essentially broken and not useable. Included in HTML Report? Yes Additional resources: Outlook Anywhere Network Timeout Issue","title":"RPC Minimum Connection Timeout Check"},{"location":"Diagnostics/HealthChecker/RSSEnabledCheck/","text":"RSS Enabled Check Description: We check on Windows 2012 R2 or newer whether RSS (if it's supported from the NIC) is enabled or not. This is collected by the Get-NetAdapterRss cmdlet. We show a warning if it's supported on NIC-side but disabled. The Get-NetAdapterRss cmdlet gets receive side scaling (RSS) properties of the network adapters that support RSS. RSS is a scalability technology that distributes the receive network traffic among multiple processors by hashing the header of the incoming packet and using an indirection table. Without RSS in Windows Server\u00ae 2012 and later, network traffic is received on the first processor which can quickly reach full utilization limiting receive network throughput. Various properties can be configured to optimize the performance of RSS. Included in HTML Report? Yes Additional resources: Introduction to Receive Side Scaling","title":"RSSEnabledCheck"},{"location":"Diagnostics/HealthChecker/RSSEnabledCheck/#rss-enabled-check","text":"Description: We check on Windows 2012 R2 or newer whether RSS (if it's supported from the NIC) is enabled or not. This is collected by the Get-NetAdapterRss cmdlet. We show a warning if it's supported on NIC-side but disabled. The Get-NetAdapterRss cmdlet gets receive side scaling (RSS) properties of the network adapters that support RSS. RSS is a scalability technology that distributes the receive network traffic among multiple processors by hashing the header of the incoming packet and using an indirection table. Without RSS in Windows Server\u00ae 2012 and later, network traffic is received on the first processor which can quickly reach full utilization limiting receive network throughput. Various properties can be configured to optimize the performance of RSS. Included in HTML Report? Yes Additional resources: Introduction to Receive Side Scaling","title":"RSS Enabled Check"},{"location":"Diagnostics/HealthChecker/RebootPending/","text":"Reboot Pending Description: We show a warning if we detect an outstanding pending reboot. We also display the type of pending reboot. We differentiate between: PendingFileRenameOperations SccmReboot SccmRebootPending ComponentBasedServicingRebootPending AutoUpdatePendingReboot UpdateExeVolatile\\Flags It is best to reboot the server to address these issues. It may take some time after a reboot to have the keys automatically removed. However, if they don't remove automatically, follow these steps to address the issue for the keys that were provided to be a problem. Open regedit to the desired location. Delete the key. If unable to delete the key, follow these steps: Right click on it Open permissions Click on Advanced Change ownership to your account Close Advanced window Give your account Full Control in Permissions window Delete the key NOTE: With Component Based Servicing\\RebootPending you need to do the same for Component Based Servicing\\PackagesPending prior to RebootPending NOTE: Follow the steps in this section carefully. Serious problems might occur if you modify the registry incorrectly. Before you modify it, back up the registry for restoration in case problems occur. Included in HTML Report? Yes Additional resources: Determine Pending Reboot Status\u2014PowerShell Style! Part 1 Determine Pending Reboot Status\u2014PowerShell Style! Part 2","title":"RebootPending"},{"location":"Diagnostics/HealthChecker/RebootPending/#reboot-pending","text":"Description: We show a warning if we detect an outstanding pending reboot. We also display the type of pending reboot. We differentiate between: PendingFileRenameOperations SccmReboot SccmRebootPending ComponentBasedServicingRebootPending AutoUpdatePendingReboot UpdateExeVolatile\\Flags It is best to reboot the server to address these issues. It may take some time after a reboot to have the keys automatically removed. However, if they don't remove automatically, follow these steps to address the issue for the keys that were provided to be a problem. Open regedit to the desired location. Delete the key. If unable to delete the key, follow these steps: Right click on it Open permissions Click on Advanced Change ownership to your account Close Advanced window Give your account Full Control in Permissions window Delete the key NOTE: With Component Based Servicing\\RebootPending you need to do the same for Component Based Servicing\\PackagesPending prior to RebootPending NOTE: Follow the steps in this section carefully. Serious problems might occur if you modify the registry incorrectly. Before you modify it, back up the registry for restoration in case problems occur. Included in HTML Report? Yes Additional resources: Determine Pending Reboot Status\u2014PowerShell Style! Part 1 Determine Pending Reboot Status\u2014PowerShell Style! Part 2","title":"Reboot Pending"},{"location":"Diagnostics/HealthChecker/RunHCViaSchedTask/","text":"How to run the Exchange Health Checker via Scheduled Task Description: You can run the Exchange Health Checker script by the help of a Scheduled Task on a daily, weekly or monthly base. This article describes some of the ways how to run the script as task and how to create those tasks. Note: We assume that the script is stored under C:\\Scripts\\HealthChecker . Please make sure to adjust the path if you use a different one in your environment. The first thing to do is to create a service account which is used to run the script. It is recommended to use a strong password which will be changed regularly. It's also recommended to add the user to the View-Only Organization Management instead of Organization Management . This should be sufficent for the script to run. Note: Using View-Only Organization Management instead of Organization Management requires you to add the account to the local Administrators group on each server. This can be achieved by creating a dedicated Security Group which is then added to the Administrators group on each Exchange server (manually or via Group Policy ). Now it's time to create the Scheduled Task. This can be done by the help of PowerShell: We need to create multiple objects and finally combining them to the Scheduled Task. We need a trigger , settings , action and task object. Create a trigger that defines when the script should be executed: (Example) Daily at 3 AM: $hcTrigger = New-ScheduledTaskTrigger -Daily -At 3am (Example) Every four weeks on Monday at 3 AM: $hcTrigger = New-ScheduledTaskTrigger -Weekly -WeeksInterval 4 -DaysOfWeek Monday -At 3am Create a Scheduled Task setting object: (Example) Create a Scheduled Task settings object using the default settings: $hcSettings = New-ScheduledTaskSettingsSet (Example) Create a Scheduled Task settings object and define RestartCount and RestartInterval : $hcSettings = New-ScheduledTaskSettingsSet -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 60) Define the actions to be executed via Scheduled Task: (Example) Update the HealthChecker script, execute the script against the local server and generate the HTML report: $hcAction = New-ScheduledTaskAction -Execute 'powershell.exe' -WorkingDirectory \"C:\\Scripts\\HealthChecker\\\" -Argument '-NonInteractive -NoLogo -NoProfile -Command \".\\HealthChecker.ps1 -ScriptUpdateOnly; .\\HealthChecker.ps1; .\\HealthChecker.ps1 -BuildHtmlServersReport\"' (Example) Run the HealthChecker script against a remote Exchange server (named ExchSrv01 in this example): $hcAction = New-ScheduledTaskAction -Execute 'powershell.exe' -WorkingDirectory \"C:\\Scripts\\HealthChecker\\\" -Argument '-NonInteractive -NoLogo -NoProfile -Command \".\\HealthChecker.ps1 -ScriptUpdateOnly; .\\HealthChecker.ps1 -Server ExchSrv01; .\\HealthChecker.ps1 -BuildHtmlServersReport\"' Create the Scheduled Task object using the pre-defined action, trigger and settings objects: $hcTask = New-ScheduledTask -Action $hcAction -Trigger $hcTrigger -Settings $hcSettings Create the Scheduled Task: Register-ScheduledTask -TaskName 'HealthChecker Daily Run' -InputObject $hcTask -User (Read-Host \"Please enter username in format (Domain\\Username)\") -Password (Read-Host \"Please enter password\") Additional resources: New-ScheduledTaskTrigger New-ScheduledTaskSettingsSet New-ScheduledTaskAction New-ScheduledTask Register-ScheduledTask","title":"HCScheduledTask"},{"location":"Diagnostics/HealthChecker/RunHCViaSchedTask/#how-to-run-the-exchange-health-checker-via-scheduled-task","text":"Description: You can run the Exchange Health Checker script by the help of a Scheduled Task on a daily, weekly or monthly base. This article describes some of the ways how to run the script as task and how to create those tasks. Note: We assume that the script is stored under C:\\Scripts\\HealthChecker . Please make sure to adjust the path if you use a different one in your environment. The first thing to do is to create a service account which is used to run the script. It is recommended to use a strong password which will be changed regularly. It's also recommended to add the user to the View-Only Organization Management instead of Organization Management . This should be sufficent for the script to run. Note: Using View-Only Organization Management instead of Organization Management requires you to add the account to the local Administrators group on each server. This can be achieved by creating a dedicated Security Group which is then added to the Administrators group on each Exchange server (manually or via Group Policy ). Now it's time to create the Scheduled Task. This can be done by the help of PowerShell: We need to create multiple objects and finally combining them to the Scheduled Task. We need a trigger , settings , action and task object. Create a trigger that defines when the script should be executed: (Example) Daily at 3 AM: $hcTrigger = New-ScheduledTaskTrigger -Daily -At 3am (Example) Every four weeks on Monday at 3 AM: $hcTrigger = New-ScheduledTaskTrigger -Weekly -WeeksInterval 4 -DaysOfWeek Monday -At 3am Create a Scheduled Task setting object: (Example) Create a Scheduled Task settings object using the default settings: $hcSettings = New-ScheduledTaskSettingsSet (Example) Create a Scheduled Task settings object and define RestartCount and RestartInterval : $hcSettings = New-ScheduledTaskSettingsSet -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 60) Define the actions to be executed via Scheduled Task: (Example) Update the HealthChecker script, execute the script against the local server and generate the HTML report: $hcAction = New-ScheduledTaskAction -Execute 'powershell.exe' -WorkingDirectory \"C:\\Scripts\\HealthChecker\\\" -Argument '-NonInteractive -NoLogo -NoProfile -Command \".\\HealthChecker.ps1 -ScriptUpdateOnly; .\\HealthChecker.ps1; .\\HealthChecker.ps1 -BuildHtmlServersReport\"' (Example) Run the HealthChecker script against a remote Exchange server (named ExchSrv01 in this example): $hcAction = New-ScheduledTaskAction -Execute 'powershell.exe' -WorkingDirectory \"C:\\Scripts\\HealthChecker\\\" -Argument '-NonInteractive -NoLogo -NoProfile -Command \".\\HealthChecker.ps1 -ScriptUpdateOnly; .\\HealthChecker.ps1 -Server ExchSrv01; .\\HealthChecker.ps1 -BuildHtmlServersReport\"' Create the Scheduled Task object using the pre-defined action, trigger and settings objects: $hcTask = New-ScheduledTask -Action $hcAction -Trigger $hcTrigger -Settings $hcSettings Create the Scheduled Task: Register-ScheduledTask -TaskName 'HealthChecker Daily Run' -InputObject $hcTask -User (Read-Host \"Please enter username in format (Domain\\Username)\") -Password (Read-Host \"Please enter password\") Additional resources: New-ScheduledTaskTrigger New-ScheduledTaskSettingsSet New-ScheduledTaskAction New-ScheduledTask Register-ScheduledTask","title":"How to run the Exchange Health Checker via Scheduled Task"},{"location":"Diagnostics/HealthChecker/SMBv1Check/","text":"SMBv1 Check To make sure that your Exchange organization is better protected against the latest threats (for example Emotet, TrickBot or WannaCry to name a few) we recommend disabling SMBv1 if it\u2019s enabled on your Exchange (2013/2016/2019) server. There is no need to run the nearly 30-year-old SMBv1 protocol when Exchange 2013/2016/2019 is installed on your system. SMBv1 isn\u2019t safe and you lose key protections offered by later SMB protocol versions. This check verifies that SMBv1 is not installed (if OS allows) and that its activation is blocked. Included in HTML Report? Yes Additional resources: Exchange Server and SMBv1","title":"SMBv1Check"},{"location":"Diagnostics/HealthChecker/SMBv1Check/#smbv1-check","text":"To make sure that your Exchange organization is better protected against the latest threats (for example Emotet, TrickBot or WannaCry to name a few) we recommend disabling SMBv1 if it\u2019s enabled on your Exchange (2013/2016/2019) server. There is no need to run the nearly 30-year-old SMBv1 protocol when Exchange 2013/2016/2019 is installed on your system. SMBv1 isn\u2019t safe and you lose key protections offered by later SMB protocol versions. This check verifies that SMBv1 is not installed (if OS allows) and that its activation is blocked. Included in HTML Report? Yes Additional resources: Exchange Server and SMBv1","title":"SMBv1 Check"},{"location":"Diagnostics/HealthChecker/SleepyNICCheck/","text":"Sleepy NIC Check Description: We validate the NIC power saving options. It's recommended to disable NIC power saving options as this may cause packet loss. To detect the NIC power saving options, we're probing the sub keys under: HKLM\\SYSTEM\\CurrentControlSet\\Control\\Class\\{4D36E972-E325-11CE-BFC1-08002bE10318} We then check if the PnPCapabilities REG_DWORD exists and if it does, we're validating its value. If it's 24 or 280 , NIC power saving is disabled as we recommend it. We skip this check for Multiplexor NIC adapters and in case that the host system is Hyper-V (because we're assuming that we don't support NIC power saving options on this platform). NOTE: If the REG_DWORD doesn't exists, we're assuming that NIC power saving is not disabled or configured and show a warning. Included in HTML Report? Yes Additional resources: Information about power management setting on a network adapter","title":"SleepyNICCheck"},{"location":"Diagnostics/HealthChecker/SleepyNICCheck/#sleepy-nic-check","text":"Description: We validate the NIC power saving options. It's recommended to disable NIC power saving options as this may cause packet loss. To detect the NIC power saving options, we're probing the sub keys under: HKLM\\SYSTEM\\CurrentControlSet\\Control\\Class\\{4D36E972-E325-11CE-BFC1-08002bE10318} We then check if the PnPCapabilities REG_DWORD exists and if it does, we're validating its value. If it's 24 or 280 , NIC power saving is disabled as we recommend it. We skip this check for Multiplexor NIC adapters and in case that the host system is Hyper-V (because we're assuming that we don't support NIC power saving options on this platform). NOTE: If the REG_DWORD doesn't exists, we're assuming that NIC power saving is not disabled or configured and show a warning. Included in HTML Report? Yes Additional resources: Information about power management setting on a network adapter","title":"Sleepy NIC Check"},{"location":"Diagnostics/HealthChecker/TCPIPSettingsCheck/","text":"TCP/IP Settings Check Description: We validate if a KeepAliveTime DWORD value exists under HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters and verify that it is set to a recommended value. Exchange TCP KeepAliveTime registry entry should be set to a decimal value between 900000 and 1800000 (15 to 30 minutes in milliseconds). If there's no entry in the registry for KeepAliveTime then the default value is 2 hours. This value, if not set correctly, can affect both connectivity and performance. You must make sure that the load balancer and any other devices in the path from client to Exchange are configured correctly. The goal is to set Exchange with the lowest value so that client sessions, when ended, are ended by Exchange and not by the device. Example: Client -> Firewall (1 hour) -> NLB (40 minutes) -> Exchange Servers (20 Minutes) Included in HTML Report? Yes Additional resources: Checklist for Troubleshooting Performance Related issues in Exchange 2013, 2016 and 2019 (on-prem)","title":"TCPIPSettingsCheck"},{"location":"Diagnostics/HealthChecker/TCPIPSettingsCheck/#tcpip-settings-check","text":"Description: We validate if a KeepAliveTime DWORD value exists under HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters and verify that it is set to a recommended value. Exchange TCP KeepAliveTime registry entry should be set to a decimal value between 900000 and 1800000 (15 to 30 minutes in milliseconds). If there's no entry in the registry for KeepAliveTime then the default value is 2 hours. This value, if not set correctly, can affect both connectivity and performance. You must make sure that the load balancer and any other devices in the path from client to Exchange are configured correctly. The goal is to set Exchange with the lowest value so that client sessions, when ended, are ended by Exchange and not by the device. Example: Client -> Firewall (1 hour) -> NLB (40 minutes) -> Exchange Servers (20 Minutes) Included in HTML Report? Yes Additional resources: Checklist for Troubleshooting Performance Related issues in Exchange 2013, 2016 and 2019 (on-prem)","title":"TCP/IP Settings Check"},{"location":"Diagnostics/HealthChecker/TLSConfigurationCheck/","text":"TLS Configuration Check We check and validate Exchange servers TLS 1.0 - 1.3 configuration. We can detect mismatches in TLS versions for client and server. This is important because Exchange can be both a client and a server. We will also show a yellow warning, if TLS 1.0 and/or TLS 1.1 is enabled. Microsoft's TLS 1.0 implementation is free of known security vulnerabilities. Due to the potential for future protocol downgrade attacks and other TLS 1.0 vulnerabilities not specific to Microsoft's implementation, it is recommended that dependencies on all security protocols older than TLS 1.2 be removed where possible (TLS 1.1/1.0/ SSLv3/SSLv2). At this time TLS 1.3 is not supported by Exchange and has been known to cause issues if enabled. If detected to be anything but disabled on Exchange, it will be thrown as an error and needs to be addressed right away. We also check for the SystemDefaultTlsVersions registry value which controls if .NET Framework will inherit its defaults from the Windows Schannel DisabledByDefault registry values or not. An invalid TLS configuration can cause issues within Exchange for communication. Only the values 0 or 1 are accepted and determined to be properly configured. The reason being is this is how our documentation provides to configure the value only and it then depends on how the code reads the value from the registry interpret the value. By not having the registry value defined, different versions of .NET Frameworks for what the code is compiled for will treat TLS options differently. Therefore, we throw an error if the key isn't defined and action should be taken to correct this as soon as possible. To correct this, you create the missing DWORD registry key with the value you wish to have. The Configuration result can provide a value of Enabled , Disabled , Half Disabled , or Misconfigured . They are defined by the following conditions: Value Definition Enabled Client and Server Enabled values are set to 1 and DisabledByDefault is set to 0 on the TLS Version. Disabled Client and Server Enabled values are set to 0 and DisabledByDefault is set to 1 on the TLS Version. Half Disabled Client and Server Enabled values are set to either 0 or 1 and DisabledByDefault is set to the opposite where the value doesn't equal Enabled or Disabled. This is not a supported configuration as it doesn't follow the documentation that we have provided. Misconfigured When either the Enabled or the DisabledByDefault values do not match between the Client and Server of that TLS Version. Exchange can be a Client and a Server and this will cause problems and needs to be addressed ASAP. The location where we are checking for the TLS values are here: SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Server SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.3\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.3\\Server At each location, we are looking at the value of Enabled and DisabledByDefault . If the key isn't present, Enabled is set to true and DisabledByDefault is set to false . With the exception of TLS 1.3, if that isn't present it is disabled by default. The location for the .NET Framework TLS related settings are located here: SOFTWARE\\Wow6432Node\\Microsoft\\.NETFramework\\v4.0.30319 SOFTWARE\\Microsoft\\.NETFramework\\v4.0.30319 SOFTWARE\\Wow6432Node\\Microsoft\\.NETFramework\\v2.0.50727 SOFTWARE\\Microsoft\\.NETFramework\\v2.0.50727 At each location, we are looking at the value of SystemDefaultTlsVersions and SchUseStrongCrypto . If the key isn't present, both are set to false . Included in HTML Report? Yes Additional resources: Exchange Server TLS configuration best practices Solving the TLS 1.0 Problem, 2nd Edition TLS 1.2 support at Microsoft Exchange Server TLS guidance, part 1: Getting Ready for TLS 1.2 Exchange Server TLS guidance Part 2: Enabling TLS 1.2 and Identifying Clients Not Using It Exchange Server TLS guidance Part 3: Turning Off TLS 1.0/1.1","title":"TLSConfigurationCheck"},{"location":"Diagnostics/HealthChecker/TLSConfigurationCheck/#tls-configuration-check","text":"We check and validate Exchange servers TLS 1.0 - 1.3 configuration. We can detect mismatches in TLS versions for client and server. This is important because Exchange can be both a client and a server. We will also show a yellow warning, if TLS 1.0 and/or TLS 1.1 is enabled. Microsoft's TLS 1.0 implementation is free of known security vulnerabilities. Due to the potential for future protocol downgrade attacks and other TLS 1.0 vulnerabilities not specific to Microsoft's implementation, it is recommended that dependencies on all security protocols older than TLS 1.2 be removed where possible (TLS 1.1/1.0/ SSLv3/SSLv2). At this time TLS 1.3 is not supported by Exchange and has been known to cause issues if enabled. If detected to be anything but disabled on Exchange, it will be thrown as an error and needs to be addressed right away. We also check for the SystemDefaultTlsVersions registry value which controls if .NET Framework will inherit its defaults from the Windows Schannel DisabledByDefault registry values or not. An invalid TLS configuration can cause issues within Exchange for communication. Only the values 0 or 1 are accepted and determined to be properly configured. The reason being is this is how our documentation provides to configure the value only and it then depends on how the code reads the value from the registry interpret the value. By not having the registry value defined, different versions of .NET Frameworks for what the code is compiled for will treat TLS options differently. Therefore, we throw an error if the key isn't defined and action should be taken to correct this as soon as possible. To correct this, you create the missing DWORD registry key with the value you wish to have. The Configuration result can provide a value of Enabled , Disabled , Half Disabled , or Misconfigured . They are defined by the following conditions: Value Definition Enabled Client and Server Enabled values are set to 1 and DisabledByDefault is set to 0 on the TLS Version. Disabled Client and Server Enabled values are set to 0 and DisabledByDefault is set to 1 on the TLS Version. Half Disabled Client and Server Enabled values are set to either 0 or 1 and DisabledByDefault is set to the opposite where the value doesn't equal Enabled or Disabled. This is not a supported configuration as it doesn't follow the documentation that we have provided. Misconfigured When either the Enabled or the DisabledByDefault values do not match between the Client and Server of that TLS Version. Exchange can be a Client and a Server and this will cause problems and needs to be addressed ASAP. The location where we are checking for the TLS values are here: SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Server SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.3\\Client SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.3\\Server At each location, we are looking at the value of Enabled and DisabledByDefault . If the key isn't present, Enabled is set to true and DisabledByDefault is set to false . With the exception of TLS 1.3, if that isn't present it is disabled by default. The location for the .NET Framework TLS related settings are located here: SOFTWARE\\Wow6432Node\\Microsoft\\.NETFramework\\v4.0.30319 SOFTWARE\\Microsoft\\.NETFramework\\v4.0.30319 SOFTWARE\\Wow6432Node\\Microsoft\\.NETFramework\\v2.0.50727 SOFTWARE\\Microsoft\\.NETFramework\\v2.0.50727 At each location, we are looking at the value of SystemDefaultTlsVersions and SchUseStrongCrypto . If the key isn't present, both are set to false . Included in HTML Report? Yes Additional resources: Exchange Server TLS configuration best practices Solving the TLS 1.0 Problem, 2nd Edition TLS 1.2 support at Microsoft Exchange Server TLS guidance, part 1: Getting Ready for TLS 1.2 Exchange Server TLS guidance Part 2: Enabling TLS 1.2 and Identifying Clients Not Using It Exchange Server TLS guidance Part 3: Turning Off TLS 1.0/1.1","title":"TLS Configuration Check"},{"location":"Diagnostics/HealthChecker/VisualCRedistributableVersionCheck/","text":"Visual C++ Redistributable Version Check Description: We check if the the latest Visual C++ Redistributable version, required for the installed Exchange server role, is installed or not. Included in HTML Report? Yes Additional resources: Microsoft Visual C++ Redistributable Latest Supported Downloads Exchange Server 2019 prerequisites Exchange Server 2016 prerequisites","title":"VisualCCheck"},{"location":"Diagnostics/HealthChecker/VisualCRedistributableVersionCheck/#visual-c-redistributable-version-check","text":"Description: We check if the the latest Visual C++ Redistributable version, required for the installed Exchange server role, is installed or not. Included in HTML Report? Yes Additional resources: Microsoft Visual C++ Redistributable Latest Supported Downloads Exchange Server 2019 prerequisites Exchange Server 2016 prerequisites","title":"Visual C++ Redistributable Version Check"},{"location":"Diagnostics/HealthChecker/VulnerabilityCheck/","text":"Vulnerability Check The script performs different checks to detect vulnerabilities which may lead into a security issue for the Exchange server. Vulnerability checks performed: Check the Exchange server build number against known vulnerabilities that exists within a specific build Check for CVE-2020-0796 SMBv3 vulnerability Check for CVE-2020-1147 .NET Core & .NET Framework vulnerability Check for CVE-2021-1730 Download Domains state Included in HTML Report? Yes","title":"VulnerabilityCheck"},{"location":"Diagnostics/HealthChecker/VulnerabilityCheck/#vulnerability-check","text":"The script performs different checks to detect vulnerabilities which may lead into a security issue for the Exchange server. Vulnerability checks performed: Check the Exchange server build number against known vulnerabilities that exists within a specific build Check for CVE-2020-0796 SMBv3 vulnerability Check for CVE-2020-1147 .NET Core & .NET Framework vulnerability Check for CVE-2021-1730 Download Domains state Included in HTML Report? Yes","title":"Vulnerability Check"},{"location":"Hybrid/Test-HMAEAS/","text":"Validating Hybrid Modern Authentication setup for Outlook for iOS and Android Download the latest release: Test-HMAEAS.ps1 This script allows you to check and see if your on-premises Exchange environment is configured correctly to use Hybrid Modern Authentication (HMA) with Outlook for iOS and Android. For this to work correctly, you will need to enable HMA and follow HMA Outlook for iOS and Android guidance to configure this feature properly. To run the script, at minimum you will need a valid SMTP Address for a user that is located on-premises. To test basic AutoDiscover and a Empty Bearer Authorization check you can run: .\\ Test-HMAEAS . ps1 user @contoso . com To test basic AutoDiscover with a custom AutoDiscover Name and also do Empty Bearer Authorization check you can run: .\\ Test-HMAEAS . ps1 user @contoso . com -CustomAutoD autodiscover . contoso . com To test basic EAS Connectivity you can run (you will need to use the users credentials for this test): .\\ Test-HMAEAS . ps1 user @contoso . com -TestEAS","title":"Test-HMAEAS"},{"location":"Hybrid/Test-HMAEAS/#validating-hybrid-modern-authentication-setup-for-outlook-for-ios-and-android","text":"Download the latest release: Test-HMAEAS.ps1 This script allows you to check and see if your on-premises Exchange environment is configured correctly to use Hybrid Modern Authentication (HMA) with Outlook for iOS and Android. For this to work correctly, you will need to enable HMA and follow HMA Outlook for iOS and Android guidance to configure this feature properly. To run the script, at minimum you will need a valid SMTP Address for a user that is located on-premises. To test basic AutoDiscover and a Empty Bearer Authorization check you can run: .\\ Test-HMAEAS . ps1 user @contoso . com To test basic AutoDiscover with a custom AutoDiscover Name and also do Empty Bearer Authorization check you can run: .\\ Test-HMAEAS . ps1 user @contoso . com -CustomAutoD autodiscover . contoso . com To test basic EAS Connectivity you can run (you will need to use the users credentials for this test): .\\ Test-HMAEAS . ps1 user @contoso . com -TestEAS","title":"Validating Hybrid Modern Authentication setup for Outlook for iOS and Android"},{"location":"M365/DLT365Groupsupgrade/","text":"DLT365Groupsupgrade Download the latest release: DLT365Groupsupgrade.ps1 Validating Distribution group eligibility for upgrade to O365 Group This script allows you to check Distribution to O365 Group migration eligibility for a specific distribution group SMTP, for more information over the Distribution to O365 Group migration blockers please check: https://docs.microsoft.com/en-us/microsoft-365/admin/manage/upgrade-distribution-lists?view=o365-worldwide The script will prompt for global administrator username & password to connect to EXO Then the script will ask for required group smtp Then start to check and provide feedback in case group migration blockers found as illustrated below:","title":"DLT365Groupsupgrade"},{"location":"M365/DLT365Groupsupgrade/#dlt365groupsupgrade","text":"Download the latest release: DLT365Groupsupgrade.ps1","title":"DLT365Groupsupgrade"},{"location":"M365/DLT365Groupsupgrade/#validating-distribution-group-eligibility-for-upgrade-to-o365-group","text":"This script allows you to check Distribution to O365 Group migration eligibility for a specific distribution group SMTP, for more information over the Distribution to O365 Group migration blockers please check: https://docs.microsoft.com/en-us/microsoft-365/admin/manage/upgrade-distribution-lists?view=o365-worldwide The script will prompt for global administrator username & password to connect to EXO Then the script will ask for required group smtp Then start to check and provide feedback in case group migration blockers found as illustrated below:","title":"Validating Distribution group eligibility for upgrade to O365 Group"},{"location":"NewUserGuide/","text":"New User Guide Introduction If you are new to Git and GitHub, and you want to contribute to CSS-Exchange, you've come to the right place. There are many, many resources on how to use Git and GitHub. We recommend starting with Pro Git . Reading chapters 1 to 3 provides a great foundation for understanding and using Git. This page will serve as a quick start that leads you through submitting a Pull Request to CSS-Exchange step by step. This page will not cover the use of any GUI that attempts to insulate the user from the Git command line. In this author's opinion, the only way to really learn Git is to use the command line, so that's all we'll cover here. Before You Start If you are considering a large change to a script or a brand new script, it's often a good idea to open an Issue first to discuss the change. This will allow the repository owners to provide feedback on whether they would accept this type of change. By getting feedback before you spend days on a complex change, you can ensure that you're not wasting your time. Installation Install PowerShell 7 or later . Install Visual Studio Code . You'll need this to develop scripts for this project. Assuming you're running Windows, install Git For Windows . When it asks for your default editor, choose Visual Studio Code. The rest of the defaults are fine. If you're on a different operating system, refer to the Git documentation for instructions. Optional but recommended: Install Posh Git in your PowerShell 7+ shell. This adds some useful features such as branch name autocompletion in PowerShell. Forking the repository The first step is to fork the repository on GitHub. Unless you have Write access to CSS-Exchange, you can't push directly to our repo. Creating a fork creates your own copy of the repo on GitHub, so you have somewhere to push your changes. To fork the repository, use the Fork icon at the top right of the repository page. You'll be prompted for a name and description. The defaults are fine. When the fork is complete, you'll be taken to the new repository page. At the top left, you should see that you are now on your own fork. Cloning the repository Now you're ready to start using the git command line. To clone the repository, drop down the Code button and copy the URL: Then use that URL to clone the repository using the command line: git clone < url > This creates a folder called CSS-Exchange in your current directory. Creating a new branch Change into the folder that was just created. Your shell should now look something like this. Because we have PoshGit loaded, it's showing our current branch name in the prompt - main. Let's create a new branch for our work. It's nice to use a descriptive name. For example, if we're updating this guide, we might call name it like so: Making changes Now that you're on your own branch, you're ready to make your changes. You can technically use any tool you like - notepad, vim, whatever. But, if you open the repo root folder in Visual Studio Code, many of the repository formatting settings will be applied automatically. You can also shift-alt-F to reformat a file according to the settings. This may save you some time later. For this example, I created a new script called New-Script.ps1. After making our changes, it's a good idea to verify that git sees everything we changed, and that we haven't changed any files we didn't intend to. Because we have PoshGit, just hitting Enter to get a new prompt shows us some information about how many files have changed. We can also run git status to see some details. This looks good. My intent was to add one script file, and that's the only change shown here. Formatting changes CSS-Exchange has some formatting requirements to ensure consistency, and these checks are integrated into our build process. Before committing changes, let's run .build\\CodeFormatter.ps1 to see if our new script meets the requirements. CodeFormatter highlighted a few problems here: File has no newline at the end. File is missing the required compliance header. File has no BOM. We require a BOM on scripts. The formatting of the code itself is not using the correct brace style. This is shown in a warning, followed by diff output illustrating the required change. In addition, a PSScriptAnalyzer check at the end highlights the same issue with the PSPlaceOpenBrace rule. CodeFormatter will fix some problems automatically if the -Save switch is included. Let's run it again with -Save. Here we see CodeFormatter automatically fixed all of these issues when run with the -Save switch. Running a second time, we can confirm everything was fixed, as it generates no output at all. Staging changes We're almost ready to commit our changes, but first we should stage them. Staging gives us a chance to sanity-check what we're about to commit before we actually commit. It's especially useful when we have modified several files for testing, but we only intend to commit some of them. If we run git status again, we should once again see that only one file is modified for our simple test case. Then we can stage our file with git add , and check the result again with git status . When we have many files to commit, we can use git add . to stage all files in the current folder and subfolders, or git add :/ to stage all files everywhere. When using those options, it's especially important to check git status to make sure we haven't staged something we didn't intend to. Committing changes If git status shows that the correct files are staged, we can commit them with git commit . This will open the default editor, which will be Visual Studio Code if you chose it when installing Git as described earlier. The top line should be the title of the commit. Then skip a line and add further details as necessary. Close the tab, choose Save when prompted, and we see the following output. Now our changes are committed to our local copy of our branch, but we need to push those to GitHub. Pushing the changes Because this is the first time we're pushing changes for our new branch, we have to provide a few details. On our first push of our new branch, the syntax will be git push -u origin <branch name> . Origin means we're pushing to the location we cloned from - this is the name of the remote repo by default. The -u parameter tells it to set this as our upstream for this branch. We only have to do this the first time. If we make additional changes on this branch and commit them, we can now push them to the server with a simple git push , since we have now told it that origin will be our upstream going forward. Now we're ready to request that our changes be pulled into the official repo. Creating a Pull Request There are a few ways to create a Pull Request. We can see in the previous screenshot that GitHub helpfully shows us a URL we can visit to start a Pull Request. You can also manually navigate to the Pull Request tab of the official repo, and create a new Pull Request there. You might even see a prompt to create a PR for the branch you just pushed. Either of these methods will work. At this point we're presented with a form to provide some details about the PR. Be sure that at the top of the PR form, we see the offical repo and the main branch on the left, followed by your fork and the branch you created on the right. Fill in the details and hit Create Pull Request. Responding to feedback The repository owners will often request some changes to our code by commenting on the Pull Request. To update the code in the Pull Request, simply make the additional changes in your local files, stage them, and commit them just as before. Then, git push . Remember, we don't need any other parameters on the push this time. After pushing new changes, we should see the PR update almost instantly. Once the owners are satisfied with the changes, they will approve and merge the PR. And we're done! Cleaning up Once the PR is merged, we can delete our fork and delete the folder containing our local clone. We can keep the fork around if we intend to contribute further, but the main branch of the fork will not automatically pull in the latest changes from the official repo. It will get further and further out of date, which may cause problems with future pull requests. To avoid this, we'll need to pull in the changes from the main branch of the official repo into our fork. This is out of scope for this guide, so we'll leave this an exercise for the reader.","title":"New User Guide"},{"location":"NewUserGuide/#new-user-guide","text":"","title":"New User Guide"},{"location":"NewUserGuide/#introduction","text":"If you are new to Git and GitHub, and you want to contribute to CSS-Exchange, you've come to the right place. There are many, many resources on how to use Git and GitHub. We recommend starting with Pro Git . Reading chapters 1 to 3 provides a great foundation for understanding and using Git. This page will serve as a quick start that leads you through submitting a Pull Request to CSS-Exchange step by step. This page will not cover the use of any GUI that attempts to insulate the user from the Git command line. In this author's opinion, the only way to really learn Git is to use the command line, so that's all we'll cover here.","title":"Introduction"},{"location":"NewUserGuide/#before-you-start","text":"If you are considering a large change to a script or a brand new script, it's often a good idea to open an Issue first to discuss the change. This will allow the repository owners to provide feedback on whether they would accept this type of change. By getting feedback before you spend days on a complex change, you can ensure that you're not wasting your time.","title":"Before You Start"},{"location":"NewUserGuide/#installation","text":"Install PowerShell 7 or later . Install Visual Studio Code . You'll need this to develop scripts for this project. Assuming you're running Windows, install Git For Windows . When it asks for your default editor, choose Visual Studio Code. The rest of the defaults are fine. If you're on a different operating system, refer to the Git documentation for instructions. Optional but recommended: Install Posh Git in your PowerShell 7+ shell. This adds some useful features such as branch name autocompletion in PowerShell.","title":"Installation"},{"location":"NewUserGuide/#forking-the-repository","text":"The first step is to fork the repository on GitHub. Unless you have Write access to CSS-Exchange, you can't push directly to our repo. Creating a fork creates your own copy of the repo on GitHub, so you have somewhere to push your changes. To fork the repository, use the Fork icon at the top right of the repository page. You'll be prompted for a name and description. The defaults are fine. When the fork is complete, you'll be taken to the new repository page. At the top left, you should see that you are now on your own fork.","title":"Forking the repository"},{"location":"NewUserGuide/#cloning-the-repository","text":"Now you're ready to start using the git command line. To clone the repository, drop down the Code button and copy the URL: Then use that URL to clone the repository using the command line: git clone < url > This creates a folder called CSS-Exchange in your current directory.","title":"Cloning the repository"},{"location":"NewUserGuide/#creating-a-new-branch","text":"Change into the folder that was just created. Your shell should now look something like this. Because we have PoshGit loaded, it's showing our current branch name in the prompt - main. Let's create a new branch for our work. It's nice to use a descriptive name. For example, if we're updating this guide, we might call name it like so:","title":"Creating a new branch"},{"location":"NewUserGuide/#making-changes","text":"Now that you're on your own branch, you're ready to make your changes. You can technically use any tool you like - notepad, vim, whatever. But, if you open the repo root folder in Visual Studio Code, many of the repository formatting settings will be applied automatically. You can also shift-alt-F to reformat a file according to the settings. This may save you some time later. For this example, I created a new script called New-Script.ps1. After making our changes, it's a good idea to verify that git sees everything we changed, and that we haven't changed any files we didn't intend to. Because we have PoshGit, just hitting Enter to get a new prompt shows us some information about how many files have changed. We can also run git status to see some details. This looks good. My intent was to add one script file, and that's the only change shown here.","title":"Making changes"},{"location":"NewUserGuide/#formatting-changes","text":"CSS-Exchange has some formatting requirements to ensure consistency, and these checks are integrated into our build process. Before committing changes, let's run .build\\CodeFormatter.ps1 to see if our new script meets the requirements. CodeFormatter highlighted a few problems here: File has no newline at the end. File is missing the required compliance header. File has no BOM. We require a BOM on scripts. The formatting of the code itself is not using the correct brace style. This is shown in a warning, followed by diff output illustrating the required change. In addition, a PSScriptAnalyzer check at the end highlights the same issue with the PSPlaceOpenBrace rule. CodeFormatter will fix some problems automatically if the -Save switch is included. Let's run it again with -Save. Here we see CodeFormatter automatically fixed all of these issues when run with the -Save switch. Running a second time, we can confirm everything was fixed, as it generates no output at all.","title":"Formatting changes"},{"location":"NewUserGuide/#staging-changes","text":"We're almost ready to commit our changes, but first we should stage them. Staging gives us a chance to sanity-check what we're about to commit before we actually commit. It's especially useful when we have modified several files for testing, but we only intend to commit some of them. If we run git status again, we should once again see that only one file is modified for our simple test case. Then we can stage our file with git add , and check the result again with git status . When we have many files to commit, we can use git add . to stage all files in the current folder and subfolders, or git add :/ to stage all files everywhere. When using those options, it's especially important to check git status to make sure we haven't staged something we didn't intend to.","title":"Staging changes"},{"location":"NewUserGuide/#committing-changes","text":"If git status shows that the correct files are staged, we can commit them with git commit . This will open the default editor, which will be Visual Studio Code if you chose it when installing Git as described earlier. The top line should be the title of the commit. Then skip a line and add further details as necessary. Close the tab, choose Save when prompted, and we see the following output. Now our changes are committed to our local copy of our branch, but we need to push those to GitHub.","title":"Committing changes"},{"location":"NewUserGuide/#pushing-the-changes","text":"Because this is the first time we're pushing changes for our new branch, we have to provide a few details. On our first push of our new branch, the syntax will be git push -u origin <branch name> . Origin means we're pushing to the location we cloned from - this is the name of the remote repo by default. The -u parameter tells it to set this as our upstream for this branch. We only have to do this the first time. If we make additional changes on this branch and commit them, we can now push them to the server with a simple git push , since we have now told it that origin will be our upstream going forward. Now we're ready to request that our changes be pulled into the official repo.","title":"Pushing the changes"},{"location":"NewUserGuide/#creating-a-pull-request","text":"There are a few ways to create a Pull Request. We can see in the previous screenshot that GitHub helpfully shows us a URL we can visit to start a Pull Request. You can also manually navigate to the Pull Request tab of the official repo, and create a new Pull Request there. You might even see a prompt to create a PR for the branch you just pushed. Either of these methods will work. At this point we're presented with a form to provide some details about the PR. Be sure that at the top of the PR form, we see the offical repo and the main branch on the left, followed by your fork and the branch you created on the right. Fill in the details and hit Create Pull Request.","title":"Creating a Pull Request"},{"location":"NewUserGuide/#responding-to-feedback","text":"The repository owners will often request some changes to our code by commenting on the Pull Request. To update the code in the Pull Request, simply make the additional changes in your local files, stage them, and commit them just as before. Then, git push . Remember, we don't need any other parameters on the push this time. After pushing new changes, we should see the PR update almost instantly. Once the owners are satisfied with the changes, they will approve and merge the PR. And we're done!","title":"Responding to feedback"},{"location":"NewUserGuide/#cleaning-up","text":"Once the PR is merged, we can delete our fork and delete the folder containing our local clone. We can keep the fork around if we intend to contribute further, but the main branch of the fork will not automatically pull in the latest changes from the official repo. It will get further and further out of date, which may cause problems with future pull requests. To avoid this, we'll need to pull in the changes from the main branch of the official repo into our fork. This is out of scope for this guide, so we'll leave this an exercise for the reader.","title":"Cleaning up"},{"location":"Performance/ExPerfAnalyzer/","text":"ExPerfAnalyzer Download the latest release: ExPerfAnalyzer.ps1 Running the script .\\ExPerfAnalyzer.ps1 .\\EXSERVER01_FULL_000001.BLG Registering script as a default handler .\\ExPerfAnalyzer.ps1 -RegisterHandler PowerShell must be running as an administrator for this command to work. The script will register itself as a shell handler for perfmon .blg files. You can then right-click any .blg file and select ExPerfAnalyzer to quickly parse the file. Inspiration This script was inspired by Performance Analysis of Logs (PAL) and PMA.VBS (an internal tool used by Windows support). FAQ This takes forever to run. It's faster than PAL. Why don't I just use PAL? You could, but PAL takes even longer to run and throws a lot of false positives. What's the expected running time? v0.2.2 and an Intel Core i7-4810MQ @ 2.8Ghz processed a 1GB perfmon sitting on an SSD in 11 seconds. Can I edit this script however I'd like? Yes, that's the magic of open source software! Do you accept pull requests? Can I contribute to the script? Of course!","title":"ExPerfAnalyzer"},{"location":"Performance/ExPerfAnalyzer/#experfanalyzer","text":"Download the latest release: ExPerfAnalyzer.ps1","title":"ExPerfAnalyzer"},{"location":"Performance/ExPerfAnalyzer/#running-the-script","text":".\\ExPerfAnalyzer.ps1 .\\EXSERVER01_FULL_000001.BLG","title":"Running the script"},{"location":"Performance/ExPerfAnalyzer/#registering-script-as-a-default-handler","text":".\\ExPerfAnalyzer.ps1 -RegisterHandler PowerShell must be running as an administrator for this command to work. The script will register itself as a shell handler for perfmon .blg files. You can then right-click any .blg file and select ExPerfAnalyzer to quickly parse the file.","title":"Registering script as a default handler"},{"location":"Performance/ExPerfAnalyzer/#inspiration","text":"This script was inspired by Performance Analysis of Logs (PAL) and PMA.VBS (an internal tool used by Windows support).","title":"Inspiration"},{"location":"Performance/ExPerfAnalyzer/#faq","text":"This takes forever to run. It's faster than PAL. Why don't I just use PAL? You could, but PAL takes even longer to run and throws a lot of false positives. What's the expected running time? v0.2.2 and an Intel Core i7-4810MQ @ 2.8Ghz processed a 1GB perfmon sitting on an SSD in 11 seconds. Can I edit this script however I'd like? Yes, that's the magic of open source software! Do you accept pull requests? Can I contribute to the script? Of course!","title":"FAQ"},{"location":"Performance/ExPerfWiz/","text":"About ExPerfWiz ExPerfWiz is a PowerShell based script to help automate the collection of performance data on Exchange 2013, 2016 and 2019 servers. Supported operating systems are Windows 2012, 2012 R2, 2016 and 2019 Core and Standard. Initial Run Run .\\ExPerfWiz.ps1 from an elevated shell. You will be prompted to setup a default collector on the current server. Selecting Y will configure but not start a default collector on the current server. Selecting N will return to a prompt without creating a collector. Once a prompt is returned all of the ExPerfWiz functions will now be available to run. Common Usage New-Experfwiz -folderpath C:\\perfwiz -startoncreate How to use The following functions are provided by ExPerfWiz to manage data collection. Get-ExPerfwiz Gets ExPerfwiz data collector sets Switch Description Default Name Name of the Data Collector set Exchange_Perfwiz Server Name of the Server Local Machine ShowLog Displays the ExperfWiz Log file NA New-ExPerfwiz Creates an ExPerfwiz data collector set Will overwrite any existing sets with the same name Switch Description Default Circular Enabled or Disable circular logging Disabled Duration How long should the performance data be collected 08:00:00 FolderPath Output Path for performance logs NA Interval How often the performance data should be collected. 5s MaxSize Maximum size of the perfmon log in MegaBytes (256-4096) 1024Mb Name The name of the data collector set Exchange_Perfwiz Server Name of the server where the perfmon collector should be created Local Machine StartOnCreate Starts the counter set as soon as it is created False StartTime Daily time to start perfmon counter NA Template XML perfmon template file that should be loaded to create the data collector set. Exch_13_16_19_Full.xml Threads Includes threads in the counter set. False Set-ExPerfwiz Modifies the configuration of an existing data collector set. Switch Description Default Duration How long should the performance data be collected 08:00:00 Interval How often the performance data should be collected. 5s MaxSize Maximum size of the perfmon log in MegaBytes (256-4096) 1024Mb Name The name of the data collector set Exchange_Perfwiz Server Name of the server where the perfmon collector should be created Local Machine StartTime Daily time to start perfmon counter NA Quiet Suppress output False Remove-ExPerfwiz Removes an ExPerfwiz data collector set Switch Description Default Name Name of the Perfmon Collector set Exchange_Perfwiz Server Name of the server to remove the collector set from Local Machine Start-ExPerfwiz Starts an ExPerfwiz data collector set Switch Description Default Name The Name of the Data Collector set to start Exchange_Perfwiz Server Name of the remote server to start the data collector set on. Local Machine Stop-ExPerfwiz Stops an ExPerfwiz data collector set Switch Description Default Name Name of the data collector set to stop. Exchange_Perfwiz Server Name of the server to stop the collector set on. Local Machine Example Usage Default usage for data gathering New-ExPerfwiz -FolderPath C:\\experfwiz -StartOnCreate Stop Data Collection Stop-ExPerfwiz Collect data from another server New-ExPerfwiz -FolderPath C:\\experfwiz -server RemoteExchServer Collect data from multiple servers Get-ExchangeServer | Foreach {New-Experfwiz -folderpath C:\\experfwiz -startoncreate -Server $_.name} Important Notes The default duration is 8 hours to save on disk space meaning that the data collection will stop after 8 hours. Using -Threads should only be done if needed to troubleshoot the issue. It will SIGNIFICANTLY increase the size of the resulting perfmon files. Do not stop the log gathering thru the Perfmon GUI that can result in an unreadable log file. Always stop the data gathering with Stop-Experfwiz.","title":"ExPerfWiz"},{"location":"Performance/ExPerfWiz/#about-experfwiz","text":"ExPerfWiz is a PowerShell based script to help automate the collection of performance data on Exchange 2013, 2016 and 2019 servers. Supported operating systems are Windows 2012, 2012 R2, 2016 and 2019 Core and Standard.","title":"About ExPerfWiz"},{"location":"Performance/ExPerfWiz/#initial-run","text":"Run .\\ExPerfWiz.ps1 from an elevated shell. You will be prompted to setup a default collector on the current server. Selecting Y will configure but not start a default collector on the current server. Selecting N will return to a prompt without creating a collector. Once a prompt is returned all of the ExPerfWiz functions will now be available to run.","title":"Initial Run"},{"location":"Performance/ExPerfWiz/#common-usage","text":"New-Experfwiz -folderpath C:\\perfwiz -startoncreate","title":"Common Usage"},{"location":"Performance/ExPerfWiz/#how-to-use","text":"The following functions are provided by ExPerfWiz to manage data collection.","title":"How to use"},{"location":"Performance/ExPerfWiz/#get-experfwiz","text":"Gets ExPerfwiz data collector sets Switch Description Default Name Name of the Data Collector set Exchange_Perfwiz Server Name of the Server Local Machine ShowLog Displays the ExperfWiz Log file NA","title":"Get-ExPerfwiz"},{"location":"Performance/ExPerfWiz/#new-experfwiz","text":"Creates an ExPerfwiz data collector set Will overwrite any existing sets with the same name Switch Description Default Circular Enabled or Disable circular logging Disabled Duration How long should the performance data be collected 08:00:00 FolderPath Output Path for performance logs NA Interval How often the performance data should be collected. 5s MaxSize Maximum size of the perfmon log in MegaBytes (256-4096) 1024Mb Name The name of the data collector set Exchange_Perfwiz Server Name of the server where the perfmon collector should be created Local Machine StartOnCreate Starts the counter set as soon as it is created False StartTime Daily time to start perfmon counter NA Template XML perfmon template file that should be loaded to create the data collector set. Exch_13_16_19_Full.xml Threads Includes threads in the counter set. False","title":"New-ExPerfwiz"},{"location":"Performance/ExPerfWiz/#set-experfwiz","text":"Modifies the configuration of an existing data collector set. Switch Description Default Duration How long should the performance data be collected 08:00:00 Interval How often the performance data should be collected. 5s MaxSize Maximum size of the perfmon log in MegaBytes (256-4096) 1024Mb Name The name of the data collector set Exchange_Perfwiz Server Name of the server where the perfmon collector should be created Local Machine StartTime Daily time to start perfmon counter NA Quiet Suppress output False","title":"Set-ExPerfwiz"},{"location":"Performance/ExPerfWiz/#remove-experfwiz","text":"Removes an ExPerfwiz data collector set Switch Description Default Name Name of the Perfmon Collector set Exchange_Perfwiz Server Name of the server to remove the collector set from Local Machine","title":"Remove-ExPerfwiz"},{"location":"Performance/ExPerfWiz/#start-experfwiz","text":"Starts an ExPerfwiz data collector set Switch Description Default Name The Name of the Data Collector set to start Exchange_Perfwiz Server Name of the remote server to start the data collector set on. Local Machine","title":"Start-ExPerfwiz"},{"location":"Performance/ExPerfWiz/#stop-experfwiz","text":"Stops an ExPerfwiz data collector set Switch Description Default Name Name of the data collector set to stop. Exchange_Perfwiz Server Name of the server to stop the collector set on. Local Machine","title":"Stop-ExPerfwiz"},{"location":"Performance/ExPerfWiz/#example-usage","text":"","title":"Example Usage"},{"location":"Performance/ExPerfWiz/#default-usage-for-data-gathering","text":"New-ExPerfwiz -FolderPath C:\\experfwiz -StartOnCreate","title":"Default usage for data gathering"},{"location":"Performance/ExPerfWiz/#stop-data-collection","text":"Stop-ExPerfwiz","title":"Stop Data Collection"},{"location":"Performance/ExPerfWiz/#collect-data-from-another-server","text":"New-ExPerfwiz -FolderPath C:\\experfwiz -server RemoteExchServer","title":"Collect data from another server"},{"location":"Performance/ExPerfWiz/#collect-data-from-multiple-servers","text":"Get-ExchangeServer | Foreach {New-Experfwiz -folderpath C:\\experfwiz -startoncreate -Server $_.name}","title":"Collect data from multiple servers"},{"location":"Performance/ExPerfWiz/#important-notes","text":"The default duration is 8 hours to save on disk space meaning that the data collection will stop after 8 hours. Using -Threads should only be done if needed to troubleshoot the issue. It will SIGNIFICANTLY increase the size of the resulting perfmon files. Do not stop the log gathering thru the Perfmon GUI that can result in an unreadable log file. Always stop the data gathering with Stop-Experfwiz.","title":"Important Notes"},{"location":"Performance/SimplePerf/","text":"SimplePerf Download the latest release: SimplePerf.ps1 This script is a stripped-down and streamlined performance log collector for Exchange Server. Common Examples .\\ SimplePerf . ps1 -Start Starts a collector using Exchange counter defaults. The collector is non-circular, will run for 8 hours, has a 5-second interval, has a max file size of 1 GB, and saves the logs to C:\\SimplePerf. .\\ SimplePerf . ps1 -Start -IncludeCounters \"\\Thread\" Starts a collector using Exchange counter defaults plus all \\Thread counters. The collector is non-circular, will run for 8 hours, has a 5-second interval, has a max file size of 1 GB, and saves the logs to C:\\SimplePerf. .\\ SimplePerf . ps1 -Start -Duration 02 : 00 : 00 -Interval 30 -MaximumSizeInMB 512 -OutputFolder C :\\ PerfLogs Starts a collector using Exchange counter defaults. The collector is non-circular, will run for 2 hours, has a 30-second interval, has a max file size of 512 MB, and saves the logs to C:\\PerfLogs. .\\ SimplePerf . ps1 -Start -Duration 02 : 00 : 00 -Interval 30 -MaximumSizeInMB 1024 -Circular -OutputFolder C :\\ PerfLogs Starts a collector using Exchange counter defaults. The collector is circular, will run for 2 hours, has a 30-second interval, has a max file size of 1024 MB, and saves the logs to C:\\PerfLogs. .\\ SimplePerf . ps1 -Stop Stops a running SimplePerf. Get-ExchangeServer | .\\ SimplePerf . ps1 -Start Starts a SimplePerf with the default options on all Exchange servers. \"SRV1\" , \"SRV2\" , \"SRV3\" | .\\ SimplePerf . ps1 -Start Starts a SimplePerf with the default options on the three named servers. \"SRV1\" , \"SRV2\" , \"SRV3\" | .\\ SimplePerf . ps1 -Stop Stops a running SimplePerf on the three named servers. Using Named Collectors It is possible to run several SimplePerf collectors on the same computer at the same time by providing the -CollectorName parameter. For example: .\\ SimplePerf -Start -Interval 60 -CollectorName \"Minute\" .\\ SimplePerf -Start -Interval 5 -CollectorName \"FiveSeconds\" When using collector names, the same name must be provided to the -Stop command: .\\ SimplePerf -Stop -CollectorName \"Minute\" .\\ SimplePerf -Stop -CollectorName \"FiveSeconds\" Counter Name Filters The counters collected by SimplePerf can be controlled with a combination of three parameters: -Scenario , -IncludeCounters , and -ExcludeCounters . Currently, there are only two scenarios: Exchange and None . The Exchange scenario is a common set of counters for Exchange Server, similar to what ExPerfWiz would collect. None is a completely empty counter set. -IncludeCounters and -ExcludeCounters perform a StartsWith match against the counter name. This makes it possible to collect a large number of counters with minimal syntax. For example: .\\ SimplePerf . ps1 -Start -IncludeCounters \"\\MSExchange\" , \"\\Microsoft Exchange\" This example starts a SimplePerf using the Exchange scenario, but then it includes every counter starting with either MSExchange or Microsoft Exchange. .\\ SimplePerf . ps1 -Start -IncludeCounters \"\\MSExchange\" , \"\\Microsoft Exchange\" -Scenario \"None\" This example starts a SimplePerf collecting all the matching Exchange counters without including any default counters at all, because the None scenario was specified. .\\ SimplePerf . ps1 -Start -ExcludeCounters \"\\MSExchange Transport\" In this example, we use the Exchange scenario as a starting point, but then we remove all counters starting with MSExchange Transport. Note that individual counters can be excluded even if the counter set has been included. To illustrate: In this screenshot we see all the counters that exist for the Thread set. If we tell SimplePerf to include \"\\Thread\", then it simply collects the whole object. However, if we tell it to Include \"\\Thread\" but exclude \"\\Thread(*)\\Priority\", we see that it has correctly expanded the Thread object and is collecting all counters except \"Priority Current\" and \"Priority Base\". This filtering mechanism makes it easy to customize the counter set with minimal text. To check the result of your counter filters, add the -Verbose switch, or check the counters txt file in $env:TEMP. Note that the resulting set can only show counters that exist on the local machine. For instance, you won't see any Exchange counters in the Verbose output if the script is not running on an Exchange Server. Language Support SimplePerf works regardless of the current language. It does this by translating the provided counter filters to whatever the current server language happens to be. This means that counter names must always be provided in English, even when the current language is not English. For example, here is the same command from the earlier example running on a server where Spanish is the current language:","title":"SimplePerf"},{"location":"Performance/SimplePerf/#simpleperf","text":"Download the latest release: SimplePerf.ps1 This script is a stripped-down and streamlined performance log collector for Exchange Server.","title":"SimplePerf"},{"location":"Performance/SimplePerf/#common-examples","text":".\\ SimplePerf . ps1 -Start Starts a collector using Exchange counter defaults. The collector is non-circular, will run for 8 hours, has a 5-second interval, has a max file size of 1 GB, and saves the logs to C:\\SimplePerf. .\\ SimplePerf . ps1 -Start -IncludeCounters \"\\Thread\" Starts a collector using Exchange counter defaults plus all \\Thread counters. The collector is non-circular, will run for 8 hours, has a 5-second interval, has a max file size of 1 GB, and saves the logs to C:\\SimplePerf. .\\ SimplePerf . ps1 -Start -Duration 02 : 00 : 00 -Interval 30 -MaximumSizeInMB 512 -OutputFolder C :\\ PerfLogs Starts a collector using Exchange counter defaults. The collector is non-circular, will run for 2 hours, has a 30-second interval, has a max file size of 512 MB, and saves the logs to C:\\PerfLogs. .\\ SimplePerf . ps1 -Start -Duration 02 : 00 : 00 -Interval 30 -MaximumSizeInMB 1024 -Circular -OutputFolder C :\\ PerfLogs Starts a collector using Exchange counter defaults. The collector is circular, will run for 2 hours, has a 30-second interval, has a max file size of 1024 MB, and saves the logs to C:\\PerfLogs. .\\ SimplePerf . ps1 -Stop Stops a running SimplePerf. Get-ExchangeServer | .\\ SimplePerf . ps1 -Start Starts a SimplePerf with the default options on all Exchange servers. \"SRV1\" , \"SRV2\" , \"SRV3\" | .\\ SimplePerf . ps1 -Start Starts a SimplePerf with the default options on the three named servers. \"SRV1\" , \"SRV2\" , \"SRV3\" | .\\ SimplePerf . ps1 -Stop Stops a running SimplePerf on the three named servers.","title":"Common Examples"},{"location":"Performance/SimplePerf/#using-named-collectors","text":"It is possible to run several SimplePerf collectors on the same computer at the same time by providing the -CollectorName parameter. For example: .\\ SimplePerf -Start -Interval 60 -CollectorName \"Minute\" .\\ SimplePerf -Start -Interval 5 -CollectorName \"FiveSeconds\" When using collector names, the same name must be provided to the -Stop command: .\\ SimplePerf -Stop -CollectorName \"Minute\" .\\ SimplePerf -Stop -CollectorName \"FiveSeconds\"","title":"Using Named Collectors"},{"location":"Performance/SimplePerf/#counter-name-filters","text":"The counters collected by SimplePerf can be controlled with a combination of three parameters: -Scenario , -IncludeCounters , and -ExcludeCounters . Currently, there are only two scenarios: Exchange and None . The Exchange scenario is a common set of counters for Exchange Server, similar to what ExPerfWiz would collect. None is a completely empty counter set. -IncludeCounters and -ExcludeCounters perform a StartsWith match against the counter name. This makes it possible to collect a large number of counters with minimal syntax. For example: .\\ SimplePerf . ps1 -Start -IncludeCounters \"\\MSExchange\" , \"\\Microsoft Exchange\" This example starts a SimplePerf using the Exchange scenario, but then it includes every counter starting with either MSExchange or Microsoft Exchange. .\\ SimplePerf . ps1 -Start -IncludeCounters \"\\MSExchange\" , \"\\Microsoft Exchange\" -Scenario \"None\" This example starts a SimplePerf collecting all the matching Exchange counters without including any default counters at all, because the None scenario was specified. .\\ SimplePerf . ps1 -Start -ExcludeCounters \"\\MSExchange Transport\" In this example, we use the Exchange scenario as a starting point, but then we remove all counters starting with MSExchange Transport. Note that individual counters can be excluded even if the counter set has been included. To illustrate: In this screenshot we see all the counters that exist for the Thread set. If we tell SimplePerf to include \"\\Thread\", then it simply collects the whole object. However, if we tell it to Include \"\\Thread\" but exclude \"\\Thread(*)\\Priority\", we see that it has correctly expanded the Thread object and is collecting all counters except \"Priority Current\" and \"Priority Base\". This filtering mechanism makes it easy to customize the counter set with minimal text. To check the result of your counter filters, add the -Verbose switch, or check the counters txt file in $env:TEMP. Note that the resulting set can only show counters that exist on the local machine. For instance, you won't see any Exchange counters in the Verbose output if the script is not running on an Exchange Server.","title":"Counter Name Filters"},{"location":"Performance/SimplePerf/#language-support","text":"SimplePerf works regardless of the current language. It does this by translating the provided counter filters to whatever the current server language happens to be. This means that counter names must always be provided in English, even when the current language is not English. For example, here is the same command from the earlier example running on a server where Spanish is the current language:","title":"Language Support"},{"location":"PublicFolders/SourceSideValidations/","text":"SourceSideValidations Download the latest release: SourceSideValidations.ps1 This script performs pre-migration public folder checks for Exchange 2013, 2016, and 2019. For Exchange 2010, please use previous script found here . Syntax SourceSideValidations . ps1 [ -StartFresh < bool >] [ -SlowTraversal ] [ -ResultsFile < string >] [ -SkipVersionCheck ] [ -Tests < string []>] [< CommonParameters >] SourceSideValidations . ps1 -RemoveInvalidPermissions [ -ResultsFile < string >] [ -SkipVersionCheck ] [< CommonParameters >] SourceSideValidations . ps1 -SummarizePreviousResults [ -ResultsFile < string >] [ -SkipVersionCheck ] [< CommonParameters >] Output The script will generate the following files. Usually the only one we care about is ValidationResults.csv. The others are purely for saving time on subsequent runs. File Name Content Use IpmSubtree.csv A subset of properties of all Public Folders Running with -StartFresh $false loads this file instead of retrieving fresh data Statistics.csv EntryID, item count, and size of every folder Running with -StartFresh $false loads this file instead of retrieving fresh data NonIpmSubtree.csv A subset of properties of all System Folders Running with -StartFresh $false loads this file instead of retrieving fresh data ValidationResults.csv Information about any issues found. This is file we want to examine to understand any issues found. The script will display a summary of what it found, and in many cases it will provide an example command that uses input from this file to fix the problem. Tests The script performs the following tests. The ValidationResults.csv can be filtered by ResultType to identify the respective folders. Test Category ResultType Criteria DumpsterMapping BadDumpsterMapping DumpsterEntryId is null, or the dumpster is not in \\NON_IPM_SUBTREE\\DUMPSTER_ROOT, or the DumpsterEntryId of the dumpster does not point back to the folder. Limit ChildCount The folder has more than 10,000 direct child folders. Limit EmptyFolder The folder and all its child folders (recursive) have no items. Limit FolderPathDepth The folder path is greater than 299 folders deep. Limit HierarchyCount There are more than 250,000 total folders in the hierarchy. Limit HierarchyAndDumpsterCount There are more than 250,000 total folders if you count both the folders and their dumpsters. Limit ItemCount The folder has more than 1,000,000 items. Limit NoStatistics Get-PublicFolderStatistics did not return any statistics for these folders. ItemCount, TotalItemSize, and EmptyFolder tests were skipped. Limit TotalItemSize The items directly in this folder (not child folders) add up to more than 25 GB. MailEnabledFolder MailDisabledWithProxyGuid The folder is not mail-enabled, but it has the GUID of an Active Directory object in its MailRecipientGuid property. MailEnabledFolder MailEnabledSystemFolder The folder is a system folder, which should not be mail-enabled. MailEnabledFolder MailEnabledWithNoADOjbect The folder is mail-enabled, but it has no Active Directory object. MailEnabledFolder OrphanedMPF An Active Directory object exists, but it is not linked to any folder. MailEnabledFolder OrphanedMPFDuplicate An Active Directory object exists, but it points to a public folder which points to a different object. MailEnabledFolder OrphanedMPFDisconnected An Active Directory object exists, but it points to a public folder that is mail-disabled. FolderName SpecialCharacters Folder name contains @, /, or \\. Permission BadPermission The permission does not refer to a valid entity. Usage Typically, the script should be run with no parameters: .\\ SourceSideValidations . ps1 Progress indicators are displayed as it collects data and validates the results. The final test, which checks permissions, will usually take much longer than the other tests. When all the tests are done, the script provides a summary of what it found, along with example commands that fix some issues. In this example output, the script calls out four issues. First, it points out that we have 111,124 folders that are completely empty (this is a lab). Note the ResultType of EmptyFolder. If we want to see the list of empty folders, we can open up ValidationResults.csv in Excel, filter for a ResultType of EmptyFolder, and then we see all those results: For these folders, no action is required. The script is just giving us information. The next thing it calls out is that 4 folders have problematic characters in the name. The output tells us these have a ResultType of SpecialCharacters. Filtering for that in the CSV, we see the folders. Fortunately, the script gives us a command we can run to fix all the names. We can copy and paste the command it gave us, let it run, and then spot check the result. Now that the names are fixed, we move on to the next item. The script tells us we have a mail public folder object for a public folder that is mail-disabled. For this type of problem, we need to examine the folder and figure out what we want to do. The CSV file gives us the DN of the mail object and the entry ID of the folder, which we can use to examine the two objects. The folder says MailEnabled is False, yet we have a MailPublicFolder which points to it. We need to decide whether we want the folder to receive email or not. For this lab, I decide I do want the folder to be mail-enabled, so I remove the orphaned MailPublicFolder and then mail-enable the folder. I also confirm the new object has the same email address as the old one. This might need to be adjusted manually in some cases, but here I didn't have to. Finally, the script says we have 9,850 invalid permissions. Fortunately, this is another one that is easy to fix, as the script provides a command. This one is going to take a while. Once completed, we can rerun SourceSideValidations to make sure all the issues are resolved. If you close the shell and you need to see the summary results again, use the -SummarizePreviousResults switch. .\\ SourceSideValidations -SummarizePreviousResults The script reads the output file and repeats the instructions on what to do. You can also summarize the results from previous runs, or point to files in other locations, by providing the -ResultsFile parameter.","title":"SourceSideValidations"},{"location":"PublicFolders/SourceSideValidations/#sourcesidevalidations","text":"Download the latest release: SourceSideValidations.ps1 This script performs pre-migration public folder checks for Exchange 2013, 2016, and 2019. For Exchange 2010, please use previous script found here .","title":"SourceSideValidations"},{"location":"PublicFolders/SourceSideValidations/#syntax","text":"SourceSideValidations . ps1 [ -StartFresh < bool >] [ -SlowTraversal ] [ -ResultsFile < string >] [ -SkipVersionCheck ] [ -Tests < string []>] [< CommonParameters >] SourceSideValidations . ps1 -RemoveInvalidPermissions [ -ResultsFile < string >] [ -SkipVersionCheck ] [< CommonParameters >] SourceSideValidations . ps1 -SummarizePreviousResults [ -ResultsFile < string >] [ -SkipVersionCheck ] [< CommonParameters >]","title":"Syntax"},{"location":"PublicFolders/SourceSideValidations/#output","text":"The script will generate the following files. Usually the only one we care about is ValidationResults.csv. The others are purely for saving time on subsequent runs. File Name Content Use IpmSubtree.csv A subset of properties of all Public Folders Running with -StartFresh $false loads this file instead of retrieving fresh data Statistics.csv EntryID, item count, and size of every folder Running with -StartFresh $false loads this file instead of retrieving fresh data NonIpmSubtree.csv A subset of properties of all System Folders Running with -StartFresh $false loads this file instead of retrieving fresh data ValidationResults.csv Information about any issues found. This is file we want to examine to understand any issues found. The script will display a summary of what it found, and in many cases it will provide an example command that uses input from this file to fix the problem.","title":"Output"},{"location":"PublicFolders/SourceSideValidations/#tests","text":"The script performs the following tests. The ValidationResults.csv can be filtered by ResultType to identify the respective folders. Test Category ResultType Criteria DumpsterMapping BadDumpsterMapping DumpsterEntryId is null, or the dumpster is not in \\NON_IPM_SUBTREE\\DUMPSTER_ROOT, or the DumpsterEntryId of the dumpster does not point back to the folder. Limit ChildCount The folder has more than 10,000 direct child folders. Limit EmptyFolder The folder and all its child folders (recursive) have no items. Limit FolderPathDepth The folder path is greater than 299 folders deep. Limit HierarchyCount There are more than 250,000 total folders in the hierarchy. Limit HierarchyAndDumpsterCount There are more than 250,000 total folders if you count both the folders and their dumpsters. Limit ItemCount The folder has more than 1,000,000 items. Limit NoStatistics Get-PublicFolderStatistics did not return any statistics for these folders. ItemCount, TotalItemSize, and EmptyFolder tests were skipped. Limit TotalItemSize The items directly in this folder (not child folders) add up to more than 25 GB. MailEnabledFolder MailDisabledWithProxyGuid The folder is not mail-enabled, but it has the GUID of an Active Directory object in its MailRecipientGuid property. MailEnabledFolder MailEnabledSystemFolder The folder is a system folder, which should not be mail-enabled. MailEnabledFolder MailEnabledWithNoADOjbect The folder is mail-enabled, but it has no Active Directory object. MailEnabledFolder OrphanedMPF An Active Directory object exists, but it is not linked to any folder. MailEnabledFolder OrphanedMPFDuplicate An Active Directory object exists, but it points to a public folder which points to a different object. MailEnabledFolder OrphanedMPFDisconnected An Active Directory object exists, but it points to a public folder that is mail-disabled. FolderName SpecialCharacters Folder name contains @, /, or \\. Permission BadPermission The permission does not refer to a valid entity.","title":"Tests"},{"location":"PublicFolders/SourceSideValidations/#usage","text":"Typically, the script should be run with no parameters: .\\ SourceSideValidations . ps1 Progress indicators are displayed as it collects data and validates the results. The final test, which checks permissions, will usually take much longer than the other tests. When all the tests are done, the script provides a summary of what it found, along with example commands that fix some issues. In this example output, the script calls out four issues. First, it points out that we have 111,124 folders that are completely empty (this is a lab). Note the ResultType of EmptyFolder. If we want to see the list of empty folders, we can open up ValidationResults.csv in Excel, filter for a ResultType of EmptyFolder, and then we see all those results: For these folders, no action is required. The script is just giving us information. The next thing it calls out is that 4 folders have problematic characters in the name. The output tells us these have a ResultType of SpecialCharacters. Filtering for that in the CSV, we see the folders. Fortunately, the script gives us a command we can run to fix all the names. We can copy and paste the command it gave us, let it run, and then spot check the result. Now that the names are fixed, we move on to the next item. The script tells us we have a mail public folder object for a public folder that is mail-disabled. For this type of problem, we need to examine the folder and figure out what we want to do. The CSV file gives us the DN of the mail object and the entry ID of the folder, which we can use to examine the two objects. The folder says MailEnabled is False, yet we have a MailPublicFolder which points to it. We need to decide whether we want the folder to receive email or not. For this lab, I decide I do want the folder to be mail-enabled, so I remove the orphaned MailPublicFolder and then mail-enable the folder. I also confirm the new object has the same email address as the old one. This might need to be adjusted manually in some cases, but here I didn't have to. Finally, the script says we have 9,850 invalid permissions. Fortunately, this is another one that is easy to fix, as the script provides a command. This one is going to take a while. Once completed, we can rerun SourceSideValidations to make sure all the issues are resolved. If you close the shell and you need to see the summary results again, use the -SummarizePreviousResults switch. .\\ SourceSideValidations -SummarizePreviousResults The script reads the output file and repeats the instructions on what to do. You can also summarize the results from previous runs, or point to files in other locations, by providing the -ResultsFile parameter.","title":"Usage"},{"location":"PublicFolders/ValidateMailEnabledPublicFolders/","text":"ValidateMailEnabledPublicFolders Download the latest release: ValidateMailEnabledPublicFolders.ps1 This script performs pre-migration checks on mail-enabled folders on Exchange 2010 and up. Note that these checks are also included in the new SourceSideValidations.ps1 for 2013 and up.","title":"ValidateMailEnabledPublicFolders"},{"location":"PublicFolders/ValidateMailEnabledPublicFolders/#validatemailenabledpublicfolders","text":"Download the latest release: ValidateMailEnabledPublicFolders.ps1 This script performs pre-migration checks on mail-enabled folders on Exchange 2010 and up. Note that these checks are also included in the new SourceSideValidations.ps1 for 2013 and up.","title":"ValidateMailEnabledPublicFolders"},{"location":"Retention/Get-MRMDetails/","text":"Get-MRMDetails Download the latest release: Get-MRMDetails.ps1 This script will gather the MRM configuration for a given user. It will collect the current MRM Policy and Tags for the Exchange Organization, the current MRM Policy and Tags applied to the user, the current Exchange Diagnostics Logs for the user, and Exchange Audit logs for the mailbox selected. The resulting data will allow you to see what tags are applied to the user and when the Managed Folder Assistant has run against the user. It also will grab the Admin Audit log so that we can tell if the Tags or Polices have been modified and who modified them. To run the script, at minimum you will need a valid SMTP Address for a user. Then you can review the associated logs that are generated from the script. Syntax: .\\ Get-MRMDetails . ps1 -Mailbox < user > Example to collect the MRM Details from rob@contoso.com: .\\ Get-MRMDetails . ps1 -Mailbox rob @contoso . com","title":"Get-MRMDetails"},{"location":"Retention/Get-MRMDetails/#get-mrmdetails","text":"Download the latest release: Get-MRMDetails.ps1 This script will gather the MRM configuration for a given user. It will collect the current MRM Policy and Tags for the Exchange Organization, the current MRM Policy and Tags applied to the user, the current Exchange Diagnostics Logs for the user, and Exchange Audit logs for the mailbox selected. The resulting data will allow you to see what tags are applied to the user and when the Managed Folder Assistant has run against the user. It also will grab the Admin Audit log so that we can tell if the Tags or Polices have been modified and who modified them. To run the script, at minimum you will need a valid SMTP Address for a user. Then you can review the associated logs that are generated from the script. Syntax: .\\ Get-MRMDetails . ps1 -Mailbox < user > Example to collect the MRM Details from rob@contoso.com: .\\ Get-MRMDetails . ps1 -Mailbox rob @contoso . com","title":"Get-MRMDetails"},{"location":"Search/Troubleshoot-ModernSearch/","text":"Troubleshoot-ModernSearch Download the latest release: Troubleshoot-ModernSearch.ps1 This script is still in development. However, this should be able to quickly determine if an item is indexed or not and why it isn't indexed. Just provide the full message subject and the mailbox identity and it will dump out the information needed to determine if the message is indexed or not. Parameters Parameter Description MailboxIdentity Provide the identity of the mailbox that you wish to be looking at. If you are able to find it via Get-Mailbox it is able to be used here. ItemSubject Provide the message's subject name. Must be exact if -MatchSubjectSubstring isn't used. This includes if there is a trailing space at the end of the message subject. MatchSubjectSubstring Enable to perform a like search in the mailbox with the value that is passed with -ItemSubject . FolderName If you want to scope the search to a folder for better and faster results, include the name of the folder that the message is in. DocumentId If you already know the document ID number for the mailbox, provide this. This can not be use with -ItemSubject parameter. Category Provides a breakdown of the messages in the mailbox for that index category state. Possible options are: All , Indexed , PartiallyIndexed , NotIndexed , Corrupted , Stale , and ShouldNotBeIndexed . NOTE: Depending the item count, this can take a long while to complete. GroupMessages To group the messages by Indexing Error Message and Permanent failure state or not. By Disabling this, you get more properties displayed of the message as well. Server Provide a list of possible servers that you wish to get mailbox statistics for all the active databases on that server. SortByProperty Provide the property that you wish to have the information sorted by in the output to screen. Default is to sort by FullyIndexPercentage ExcludeFullyIndexedMailboxes When look at the multiple mailbox statistics, we don't want to view the mailboxes that are fully indexed without any indexing problems. QueryString Include a string that you are using to try to find this item, we will run an instant query against it to see if we can find it. IsArchive Enable if you want to look at the archive mailbox. IsPublicFolder Enable if you want to look at a public folder mailbox. Examples This is an example of how to run a basic query again a single item. .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity han@solo.com -ItemSubject \"Test Message\" This is an example of how to run the script when you want to query multiple items with a similar subject name. .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity \"Zelda01\" -ItemSubject \"Initial Indexing\" -MatchSubjectSubstring This is an example of how to run the script against an Archive Mailbox. .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity han@solo.com -ItemSubject \"Test Message\" -IsArchive This is an example of how to run the script against a Public Folder Mailbox .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity PFMailbox2 -ItemSubject \"My Item Test\" -IsPublicFolder This is an example of how to run the script to get all the index state categories .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity \"Zelda02\" -Category \"All\" This is an example of how to run the script to get all the non indexed items .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity \"Zelda02\" -Category \"NotIndexed\" This is an example of how to run the script to get all the active mailboxes on a server .\\Troubleshoot-ModernSearch.ps1 -Server \"Solo-E19A\"","title":"Troubleshoot-ModernSearch"},{"location":"Search/Troubleshoot-ModernSearch/#troubleshoot-modernsearch","text":"Download the latest release: Troubleshoot-ModernSearch.ps1 This script is still in development. However, this should be able to quickly determine if an item is indexed or not and why it isn't indexed. Just provide the full message subject and the mailbox identity and it will dump out the information needed to determine if the message is indexed or not.","title":"Troubleshoot-ModernSearch"},{"location":"Search/Troubleshoot-ModernSearch/#parameters","text":"Parameter Description MailboxIdentity Provide the identity of the mailbox that you wish to be looking at. If you are able to find it via Get-Mailbox it is able to be used here. ItemSubject Provide the message's subject name. Must be exact if -MatchSubjectSubstring isn't used. This includes if there is a trailing space at the end of the message subject. MatchSubjectSubstring Enable to perform a like search in the mailbox with the value that is passed with -ItemSubject . FolderName If you want to scope the search to a folder for better and faster results, include the name of the folder that the message is in. DocumentId If you already know the document ID number for the mailbox, provide this. This can not be use with -ItemSubject parameter. Category Provides a breakdown of the messages in the mailbox for that index category state. Possible options are: All , Indexed , PartiallyIndexed , NotIndexed , Corrupted , Stale , and ShouldNotBeIndexed . NOTE: Depending the item count, this can take a long while to complete. GroupMessages To group the messages by Indexing Error Message and Permanent failure state or not. By Disabling this, you get more properties displayed of the message as well. Server Provide a list of possible servers that you wish to get mailbox statistics for all the active databases on that server. SortByProperty Provide the property that you wish to have the information sorted by in the output to screen. Default is to sort by FullyIndexPercentage ExcludeFullyIndexedMailboxes When look at the multiple mailbox statistics, we don't want to view the mailboxes that are fully indexed without any indexing problems. QueryString Include a string that you are using to try to find this item, we will run an instant query against it to see if we can find it. IsArchive Enable if you want to look at the archive mailbox. IsPublicFolder Enable if you want to look at a public folder mailbox.","title":"Parameters"},{"location":"Search/Troubleshoot-ModernSearch/#examples","text":"This is an example of how to run a basic query again a single item. .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity han@solo.com -ItemSubject \"Test Message\" This is an example of how to run the script when you want to query multiple items with a similar subject name. .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity \"Zelda01\" -ItemSubject \"Initial Indexing\" -MatchSubjectSubstring This is an example of how to run the script against an Archive Mailbox. .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity han@solo.com -ItemSubject \"Test Message\" -IsArchive This is an example of how to run the script against a Public Folder Mailbox .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity PFMailbox2 -ItemSubject \"My Item Test\" -IsPublicFolder This is an example of how to run the script to get all the index state categories .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity \"Zelda02\" -Category \"All\" This is an example of how to run the script to get all the non indexed items .\\Troubleshoot-ModernSearch.ps1 -MailboxIdentity \"Zelda02\" -Category \"NotIndexed\" This is an example of how to run the script to get all the active mailboxes on a server .\\Troubleshoot-ModernSearch.ps1 -Server \"Solo-E19A\"","title":"Examples"},{"location":"Security/EOMT/","text":"Exchange On-premises Mitigation Tool (EOMT) Download the latest release: EOMT.ps1 This script contains mitigations to help address the following vulnerabilities. CVE-2021-26855 This is the most effective way to help quickly protect and mitigate your Exchange Servers prior to patching. We recommend this script over the previous ExchangeMitigations.ps1 script. The Exchange On-premises Mitigation Tool automatically downloads any dependencies and runs the Microsoft Safety Scanner. This a better approach for Exchange deployments with Internet access and for those who want an attempt at automated remediation. We have not observed any impact to Exchange Server functionality via these mitigation methods. EOMT.ps1 is completely automated and uses familiar mitigation methods previously documented. This script has four operations it performs: +NEW Check for the latest version of EOMT and download it. Mitigate against current known attacks using CVE-2021-26855 via a URL Rewrite configuration Scan the Exchange Server using the Microsoft Safety Scanner Attempt to remediate compromises detected by the Microsoft Safety Scanner. This a better approach for Exchange deployments with Internet access and for those who want an attempt at automated remediation. We have not observed any impact to Exchange Server functionality via these mitigation methods nor do these mitigation methods make any direct changes that disable features of Exchange. Use of the Exchange On-premises Mitigation Tool and the Microsoft Saftey Scanner are subject to the terms of the Microsoft Privacy Statement: https://aka.ms/privacy Requirements to run the Exchange On-premises Mitigation Tool External Internet Connection from your Exchange server (required to download the Microsoft Safety Scanner and the IIS URL Rewrite Module). PowerShell script must be run as Administrator. System Requirements PowerShell 3 or later IIS 7.5 and later Exchange 2013, 2016, or 2019 Windows Server 2008 R2, Server 2012, Server 2012 R2, Server 2016, Server 2019 +New If Operating System is older than Windows Server 2016, must have KB2999226 for IIS Rewrite Module 2.1 to work. Who should run the Exchange On-premises Mitigation Tool Situation Guidance If you have done nothing to date to patch or mitigate this issue\u2026 Run EOMT.PS1 as soon as possible.This will both attempt to remediate as well as mitigate your servers against further attacks. Once complete, follow patching guidance to update your servers on http://aka.ms/exchangevulns If you have mitigated using any/all of the mitigation guidance Microsoft has given (Exchangemitigations.Ps1, Blog post, etc..) Run EOMT.PS1 as soon as possible. This will both attempt to remediate as well as mitigate your servers against further attacks. Once complete, follow patching guidance to update your servers on http://aka.ms/exchangevulns If you have already patched your systems and are protected, but did NOT investigate for any adversary activity, indicators of compromise, etc\u2026. Run EOMT.PS1 as soon as possible. This will attempt to remediate any existing compromise that may not have been full remediated before patching. If you have already patched and investigated your systems for any indicators of compromise, etc\u2026. No action is required Important note regarding Microsoft Safety Scanner The Exchange On-premises Mitigation Tool runs the Microsoft Safety Scanner in a quick scan mode. If you suspect any compromise, we highly recommend you run it in the FULL SCAN mode. FULL SCAN mode can take a long time but if you are not running Microsoft Defender AV as your default AV, FULL SCAN will be required to remediate threats. Exchange On-premises Mitigation Tool Examples The default recommended way of using EOMT.ps1. This will determine if your server is vulnerable, mitigate if vulnerable, and run MSERT in quick scan mode. If the server is not vulnerable only MSERT quick scan will run. .\\EOMT.ps1 To run a Full MSERT Scan - We only recommend this option only if the initial quick scan discovered threats. The full scan may take hours or days to complete. .\\EOMT.ps1 -RunFullScan -DoNotRunMitigation To run the Exchange On-premises Mitigation Tool with MSERT in detect only mode - MSERT will not remediate detected threats. .\\EOMT.ps1 -DoNotRemediate To roll back the Exchange On-premises Mitigation Tool mitigations .\\EOMT.ps1 -Rollbackmitigation Note: If ExchangeMitigations.ps1 was used previously to apply mitigations, Use ExchangeMitigations.ps1 for rollback. +NEW EOMT will now autoupdate by downloading the latest version from GitHub. To prevent EOMT from fetching updates to EOMT.ps1 from the internet. .\\EOMT.ps1 -DoNotAutoUpdateEOMT Exchange On-premises Mitigation Tool Q & A Question : What mode should I run EOMT.ps1 in by default? Answer : By default, EOMT.ps1 should be run without any parameters: This will run the default mode which does the following: 1. Checks if your server is vulnerable based on the presence of the SU patch or Exchange version. 2. Downloads and installs the IIS URL rewrite tool (only if vulnerable) . 3. Applies the URL rewrite mitigation (only if vulnerable) . 4. Runs the Microsoft Safety Scanner in \"Quick Scan\" mode (vulnerable or not) . Question : What if I run a full scan and it\u2019s affecting the resources of my servers? Answer : You can terminate the process of the scan by running the following command in an Administrative PowerShell session. Stop-Process -Name msert Question : What is the real difference between this script (EOMT.PS1) and the previous script Microsoft released (ExchangeMitigations.Ps1). Answer : The Exchange On-premises Mitigation Tool was released to help pull together multiple mitigation and response steps, whereas the previous script simply enabled mitigations. Some details on what each do: EOMT.PS1 Mitigation of CVE-2021-26855 via a URL Rewrite configuration. Mitigation does not impact Exchange functionality. Malware scan of the Exchange Server via the Microsoft Safety Scanner Attempt to reverse any changes made by identified threats. ExchangeMitigations.ps1: Does mitigations for all 4 CVE\u2019s - CVE-2021-26855, CVE-2021-26857, CVE-2021-27065 & CVE-2021-26858. Some of the mitigation methods impact Exchange functionality. Does not do any scanning for existing compromise or exploitation. Does not take response actions to existing active identified threats. Question: What if I do not have an external internet connection from my Exchange server? Answer: If you do not have an external internet connection, you can still use the legacy script (ExchangeMitigations.ps1) and other steps from the mitigation blog post: Microsoft Exchange Server Vulnerabilities Mitigations \u2013 March 2021 Question: If I have already ran the mitigations previously, will the Exchange On-premises Mitigation Tool roll back any of the mitigations? Answer: No, please use the legacy script (ExchangeMitigations.ps1) to do rollback. The legacy script supports rollback for the mitigations the Exchange On-premises Mitigation Tool applied.","title":"EOMT"},{"location":"Security/EOMT/#exchange-on-premises-mitigation-tool-eomt","text":"Download the latest release: EOMT.ps1 This script contains mitigations to help address the following vulnerabilities. CVE-2021-26855 This is the most effective way to help quickly protect and mitigate your Exchange Servers prior to patching. We recommend this script over the previous ExchangeMitigations.ps1 script. The Exchange On-premises Mitigation Tool automatically downloads any dependencies and runs the Microsoft Safety Scanner. This a better approach for Exchange deployments with Internet access and for those who want an attempt at automated remediation. We have not observed any impact to Exchange Server functionality via these mitigation methods. EOMT.ps1 is completely automated and uses familiar mitigation methods previously documented. This script has four operations it performs: +NEW Check for the latest version of EOMT and download it. Mitigate against current known attacks using CVE-2021-26855 via a URL Rewrite configuration Scan the Exchange Server using the Microsoft Safety Scanner Attempt to remediate compromises detected by the Microsoft Safety Scanner. This a better approach for Exchange deployments with Internet access and for those who want an attempt at automated remediation. We have not observed any impact to Exchange Server functionality via these mitigation methods nor do these mitigation methods make any direct changes that disable features of Exchange. Use of the Exchange On-premises Mitigation Tool and the Microsoft Saftey Scanner are subject to the terms of the Microsoft Privacy Statement: https://aka.ms/privacy","title":"Exchange On-premises Mitigation Tool (EOMT)"},{"location":"Security/EOMT/#requirements-to-run-the-exchange-on-premises-mitigation-tool","text":"External Internet Connection from your Exchange server (required to download the Microsoft Safety Scanner and the IIS URL Rewrite Module). PowerShell script must be run as Administrator.","title":"Requirements to run the Exchange On-premises Mitigation Tool"},{"location":"Security/EOMT/#system-requirements","text":"PowerShell 3 or later IIS 7.5 and later Exchange 2013, 2016, or 2019 Windows Server 2008 R2, Server 2012, Server 2012 R2, Server 2016, Server 2019 +New If Operating System is older than Windows Server 2016, must have KB2999226 for IIS Rewrite Module 2.1 to work.","title":"System Requirements"},{"location":"Security/EOMT/#who-should-run-the-exchange-on-premises-mitigation-tool","text":"Situation Guidance If you have done nothing to date to patch or mitigate this issue\u2026 Run EOMT.PS1 as soon as possible.This will both attempt to remediate as well as mitigate your servers against further attacks. Once complete, follow patching guidance to update your servers on http://aka.ms/exchangevulns If you have mitigated using any/all of the mitigation guidance Microsoft has given (Exchangemitigations.Ps1, Blog post, etc..) Run EOMT.PS1 as soon as possible. This will both attempt to remediate as well as mitigate your servers against further attacks. Once complete, follow patching guidance to update your servers on http://aka.ms/exchangevulns If you have already patched your systems and are protected, but did NOT investigate for any adversary activity, indicators of compromise, etc\u2026. Run EOMT.PS1 as soon as possible. This will attempt to remediate any existing compromise that may not have been full remediated before patching. If you have already patched and investigated your systems for any indicators of compromise, etc\u2026. No action is required","title":"Who should run the Exchange On-premises Mitigation Tool"},{"location":"Security/EOMT/#important-note-regarding-microsoft-safety-scanner","text":"The Exchange On-premises Mitigation Tool runs the Microsoft Safety Scanner in a quick scan mode. If you suspect any compromise, we highly recommend you run it in the FULL SCAN mode. FULL SCAN mode can take a long time but if you are not running Microsoft Defender AV as your default AV, FULL SCAN will be required to remediate threats.","title":"Important note regarding Microsoft Safety Scanner"},{"location":"Security/EOMT/#exchange-on-premises-mitigation-tool-examples","text":"The default recommended way of using EOMT.ps1. This will determine if your server is vulnerable, mitigate if vulnerable, and run MSERT in quick scan mode. If the server is not vulnerable only MSERT quick scan will run. .\\EOMT.ps1 To run a Full MSERT Scan - We only recommend this option only if the initial quick scan discovered threats. The full scan may take hours or days to complete. .\\EOMT.ps1 -RunFullScan -DoNotRunMitigation To run the Exchange On-premises Mitigation Tool with MSERT in detect only mode - MSERT will not remediate detected threats. .\\EOMT.ps1 -DoNotRemediate To roll back the Exchange On-premises Mitigation Tool mitigations .\\EOMT.ps1 -Rollbackmitigation Note: If ExchangeMitigations.ps1 was used previously to apply mitigations, Use ExchangeMitigations.ps1 for rollback. +NEW EOMT will now autoupdate by downloading the latest version from GitHub. To prevent EOMT from fetching updates to EOMT.ps1 from the internet. .\\EOMT.ps1 -DoNotAutoUpdateEOMT","title":"Exchange On-premises Mitigation Tool Examples"},{"location":"Security/EOMT/#exchange-on-premises-mitigation-tool-q-a","text":"Question : What mode should I run EOMT.ps1 in by default? Answer : By default, EOMT.ps1 should be run without any parameters: This will run the default mode which does the following: 1. Checks if your server is vulnerable based on the presence of the SU patch or Exchange version. 2. Downloads and installs the IIS URL rewrite tool (only if vulnerable) . 3. Applies the URL rewrite mitigation (only if vulnerable) . 4. Runs the Microsoft Safety Scanner in \"Quick Scan\" mode (vulnerable or not) . Question : What if I run a full scan and it\u2019s affecting the resources of my servers? Answer : You can terminate the process of the scan by running the following command in an Administrative PowerShell session. Stop-Process -Name msert Question : What is the real difference between this script (EOMT.PS1) and the previous script Microsoft released (ExchangeMitigations.Ps1). Answer : The Exchange On-premises Mitigation Tool was released to help pull together multiple mitigation and response steps, whereas the previous script simply enabled mitigations. Some details on what each do:","title":"Exchange On-premises Mitigation Tool Q &amp; A"},{"location":"Security/EOMT/#eomtps1","text":"Mitigation of CVE-2021-26855 via a URL Rewrite configuration. Mitigation does not impact Exchange functionality. Malware scan of the Exchange Server via the Microsoft Safety Scanner Attempt to reverse any changes made by identified threats.","title":"EOMT.PS1"},{"location":"Security/EOMT/#exchangemitigationsps1","text":"Does mitigations for all 4 CVE\u2019s - CVE-2021-26855, CVE-2021-26857, CVE-2021-27065 & CVE-2021-26858. Some of the mitigation methods impact Exchange functionality. Does not do any scanning for existing compromise or exploitation. Does not take response actions to existing active identified threats. Question: What if I do not have an external internet connection from my Exchange server? Answer: If you do not have an external internet connection, you can still use the legacy script (ExchangeMitigations.ps1) and other steps from the mitigation blog post: Microsoft Exchange Server Vulnerabilities Mitigations \u2013 March 2021 Question: If I have already ran the mitigations previously, will the Exchange On-premises Mitigation Tool roll back any of the mitigations? Answer: No, please use the legacy script (ExchangeMitigations.ps1) to do rollback. The legacy script supports rollback for the mitigations the Exchange On-premises Mitigation Tool applied.","title":"ExchangeMitigations.ps1:"},{"location":"Security/EOMTv2/","text":"Exchange On-premises Mitigation Tool v2 (EOMTv2) NOTE: The vulnerability has been addressed with the November 2022 Exchange Server Security Updates . The mitigation is no longer required once the update has been installed. You can rollback the mitigation as described in the Exchange On-premises Mitigation Tool v2 Examples section. Download the latest release: EOMTv2.ps1 The Exchange On-premises Mitigation Tool v2 script (EOMTv2.ps1) can be used to mitigate CVE-2022-41040 . This script does the following: Check for the latest version of EOMTv2.ps1 and download it. Mitigate against current known attacks using CVE-2022-41040 via a URL Rewrite configuration Use of the Exchange On-premises Mitigation Tool v2 is subject to the terms of the Microsoft Privacy Statement: https://aka.ms/privacy Requirements to run the Exchange On-premises Mitigation Tool v2 PowerShell 3 or later PowerShell script must be run as Administrator. IIS 7.5 and later Exchange 2013 Client Access Server role, Exchange 2016 Mailbox role, or Exchange 2019 Mailbox role Windows Server 2008 R2, Server 2012, Server 2012 R2, Server 2016, Server 2019 If Operating System is older than Windows Server 2016, must have KB2999226 for IIS Rewrite Module 2.1 to work. [Optional] External Internet Connection from your Exchange server (required to update the script and install IIS URL rewrite module). NOTE: The script has to be executed individually for each server. Exchange On-premises Mitigation Tool v2 Examples The default recommended way of using EOMTv2.ps1. This will apply the URL rewrite mitigation. If IIS URL rewrite module is not installed, this will also download and install the module. .\\ EOMTv2 . ps1 To roll back EOMTv2 mitigations run .\\ EOMTv2 . ps1 -Rollbackmitigation","title":"EOMTv2"},{"location":"Security/EOMTv2/#exchange-on-premises-mitigation-tool-v2-eomtv2","text":"NOTE: The vulnerability has been addressed with the November 2022 Exchange Server Security Updates . The mitigation is no longer required once the update has been installed. You can rollback the mitigation as described in the Exchange On-premises Mitigation Tool v2 Examples section. Download the latest release: EOMTv2.ps1 The Exchange On-premises Mitigation Tool v2 script (EOMTv2.ps1) can be used to mitigate CVE-2022-41040 . This script does the following: Check for the latest version of EOMTv2.ps1 and download it. Mitigate against current known attacks using CVE-2022-41040 via a URL Rewrite configuration Use of the Exchange On-premises Mitigation Tool v2 is subject to the terms of the Microsoft Privacy Statement: https://aka.ms/privacy","title":"Exchange On-premises Mitigation Tool v2 (EOMTv2)"},{"location":"Security/EOMTv2/#requirements-to-run-the-exchange-on-premises-mitigation-tool-v2","text":"PowerShell 3 or later PowerShell script must be run as Administrator. IIS 7.5 and later Exchange 2013 Client Access Server role, Exchange 2016 Mailbox role, or Exchange 2019 Mailbox role Windows Server 2008 R2, Server 2012, Server 2012 R2, Server 2016, Server 2019 If Operating System is older than Windows Server 2016, must have KB2999226 for IIS Rewrite Module 2.1 to work. [Optional] External Internet Connection from your Exchange server (required to update the script and install IIS URL rewrite module). NOTE: The script has to be executed individually for each server.","title":"Requirements to run the Exchange On-premises Mitigation Tool v2"},{"location":"Security/EOMTv2/#exchange-on-premises-mitigation-tool-v2-examples","text":"The default recommended way of using EOMTv2.ps1. This will apply the URL rewrite mitigation. If IIS URL rewrite module is not installed, this will also download and install the module. .\\ EOMTv2 . ps1 To roll back EOMTv2 mitigations run .\\ EOMTv2 . ps1 -Rollbackmitigation","title":"Exchange On-premises Mitigation Tool v2 Examples"},{"location":"Security/ExchangeExtendedProtectionManagement/","text":"ExchangeExtendedProtectionManagement Download the latest release: ExchangeExtendedProtectionManagement.ps1 The Exchange Extended Protection Management is a script to help automate the Extended Protection feature on the Windows Authentication Module on Exchange Servers. Prior to configuration, it validates that all servers that we are trying to enable Extended Protection on and the servers that already have Extended Protection enabled have the same TLS settings and other prerequisites that are required for Extended Protection to be enabled successfully. Requirements The user must be in Organization Management and must run this script from an elevated Exchange Management Shell (EMS) command prompt. How To Run Examples: This syntax enables Extended Protection on all Exchange Servers that are online that we can reach. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 This syntax enables Extended Protection on only the Exchange Servers specified in the -ExchangeServerNames parameter. However, TLS checks will still occur against all servers, and the script will confirm that the TLS settings are correct on all servers with Extended Protection enabled and all servers specified in the -ExchangeServerNames parameter. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -ExchangeServerNames < Array_of_Server_Names > This syntax enables Extended Protection on all Exchange Servers that are online that we can reach, excluding any servers specified in the -SkipExchangeServerNames parameter. As above, TLS checks will still occur against all servers, and the script will confirm that the TLS settings are correct on all servers with Extended Protection enabled and all servers being enabled. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -SkipExchangeServerNames < Array_of_Server_Names > This syntax collects the possible IP addresses to be used for the IP restriction for a virtual directory. Plus the location to store the file. NOTE: This is only to assist you with the IP collections. You must verify the list to make sure it is accurate and contains all the required IP addresses. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -FindExchangeServerIPAddresses -OutputFilePath \"C:\\temp\\ExchangeIPs.txt\" This syntax will enable Extended Protection for all virtual directories and set EWS Backend virtual directory to None and then proceed to set IP restriction for the EWS Backend virtual directory for all servers online, while providing the IP address list. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -RestrictType \"EWSBackend\" -IPRangeFilePath \"C:\\temp\\ExchangeIPs.txt\" This syntax will verify the IP restrictions for the EWS Backend virtual directory. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -ValidateType \"RestrictTypeEWSBackend\" -IPRangeFilePath \"C:\\temp\\ExchangeIPs.txt\" This syntax rolls back the Extended Protection configuration for all the Exchange Servers that are online where Extended Protection was previously configured. NOTE: This is done by restoring the applicationHost.config file back to the previous state before Extended Protection was configured. If other changes occurred after this configuration, those changes will be lost. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -RollbackType \"RestoreIISAppConfig\" This syntax rolls back the Extended Protection mitigation of IP restriction for the EWS Backend virtual directory of all the Exchange Server that are online where Extended Protection was previously configured. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -RollbackType \"RestrictTypeEWSBackend\" This syntax displays the current Extended Protection configuration for all the Exchange Servers that are online. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -ShowExtendedProtection Parameters Parameter Description ExchangeServerNames A list of servers to pass that you want to run the script against. This can be used for configuration or rollback. SkipExchangeServerNames A list of server to pass that you don't want to execute the script for configuration or rollback. ShowExtendedProtection Show the current configuration of Extended Protection for the passed server list. FindExchangeServerIPAddresses Use this to collect a list of the Exchange Server IPs that should be used for IP Restriction. OutputFilePath Is a custom file path to be used to export the list of Exchange Server IPs collected from FindExchangeServerIPAddresses . Default value is the local location IPList.txt . IPRangeFilePath Is the path to the file that contains all the IP Addresses or subnets that are needed to be in the IP Allow list for Mitigation. RestrictType To enable a IP Restriction on a virtual directory. Must be used with IPRangeFilePath . The following values are allowed: EWSBackend ValidateType To verify if the IP Restrictions have been applied correctly. Must be used with IPRangeFilePath . The following values are allowed: RestrictTypeEWSBackend RollbackType Using this parameter will allow you to rollback using the type you specified. The following values are allowed: RestoreIISAppConfig , RestrictTypeEWSBackend SkipAutoUpdate Skips over the Auto Update feature to download the latest version of the script.","title":"ExchangeExtendedProtectionManagement"},{"location":"Security/ExchangeExtendedProtectionManagement/#exchangeextendedprotectionmanagement","text":"Download the latest release: ExchangeExtendedProtectionManagement.ps1 The Exchange Extended Protection Management is a script to help automate the Extended Protection feature on the Windows Authentication Module on Exchange Servers. Prior to configuration, it validates that all servers that we are trying to enable Extended Protection on and the servers that already have Extended Protection enabled have the same TLS settings and other prerequisites that are required for Extended Protection to be enabled successfully.","title":"ExchangeExtendedProtectionManagement"},{"location":"Security/ExchangeExtendedProtectionManagement/#requirements","text":"The user must be in Organization Management and must run this script from an elevated Exchange Management Shell (EMS) command prompt.","title":"Requirements"},{"location":"Security/ExchangeExtendedProtectionManagement/#how-to-run","text":"","title":"How To Run"},{"location":"Security/ExchangeExtendedProtectionManagement/#examples","text":"This syntax enables Extended Protection on all Exchange Servers that are online that we can reach. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 This syntax enables Extended Protection on only the Exchange Servers specified in the -ExchangeServerNames parameter. However, TLS checks will still occur against all servers, and the script will confirm that the TLS settings are correct on all servers with Extended Protection enabled and all servers specified in the -ExchangeServerNames parameter. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -ExchangeServerNames < Array_of_Server_Names > This syntax enables Extended Protection on all Exchange Servers that are online that we can reach, excluding any servers specified in the -SkipExchangeServerNames parameter. As above, TLS checks will still occur against all servers, and the script will confirm that the TLS settings are correct on all servers with Extended Protection enabled and all servers being enabled. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -SkipExchangeServerNames < Array_of_Server_Names > This syntax collects the possible IP addresses to be used for the IP restriction for a virtual directory. Plus the location to store the file. NOTE: This is only to assist you with the IP collections. You must verify the list to make sure it is accurate and contains all the required IP addresses. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -FindExchangeServerIPAddresses -OutputFilePath \"C:\\temp\\ExchangeIPs.txt\" This syntax will enable Extended Protection for all virtual directories and set EWS Backend virtual directory to None and then proceed to set IP restriction for the EWS Backend virtual directory for all servers online, while providing the IP address list. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -RestrictType \"EWSBackend\" -IPRangeFilePath \"C:\\temp\\ExchangeIPs.txt\" This syntax will verify the IP restrictions for the EWS Backend virtual directory. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -ValidateType \"RestrictTypeEWSBackend\" -IPRangeFilePath \"C:\\temp\\ExchangeIPs.txt\" This syntax rolls back the Extended Protection configuration for all the Exchange Servers that are online where Extended Protection was previously configured. NOTE: This is done by restoring the applicationHost.config file back to the previous state before Extended Protection was configured. If other changes occurred after this configuration, those changes will be lost. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -RollbackType \"RestoreIISAppConfig\" This syntax rolls back the Extended Protection mitigation of IP restriction for the EWS Backend virtual directory of all the Exchange Server that are online where Extended Protection was previously configured. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -RollbackType \"RestrictTypeEWSBackend\" This syntax displays the current Extended Protection configuration for all the Exchange Servers that are online. PS C :\\> .\\ ExchangeExtendedProtectionManagement . ps1 -ShowExtendedProtection","title":"Examples:"},{"location":"Security/ExchangeExtendedProtectionManagement/#parameters","text":"Parameter Description ExchangeServerNames A list of servers to pass that you want to run the script against. This can be used for configuration or rollback. SkipExchangeServerNames A list of server to pass that you don't want to execute the script for configuration or rollback. ShowExtendedProtection Show the current configuration of Extended Protection for the passed server list. FindExchangeServerIPAddresses Use this to collect a list of the Exchange Server IPs that should be used for IP Restriction. OutputFilePath Is a custom file path to be used to export the list of Exchange Server IPs collected from FindExchangeServerIPAddresses . Default value is the local location IPList.txt . IPRangeFilePath Is the path to the file that contains all the IP Addresses or subnets that are needed to be in the IP Allow list for Mitigation. RestrictType To enable a IP Restriction on a virtual directory. Must be used with IPRangeFilePath . The following values are allowed: EWSBackend ValidateType To verify if the IP Restrictions have been applied correctly. Must be used with IPRangeFilePath . The following values are allowed: RestrictTypeEWSBackend RollbackType Using this parameter will allow you to rollback using the type you specified. The following values are allowed: RestoreIISAppConfig , RestrictTypeEWSBackend SkipAutoUpdate Skips over the Auto Update feature to download the latest version of the script.","title":"Parameters"},{"location":"Security/ExchangeMitigations/","text":"ExchangeMitigations Download the latest release: ExchangeMitigations.ps1 This script contains 4 mitigations to help address the following vulnerabilities: CVE-2021-26855 CVE-2021-26857 CVE-2021-27065 CVE-2021-26858 For more information on each mitigation please visit https://aka.ms/exchangevulns This should only be used as a temporary mitigation until your Exchange Servers can be fully patched, recommended guidance is to apply all of the mitigations at once. For this script to work you must have the IIS URL Rewrite Module installed which can be done via this script using the -FullPathToMSI parameter. For IIS 10 and higher URL Rewrite Module 2.1 must be installed, you can download version 2.1 here: x86 & x64 -https://www.iis.net/downloads/microsoft/url-rewrite For IIS 8.5 and lower Rewrite Module 2.0 must be installed, you can download version 2.0 here: x86 - https://www.microsoft.com/en-us/download/details.aspx?id=5747 x64 - https://www.microsoft.com/en-us/download/details.aspx?id=7435 Installing URL Rewrite version 2.1 on IIS versions 8.5 and lower may cause IIS and Exchange to become unstable. If there is a mismatch between the URL Rewrite module and IIS version, ExchangeMitigations.ps1 will not apply the mitigation for CVE-2021-26855. You must uninstall the URL Rewrite module and reinstall the correct version. Script requires PowerShell 3.0 and later and must be executed from an elevated PowerShell Session. Download the latest release here: Download ExchangeMitigations.ps1 To apply all mitigations with MSI install .\\ExchangeMitigations.ps1 -FullPathToMSI \"FullPathToMSI\" -WebSiteNames \"Default Web Site\" -ApplyAllMitigations To apply all mitigations without MSI install .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -ApplyAllMitigations -Verbose To rollback all mitigations .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -RollbackAllMitigation To apply multiple or specific mitigations (out of the 4) .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -ApplyECPAppPoolMitigation -ApplyOABAppPoolMitigation To rollback multiple or specific mitigations .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -RollbackECPAppPoolMitigation -RollbackOABAppPoolMitigation","title":"ExchangeMitigations"},{"location":"Security/ExchangeMitigations/#exchangemitigations","text":"Download the latest release: ExchangeMitigations.ps1 This script contains 4 mitigations to help address the following vulnerabilities: CVE-2021-26855 CVE-2021-26857 CVE-2021-27065 CVE-2021-26858 For more information on each mitigation please visit https://aka.ms/exchangevulns This should only be used as a temporary mitigation until your Exchange Servers can be fully patched, recommended guidance is to apply all of the mitigations at once. For this script to work you must have the IIS URL Rewrite Module installed which can be done via this script using the -FullPathToMSI parameter. For IIS 10 and higher URL Rewrite Module 2.1 must be installed, you can download version 2.1 here: x86 & x64 -https://www.iis.net/downloads/microsoft/url-rewrite For IIS 8.5 and lower Rewrite Module 2.0 must be installed, you can download version 2.0 here: x86 - https://www.microsoft.com/en-us/download/details.aspx?id=5747 x64 - https://www.microsoft.com/en-us/download/details.aspx?id=7435 Installing URL Rewrite version 2.1 on IIS versions 8.5 and lower may cause IIS and Exchange to become unstable. If there is a mismatch between the URL Rewrite module and IIS version, ExchangeMitigations.ps1 will not apply the mitigation for CVE-2021-26855. You must uninstall the URL Rewrite module and reinstall the correct version. Script requires PowerShell 3.0 and later and must be executed from an elevated PowerShell Session. Download the latest release here: Download ExchangeMitigations.ps1 To apply all mitigations with MSI install .\\ExchangeMitigations.ps1 -FullPathToMSI \"FullPathToMSI\" -WebSiteNames \"Default Web Site\" -ApplyAllMitigations To apply all mitigations without MSI install .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -ApplyAllMitigations -Verbose To rollback all mitigations .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -RollbackAllMitigation To apply multiple or specific mitigations (out of the 4) .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -ApplyECPAppPoolMitigation -ApplyOABAppPoolMitigation To rollback multiple or specific mitigations .\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" -RollbackECPAppPoolMitigation -RollbackOABAppPoolMitigation","title":"ExchangeMitigations"},{"location":"Security/Extended-Protection/","text":"Exchange Server Support for Windows Extended Protection Overview Windows Extended Protection enhances the existing authentication in Windows Server and mitigates authentication relay or \"man in the middle\" (MitM) attacks. This mitigation is accomplished by using security information that is implemented through Channel-binding information specified through a Channel Binding Token (CBT) which is primarily used for SSL connections. Windows Extended Protection is supported on Exchange Server 2013, 2016 and 2019 starting with the August 2022 Exchange Server Security Update (SU) releases . While Extended Protection can be enabled on each virtual directory manually, we have provided a script that can help you accomplish this in bulk. Windows Extended Protection is supported on Exchange Server 2013, 2016 and 2019 starting with the August 2022 Exchange Server Security Update (SU) releases . Terminology used in this document Virtual Directory, or vDir, is used by Exchange Server to allow access to web applications such as Exchange ActiveSync, Outlook on the Web, and the Autodiscover service. Several virtual directory settings can be configured by an admin, including authentication, security, and reporting settings. Extended Protection is one such authentication setting. The Extended Protection setting controls the behavior for checking of CBTs. Possible values for this setting are listed in the following table: Extended Protection Setting Description None Specifies that IIS will not perform CBT checking. Allow Specifies that CBT checking is enabled, but not required. This setting allows secure communication with clients that support extended protection, and still supports clients that are not capable of using extended protection. Require This value specifies that CBT checking is required. This setting blocks clients that do not support extended protection. SSL Flags : Configuration of SSL settings is required to ensure that clients connect to IIS virtual directories in a specific way with client certificates. To enable Extended Protection, the required SSL flags are SSL and SSL128. SSL offloading terminates the connection on a device between the client and the Exchange Server and then uses a non-encrypted connection to connect to the Exchange Server. Example: flowchart LR A[Client] ==>|HTTPS| B B[\"Device (e.g., Load Balancer) terminates the connection\"] ==>|HTTP| C[\"Web Server\"] SSL bridging is a process where a device, usually located at the edge of a network, decrypts SSL traffic, and then re-encrypts it before sending it on to the Web server. Example: flowchart LR A[Client] ==>|HTTPS| B B[\"Device (e.g., Load Balancer) terminates the connection\"] ==>|HTTPS| C[\"Web Server\"] Modern Hybrid or Hybrid Agent is a mode of configuring Exchange Hybrid that removes some of the configuration requirements for Classic Hybrid (like Inbound network connections through your firewall) to enable Exchange hybrid features. You can learn more about this here . Public Folders are designed for shared access and to help make content in a deep hierarchy easier to browse. You can learn more about Public Folders here . Prerequisites for enabling Extended Protection on Exchange servers Make sure you are on the correct versions Extended Protection is supported on Exchange Server 2013 CU23 and Exchange Server 2016 CU22 and Exchange Server 2019 CU11 or later with the August 2022 Security Updates installed. If your organization has Exchange Server 2016 or Exchange Server 2019 installed, it must be running either the September 2021 Quarterly Exchange Updates (CU) with the August 2022 Security Update (SU) or later installed or the 2022 H1 Cumulative Update (CU) with the August 2022 Security Update (SU) or later installed. If your organization has Exchange Server 2013 installed, it must be running CU23 with the August 2022 SU (or later) installed. You must ensure all your Exchange servers are on the required CU and have the August 2022 SU (or later) before you proceed further. Extended Protection cannot be enabled on Exchange Server 2013 servers with Public Folders in a coexistence environment To enable Extended Protection on Exchange Server 2013, ensure you do not have any Public Folders on Exchange Server 2013. If you have coexistence of Exchange Server 2013 with Exchange Server 2016 or Exchange Server 2019, you must migrate your Public Folders to 2016 or 2019 before enabling Extended Protection. After enabling Extended Protection, if there are Public Folders on Exchange 2013, they will no longer appear to end users. Extended Protection cannot be enabled on Exchange Server 2016 CU22 or Exchange Server 2019 CU11 or older that hosts a Public Folder Hierarchy If you have an environment containing Exchange Server 2016 CU22 or Exchange Server 2019 CU11 or older and are utilizing Public Folders, before enabling extended protection you must confirm the version of the server hosting the Public Folder hierarchy . Ensure the server hosting the Public Folder hierarchy is upgraded to Exchange Server 2016 CU23 or Exchange Server 2019 CU12 with the latest Security Updates or move the hierarchy to one with these latest versions and updates. The following table should help clarify: Exchange version CU installed SU installed Hosts PF mailboxes Is EP supported? Exchange 2013 CU23 Aug 2022 (or higher) No Yes Exchange 2016 CU22 Aug 2022 (or higher) No hierarchy mailboxes Yes Exchange 2016 CU23+ (2022 H1) Aug 2022 (or higher) Any Yes Exchange 2019 CU11 Aug 2022 (or higher) No hierarchy mailboxes Yes Exchange 2019 CU12+ (2022 H1) Aug 2022 (or higher) Any Yes Any other version Any other CU Any other SU Any No Extended Protection does not work with hybrid servers using Modern Hybrid configuration Extended Protection cannot be enabled on Hybrid Servers which uses Modern Hybrid configuration. In Modern Hybrid configuration, Hybrid Server are published to Exchange Online via Hybrid Agent which proxies the Exchange Online call to Exchange Server. Enabling Extended Protection on Hybrid servers using Modern Hybrid configuration will lead to disruption of hybrid features like mailbox migrations and Free/Busy. Hence, it is important to identify all the Hybrid Servers in the organization published via Hybrid Agent and not enable Extended Protection specifically on these servers. Identifying hybrid Exchange servers published using Hybrid Agent Note: This step is not required if you are using classic Hybrid configuration. In case you don\u2019t have a list of servers published via Hybrid Agent, you can use the following steps to identify them: Log into a machine where the Hybrid Agent is installed and running. Open the PowerShell module of the Hybrid Agent and run Get-HybridApplication to identify the TargetUri used by the Hybrid Agent. The TargetUri parameter gives you the FQDN of the Exchange Server that is configured to use Hybrid Agent. Deduce the Exchange Server identity using the FQDN and make a note of this Exchange Server. If you are using a Load Balancer URL in TargetUri , you need to identify all the Exchange servers running the Client Access role behind the load balancer URL. Extended Protection should not be enabled for hybrid servers that are published using Hybrid Agent . You need to identify these hybrid servers and ensure you skip enabling Extended Protection on them using the SkipExchangeServerNames parameter of the script. Steps to safeguard hybrid servers using Modern Hybrid Inbound connections to Exchange servers in a Modern Hybrid configuration should be restricted via firewall to allow connections only from Hybrid Agent machines. No mailboxes should be hosted on the hybrid server, and if any mailbox exists, they should be migrated to other mailbox servers. You can enable Extended Protection on all virtual directories except Front End EWS on the hybrid Exchange server. Note: Specifically skipping extended protection on Front End EWS of Exchange Server is not supported via script. So, you would need to change this setting manually. NTLMv1 is not supported when Extended Protection is enabled Note: To increase security, we recommend that you review and configure this setting regardless of whether you experience problems or not. NTLMv1 is weak and doesn't provide protection against man-in-the-middle (MitM) attacks. It should be considered as vulnerable and so, no longer be used. Therefore NTLMv1 should not be used together with Extended Protection. Additionally, if you enforce a client to use NTLMv1 instead of NTLMv2 and you have Extended Protection enabled on your Exchange server, this will lead to password prompts on the client side without a way to authenticate successfully against Exchange. If you experience password prompts on your clients once Extended Protection is enabled, you should check the following registry key and value on client and Exchange server side: Registry key: HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Lsa Registry value: LmCompatibilityLevel It must be set to at least 3 or higher (best practice is to set it to 5 which is: Send NTLMv2 response only. Refuse LM & NTLM ). It's also possible to delete this value to enforce the system default. If it's not set, we treat it as if it is set to 3 (on Windows Server 2008 R2 and later) which is: Send NTLMv2 response only . If you want to manage the setting centrally, you can do so via Group Policy: Policy location: Computer Configuration\\Windows Settings\\Security Settings\\Local Policies\\Security Options More information: Network security: LAN Manager authentication level SSL Offloading scenarios are not supported Extended Protection is not supported in environments that use SSL offloading. SSL termination during SSL offloading causes Extended Protection to fail. To enable Extended Protection in your Exchange environment, you must not be using SSL offloading with your Load Balancers. SSL Bridging supported scenarios Extended Protection is supported in environments that use SSL Bridging under certain conditions. To enable Extended Protection in your Exchange environment using SSL Bridging, you must use the same SSL certificate on Exchange and your Load Balancers . If not this will cause Extended Protection to fail. TLS configuration must be consistent across all Exchange servers Before enabling Extended Protection, you must ensure that all TLS configurations are consistent across all Exchange servers. For example, if one of the servers uses TLS 1.2, you must ensure that all the servers in the organization are configured using TLS 1.2. Any variation in TLS version use across servers can cause client connections to fail. In addition to this, the value of SchUseStrongCrypto registry value must be set to 1 across all the Exchange Servers in the organization. If this value is not explicitly set to 1, the default value of this key may be interpreted as 0 or 1 depending on the .NET version in use by the Exchange binaries. The same applies to the SystemDefaultTlsVersions registry value which must also be explicitly set to 1. If they aren't set as expected, this can cause TLS mismatch and so, leading to client connectivity issues. Please refer to this guide to configure the required TLS settings on your Exchange servers. Third-party software compatibility Please ensure to test all third-party products in your Exchange Server environment to ensure that they work properly when Extended Protection is enabled. For example we have seen AntiVirus solutions send connections through a proxy in order to protect the client machine, this would prevent communication to the Exchange Server and would need to be disabled. Enabling Extended Protection Extended Protection can be enabled manually through IIS Manager or via a script (strongly recommended). To correctly configure Extended Protection, each virtual directory on all Exchange servers in the organization (excluding Edge Transport servers) should be set to prescribed value of Extended Protection as well as sslFlags. The following table summarizes the settings needed for each virtual directory on the supported versions of Microsoft Exchange. Enabling Extended Protection involves making many changes on all Exchange servers, so we strongly recommend using the ExchangeExtendedProtectionManagement.ps1 script that can be downloaded from https://aka.ms/ExchangeEPScript . IIS Website Virtual Directory Recommended Extended Protection Recommended sslFlags Default Website API Required Ssl,Ssl128 Default Website AutoDiscover Off Ssl,Ssl128 Default Website ECP Required Ssl,Ssl128 Default Website EWS Accept (UI) /Allow (Script) Ssl,Ssl128 Default Website MAPI Required Ssl,Ssl128 Default Website Microsoft-Server-ActiveSync Accept (UI) /Allow (Script) Ssl,Ssl128 Default Website OAB Required Ssl,Ssl128 Default Website OWA Required Ssl,Ssl128 Default Website PowerShell Required SslNegotiateCert Default Website RPC Required Ssl,Ssl128 Exchange Backend API Required Ssl,Ssl128 Exchange Backend AutoDiscover Off Ssl,Ssl128 Exchange Backend ECP Required Ssl,Ssl128 Exchange Backend EWS Required Ssl,Ssl128 Exchange Backend Microsoft-Server-ActiveSync Required Ssl,Ssl128 Exchange Backend OAB Required Ssl,Ssl128 Exchange Backend OWA Required Ssl,Ssl128 Exchange Backend PowerShell Required Ssl,SslNegotiateCert,Ssl128 Exchange Backend RPC Required Ssl,Ssl128 Exchange Backend PushNotifications Required Ssl,Ssl128 Exchange Backend RPCWithCert Required Ssl,Ssl128 Exchange Backend MAPI/emsmdb Required Ssl,Ssl128 Exchange Backend MAPI/nspi Required Ssl,Ssl128 SSL offloading for Outlook Anywhere is enabled by default and must be disabled for extended protection by following the steps shown here . Enabling Extended Protection using the script Before enabling Extended Protection in your Exchange environment, ensure you meet all the prerequisites listed in this document. To enable Extended Protection on all your Exchange Servers, you can use the ExchangeExtendedProtectionManagement.ps1 script, which is hosted on the Microsoft Exchange-CSS repository on GitHub. It\u2019s not required to run the script directly on any specific Exchange Server in your environment. Just copy it to a machine that has the Exchange Management Shell (EMS) installed. Note: Over time, we will be updating the script and documentation. The script will attempt to auto-update when it is run. If the computer where the script is run is not connected to the Internet, this update check will fail. You should always check for the latest version of the script before running it. Parameters If the script is executed without any parameters, it will enable Extended Protection on any Exchange Server that can be reached from the machine where the script was run. You can use the following parameters to specify the scope of script operations: Parameter Usage ExchangeServerNames Used to specify which Exchange servers should be included in the scope of script execution . It can be either a single Exchange server hostname or a comma separated list of hostnames. Parameter values: Exchange Server Hostname (NetBIOS or FQDN) SkipExchangeServerNames Used to specify which Exchange servers should be excluded from the scope of script execution . It can be either a single Exchange Server hostname or a comma separated list of hostnames. Parameter values: Exchange Server Hostname (NetBIOS or FQDN) RollbackType Used to revert changes made by the Extended Protection script. Parameter Values: \"RestoreIISAppConfig, RestrictTypeEWSBackend\" \" ShowExtendedProtection Used to display the current Extended Protection configuration state in your organization or on a specific computer (use the ExchangeServerNames or SkipExchangeServerNames parameter to show the configuration for a subset of Exchange servers). RestrictType Used to restrict incoming IP connections on specified vDir Parameter Value: EWSBackend : This parameter should be used to restrict incoming IP connections to a specified allow list of IP addresses or Subnets. This will also turn off EP on EWSBackend. Note: This parameter should only be used if automated archiving via retention tags is enabled in the Exchange environment. IPRangeFilePath This is a mandatory parameter which must be used to provide an allow list of IP ranges when RestrictType parameter is used. The filepath provides should be of a .TXT file with IP addresses or subnets. ValidateType Used to cross check allow list of IP addresses on vDir against IPList file provided in IPRangeFilePath. Parameter Value: RestrictTypeEWSBackend : should be used to cross check allow list of IP addresses on EWS Backend vDir against IPList file provided in IPRangeFilePath. FindExchangeServerIPAddresses Used to create list of IPv4 and IPv6 addresses of all Exchange Servers in the organization. Enabling Extended Protection on all Exchange servers After copying the script to a suitable machine, create a directory to store the script and move the script there. Then open the Exchange Management Shell (EMS) and go to the respective directory where the script is stored. Make sure that the account you are using is a member of the Organization Management role group. Execute the script as follows: .\\ExchangeExtendedProtectionManagement.ps1 In case that you have Modern Hybrid configuration, you need to skip Exchange servers published using the Hybrid Agent. This can be done by using the SkipExchangeServerNames parameter: .\\ExchangeExtendedProtectionManagement.ps1 -SkipExchangeServerNames HybridServer1, HybridServer2 The script will check to ensure that all Exchange servers in scope have the minimum CU and SU required to enable Extended Protection. The script will also check if all Exchange servers in scope have the same TLS configuration. An inconsistent (or invalid) TLS configuration will cause client connections or connections to Exchange Online to fail. After the prerequisites checks have been passed, the script will enable Extended Protection and add the required SSL flags on all virtual directories of all Exchange servers in scope. Scenario 2 : Using Retention Policies for automated archiving of mailboxes If you are using a Retention Policy containing Retention Tags which perform Move to Archive actions, you should use the script as follows: .\\ExchangeExtendedProtectionManagement.ps1 -RestrictType EWSBackend -IPRangeFilePath \"IPList.txt\" Executing the script this way, configures extended protection on all vDirs like scenario 1 barring Exchange Back End/EWS vDir, where it sets the Extended Protection setting to OFF. The Extended Protection setting is required to be turned OFF to ensure automated archiving works without any hinderance. As turning OFF Extended Protection settings in Backend EWS vDir is not recommended, this command mitigates the risk by limiting the incoming connections to Backend EWS vDir. The script does this by installing an IIS module called IP Address and Domain Restriction and adding allow rules for IP addresses of Exchange Servers. It then adds a deny rule for any incoming connections which is not present in the list. While using this command customers must provide the list of IPv4 addresses (and IPv6 if used) of all Exchange Servers in the organization. This list of addresses should be provided in a TXT file in this way: 10.68.12.48 2001:4898:5808:14:3938:7838:67ab:cdfb 10.128.4.204 10.231.234.140/20 File should contain only IP addresses or IP subnets of Exchange servers separated by newline character. For customers who have more than 100 servers, it is recommended to use IP subnets instead of IP addresses, so that the list is short and efficient. To help get all the IP addresses of all Exchange Servers in the organization, customers can use the following command. .\\ExchangeExtendedProtectionManagement.ps1 -FindExchangeServerIPAddresses The above command will generate a file IPList.txt in the directory where script is stored. Important Note: Customers with many Exchange Servers are expected to modify this list and use IP subnets to reduce the number of allow rules to be added. Scenario 3: Using Modern Hybrid Configuration or Hybrid Agent In case you have Modern Hybrid configuration, you need to skip Exchange servers published using the Hybrid Agent. This can be done by using the SkipExchangeServerNames parameter: .\\ExchangeExtendedProtectionManagement.ps1 -SkipExchangeServerNames HybridServer1, HybridServer2 Or .\\ExchangeExtendedProtectionManagement.ps1 -RestrictType EWSBackend -IPRangeFilePath \"IPList.txt\" -SkipExchangeServerNames HybridServer1, HybridServer2 Troubleshooting warnings and errors during script execution Script gives a cursory warning of known issues before enabling Extended Protection To prevent a scenario where existing Exchange functions are disrupted due to enabling Extended Protection, the script provides a list of scenarios that have known issues. You should read and evaluate this list carefully before enabling Extended Protection. You can proceed to turn on Extended Protection by pressing Y. Script does not enable Extended Protection because of Failed Prerequisite Check No Exchange server runs an Extended Protection supported build: If no Exchange server in the organization is running a CU that supports Extended Protection, the script will not enable Extended Protection on unsupported servers thereby ensuring server-to-server communication does not fail. To resolve this, upgrade all servers to the latest CU and SU and re-run the script to enable Extended Protection. TLS mismatch A valid and consistent TLS configuration is required on all Exchange servers in scope. If the TLS settings on all servers in scope are not the same, enabling Extended Protection will disrupt client connections to mailbox servers. To resolve this, configure the TLS settings on all servers in the organization to be the same and then re-run the script. You can find an overview of the Exchange Server TLS configuration best practices here . Some Exchange servers are not reachable Cause The script performs multiple tests against all Exchange servers in scope. If one or more of these servers aren\u2019t reachable, the script will exclude them and not configure Extended Protection on them. If the server is offline, you should enable Extended Protection on it once it is back online. If the server was unreachable for other reasons, you should run the script directly on the servers to enable Extended Protection. Rolling back Extended Protection settings You can also use the script to roll back the Extended Protection settings and any IP restriction rules added via script from one or more servers. When Extended Protection settings are modified by the script, an applicationHost.cep.*.bak file is created on each server, which contains a backup of pre-existing settings before the script is run. Those files are going to be local to each individual server that the script modifies. Therefore, the rollback of Extended Protection settings can be rolled back from any machine where the script will run using the earliest version of the .bak file to roll back the changes. The following command initiates a full rollback of Extended Protection settings and IP restriction rules on any Exchange server where it was enabled using the script: .\\ExchangeExtendedProtectionManagement.ps1 \u2013RollbackType RestoreIISAppConfig Rolling back IP Restriction settings You can use the script to only roll back Allow and Deny rules set in Backend EWS vDir\u2019s IP Address and Domain Restriction module in the following way. .\\ExchangeExtendedProtectionManagement.ps1 -RollbackType RestrictTypeEWSBackend Note: To safeguard Backend EWS vDir against NTLM relay, executing above command will set Extended Protection setting back to Required. If automated archiving is enabled, executing this command can cause automated archiving to stop working till the time Allow and Deny rules are not added back using the following command. .\\ExchangeExtendedProtectionManagement.ps1 -RestrictType EWSBackend -IPRangeFilePath \"IPList.txt\" .\\ExchangeExtendedProtectionManagement.ps1 \u2013RollbackType \"RestoreIISAppConfig\" Enabling Extended Protection manually via IIS settings If you want to enable Extended Protection in your environment manually without using the script, you can use the following steps. Note: When manually enabling Extended Protection, ensure that all virtual directories on the Exchange servers have Extended Protected configured according to the table above. Set Extended Protection to either Required or Accept for an Exchange Virtual Directory Launch IIS Manager on the Exchange server where you want to configure Extended Protection. Go to Sites and select either the Default Web Site or Exchange Back End. Select the Virtual Directory for which you want to change. Go to Authentication. If Windows Authentication is enabled, then select Windows Authentication. Select Advanced Settings (on the right side) and in Advanced Settings window, select the suitable value from the Extended Protection Dropdown. Set Require SSL settings to either Required or Accept for an Exchange Virtual Directory Go to the Virtual Directory\u2019s home page. Go to SSL Settings . Check the Require SSL checkbox to make sure that Require SSL is enabled for this Virtual Directory. Click Apply . Known issues and workarounds Customers using a Retention Policy containing Retention Tags which perform Move to Archive can now configure Extended Protection with this update. We are actively working on a permanent solution to resolve this issue. Once we ship the solution you will be required to run this script again and rollback the changes. In Exchange Server 2013, 2016 and 2019 the following probes will show FAILED status after running the script which switches on Extended Protection with required SSL flags on various vDirs as per recommended guidelines: OutlookMapiHttpCtpProbe OutlookRpcCtpProbe OutlookRpcDeepTestProbe OutlookRpcSelfTestProbe ComplianceOutlookLogonToArchiveMapiHttpCtpProbe ComplianceOutlookLogonToArchiveRpcCtpProbe You will also notice that some Health Mailbox logins fail with event ID: 4625 and failure reason \" An Error occurred during Logon \" and status 0xC000035B which is related to the failed probes. Get-ServerHealth command will also show RPC and Mapi monitors as Unhealthy. Impact of these failures : Due to this probe failure, the Mapi and Rpc App pools will get restarted once. There should be no other impact. You can also turn off any of the above probes temporarily (till the fix is provided) by going through steps mentioned in Configure managed availability overrides | Microsoft Docs . Fixed: This issue has been addressed with the October 2022 (and later) Exchange Server Security Updates . Troubleshooting issues after enabling Extended Protection Users cannot access their mailbox through one or more clients There may be multiple reasons why some or all clients may start giving authentication errors to users after enabling Extended Protection. If this happens, check the following: If the TLS configuration across the Exchange organization is not the same (e.g., the TLS configuration was changed on one of the Exchange servers after Extended Protection was enabled), this may cause client connections to fail. To resolve this, refer to earlier instructions to configure the same TLS version across all Exchange servers and then use the script to configure Extended Protection again. Check if SSL offload is enabled. Any SSL termination causes the Extended Protection to fail for client connections. Usually if this is the case, users will be able to access their mailbox using Outlook on the Web but Outlook for Windows, Mac or mobile will fail. To resolve this issue, disable SSL offloading and then use the script to configure Extended Protection. Users can access their emails using Outlook for Windows and Outlook on the Web, but not through non-Windows clients like Outlook for Mac, Outlook on iOS, the iOS native email app, etc. This can happen if the Extended Protection setting for EWS and/or Exchange ActiveSync is set to Required on one or all Front-End servers. To resolve this issue, either run the ExchangeExtendedProtectionManagement.ps1 script with the \u2013ExchangeServerNames parameter and pass the name of the Exchange server which has the problem. You can also run the script without any parameter and configure Extended Protection for all servers. .\\ExchangeExtendedProtectionManagement.ps1 or .\\ExchangeExtendedProtectionManagement.ps1 -ExchangeServerNames Server1, Server2 Alternatively, you can also use InetMgr.exe and change the Extended Protection setting for those virtual Directories to the \"Accept\" value. However, we recommend using the script as it checks for the correct values and automatically performs a reconfiguration if the values are not set as expected. If after doing the above, some clients are still not working properly, you can rollback Extended Protection temporarily and report the issue to us. If script was used to configure Extended Protection, you can use the -RollbackType \"RestoreIISAppConfig\" parameter to revert any changes. If Extended Protection was enabled manually (through IIS Manager) you need to revert the settings manually. Hybrid Free/Busy or mailbox migration is not working If you are using Modern Hybrid or the Hybrid Agent enabling Extended Protection will cause Hybrid features like Free/Busy and mailbox migration to stop working. To resolve this issue, identify the hybrid servers that are published using Hybrid Agent and disable Extended Protection on the Front-End EWS endpoints for these servers. Public Folders are not accessible There are two issues that currently impact Public Folders Connectivity: Exchange 2013 If Public Folders exist on Exchange 2013 servers and Extended Protection is enabled, they will no longer appear and end users will be unable to access them. To resolve the issue in a coexistence environment, migrate all Public Folders to Exchange Server 2016 or Exchange Server 2019. If you have an environment containing only Exchange 2013 servers with Public Folders, you can manually remove the SSL flag from the Backend RPC virtual directory to make Public Folders accessible. Exchange Server 2016 CU22 / Exchange Server 2019 CU11 or Older If you have an environment containing Exchange Server 2016 CU22 or Exchange Server 2019 CU11 or older and are utilizing Public Folders, before enabling extended protection you must confirm the version of the server hosting the Public Folder hierarchy. Ensure the server hosting the Public Folder hierarchy is upgraded to Exchange Server 2016 CU23 or Exchange Server 2019 CU12 with the latest Security Updates or move the hierarchy to one with these latest versions and updates. FAQs Q: Is it required to install the August 2022 Security Update (SU) if it was already installed on the previous Cumulative Update (CU)? A: Yes, it's required to install the August 2022 SU again if you update to a newer CU build (e.g., Exchange Server 2019 CU11 --> Exchange Server 2019 CU12). Please remember: If you plan to do the update immediately (means CU + SU installation) Extended Protection does not need to be switched off. If you plan to stay on the CU without installing the SU immediately, you must disable Extended Protection (find the required steps above) as the CU without the SU being installed doesn't support Extended Protection and therefore, you'll experience client connectivity issues. Q: Is it safe to enable Windows Extended Protection on an environment that uses Active Directory Federation Services (ADFS) for OWA? A: Yes, ADFS is not impacted by this change. Q: Is it safe to enable Windows Extended Protection on an environment that uses Hybrid Modern Auth (HMA)? A: Yes, HMA is not impacted by this change. While EP does not further enhance HMA, windows auth may still be used for applications that do not support Hybrid Modern Auth. Considering this, the enablement of Extended Protection would be recommended in any environment eligible that still has Exchange on-premises services. Q: Does Extended Protection Impact Hybrid Modern Auth or Teams Integration? A: Extended Protection will not influence Teams Integration or Hybrid Modern Auth. Q: While we understand that preventing MitM attacks is important, can we have our own devices in the middle with our own certificates? A: If the device uses the same certificate as the Exchange Server, they can be used.","title":"Extended Protection"},{"location":"Security/Extended-Protection/#exchange-server-support-for-windows-extended-protection","text":"","title":"Exchange Server Support for Windows Extended Protection"},{"location":"Security/Extended-Protection/#overview","text":"Windows Extended Protection enhances the existing authentication in Windows Server and mitigates authentication relay or \"man in the middle\" (MitM) attacks. This mitigation is accomplished by using security information that is implemented through Channel-binding information specified through a Channel Binding Token (CBT) which is primarily used for SSL connections. Windows Extended Protection is supported on Exchange Server 2013, 2016 and 2019 starting with the August 2022 Exchange Server Security Update (SU) releases . While Extended Protection can be enabled on each virtual directory manually, we have provided a script that can help you accomplish this in bulk. Windows Extended Protection is supported on Exchange Server 2013, 2016 and 2019 starting with the August 2022 Exchange Server Security Update (SU) releases .","title":"Overview"},{"location":"Security/Extended-Protection/#terminology-used-in-this-document","text":"Virtual Directory, or vDir, is used by Exchange Server to allow access to web applications such as Exchange ActiveSync, Outlook on the Web, and the Autodiscover service. Several virtual directory settings can be configured by an admin, including authentication, security, and reporting settings. Extended Protection is one such authentication setting. The Extended Protection setting controls the behavior for checking of CBTs. Possible values for this setting are listed in the following table: Extended Protection Setting Description None Specifies that IIS will not perform CBT checking. Allow Specifies that CBT checking is enabled, but not required. This setting allows secure communication with clients that support extended protection, and still supports clients that are not capable of using extended protection. Require This value specifies that CBT checking is required. This setting blocks clients that do not support extended protection. SSL Flags : Configuration of SSL settings is required to ensure that clients connect to IIS virtual directories in a specific way with client certificates. To enable Extended Protection, the required SSL flags are SSL and SSL128. SSL offloading terminates the connection on a device between the client and the Exchange Server and then uses a non-encrypted connection to connect to the Exchange Server. Example: flowchart LR A[Client] ==>|HTTPS| B B[\"Device (e.g., Load Balancer) terminates the connection\"] ==>|HTTP| C[\"Web Server\"] SSL bridging is a process where a device, usually located at the edge of a network, decrypts SSL traffic, and then re-encrypts it before sending it on to the Web server. Example: flowchart LR A[Client] ==>|HTTPS| B B[\"Device (e.g., Load Balancer) terminates the connection\"] ==>|HTTPS| C[\"Web Server\"] Modern Hybrid or Hybrid Agent is a mode of configuring Exchange Hybrid that removes some of the configuration requirements for Classic Hybrid (like Inbound network connections through your firewall) to enable Exchange hybrid features. You can learn more about this here . Public Folders are designed for shared access and to help make content in a deep hierarchy easier to browse. You can learn more about Public Folders here .","title":"Terminology used in this document"},{"location":"Security/Extended-Protection/#prerequisites-for-enabling-extended-protection-on-exchange-servers","text":"","title":"Prerequisites for enabling Extended Protection on Exchange servers"},{"location":"Security/Extended-Protection/#make-sure-you-are-on-the-correct-versions","text":"Extended Protection is supported on Exchange Server 2013 CU23 and Exchange Server 2016 CU22 and Exchange Server 2019 CU11 or later with the August 2022 Security Updates installed. If your organization has Exchange Server 2016 or Exchange Server 2019 installed, it must be running either the September 2021 Quarterly Exchange Updates (CU) with the August 2022 Security Update (SU) or later installed or the 2022 H1 Cumulative Update (CU) with the August 2022 Security Update (SU) or later installed. If your organization has Exchange Server 2013 installed, it must be running CU23 with the August 2022 SU (or later) installed. You must ensure all your Exchange servers are on the required CU and have the August 2022 SU (or later) before you proceed further.","title":"Make sure you are on the correct versions"},{"location":"Security/Extended-Protection/#extended-protection-cannot-be-enabled-on-exchange-server-2013-servers-with-public-folders-in-a-coexistence-environment","text":"To enable Extended Protection on Exchange Server 2013, ensure you do not have any Public Folders on Exchange Server 2013. If you have coexistence of Exchange Server 2013 with Exchange Server 2016 or Exchange Server 2019, you must migrate your Public Folders to 2016 or 2019 before enabling Extended Protection. After enabling Extended Protection, if there are Public Folders on Exchange 2013, they will no longer appear to end users.","title":"Extended Protection cannot be enabled on Exchange Server 2013 servers with Public Folders in a coexistence environment"},{"location":"Security/Extended-Protection/#extended-protection-cannot-be-enabled-on-exchange-server-2016-cu22-or-exchange-server-2019-cu11-or-older-that-hosts-a-public-folder-hierarchy","text":"If you have an environment containing Exchange Server 2016 CU22 or Exchange Server 2019 CU11 or older and are utilizing Public Folders, before enabling extended protection you must confirm the version of the server hosting the Public Folder hierarchy . Ensure the server hosting the Public Folder hierarchy is upgraded to Exchange Server 2016 CU23 or Exchange Server 2019 CU12 with the latest Security Updates or move the hierarchy to one with these latest versions and updates. The following table should help clarify: Exchange version CU installed SU installed Hosts PF mailboxes Is EP supported? Exchange 2013 CU23 Aug 2022 (or higher) No Yes Exchange 2016 CU22 Aug 2022 (or higher) No hierarchy mailboxes Yes Exchange 2016 CU23+ (2022 H1) Aug 2022 (or higher) Any Yes Exchange 2019 CU11 Aug 2022 (or higher) No hierarchy mailboxes Yes Exchange 2019 CU12+ (2022 H1) Aug 2022 (or higher) Any Yes Any other version Any other CU Any other SU Any No","title":"Extended Protection cannot be enabled on Exchange Server 2016 CU22 or Exchange Server 2019 CU11 or older that hosts a Public Folder Hierarchy"},{"location":"Security/Extended-Protection/#extended-protection-does-not-work-with-hybrid-servers-using-modern-hybrid-configuration","text":"Extended Protection cannot be enabled on Hybrid Servers which uses Modern Hybrid configuration. In Modern Hybrid configuration, Hybrid Server are published to Exchange Online via Hybrid Agent which proxies the Exchange Online call to Exchange Server. Enabling Extended Protection on Hybrid servers using Modern Hybrid configuration will lead to disruption of hybrid features like mailbox migrations and Free/Busy. Hence, it is important to identify all the Hybrid Servers in the organization published via Hybrid Agent and not enable Extended Protection specifically on these servers.","title":"Extended Protection does not work with hybrid servers using Modern Hybrid configuration"},{"location":"Security/Extended-Protection/#identifying-hybrid-exchange-servers-published-using-hybrid-agent","text":"Note: This step is not required if you are using classic Hybrid configuration. In case you don\u2019t have a list of servers published via Hybrid Agent, you can use the following steps to identify them: Log into a machine where the Hybrid Agent is installed and running. Open the PowerShell module of the Hybrid Agent and run Get-HybridApplication to identify the TargetUri used by the Hybrid Agent. The TargetUri parameter gives you the FQDN of the Exchange Server that is configured to use Hybrid Agent. Deduce the Exchange Server identity using the FQDN and make a note of this Exchange Server. If you are using a Load Balancer URL in TargetUri , you need to identify all the Exchange servers running the Client Access role behind the load balancer URL. Extended Protection should not be enabled for hybrid servers that are published using Hybrid Agent . You need to identify these hybrid servers and ensure you skip enabling Extended Protection on them using the SkipExchangeServerNames parameter of the script.","title":"Identifying hybrid Exchange servers published using Hybrid Agent"},{"location":"Security/Extended-Protection/#steps-to-safeguard-hybrid-servers-using-modern-hybrid","text":"Inbound connections to Exchange servers in a Modern Hybrid configuration should be restricted via firewall to allow connections only from Hybrid Agent machines. No mailboxes should be hosted on the hybrid server, and if any mailbox exists, they should be migrated to other mailbox servers. You can enable Extended Protection on all virtual directories except Front End EWS on the hybrid Exchange server. Note: Specifically skipping extended protection on Front End EWS of Exchange Server is not supported via script. So, you would need to change this setting manually.","title":"Steps to safeguard hybrid servers using Modern Hybrid"},{"location":"Security/Extended-Protection/#ntlmv1-is-not-supported-when-extended-protection-is-enabled","text":"Note: To increase security, we recommend that you review and configure this setting regardless of whether you experience problems or not. NTLMv1 is weak and doesn't provide protection against man-in-the-middle (MitM) attacks. It should be considered as vulnerable and so, no longer be used. Therefore NTLMv1 should not be used together with Extended Protection. Additionally, if you enforce a client to use NTLMv1 instead of NTLMv2 and you have Extended Protection enabled on your Exchange server, this will lead to password prompts on the client side without a way to authenticate successfully against Exchange. If you experience password prompts on your clients once Extended Protection is enabled, you should check the following registry key and value on client and Exchange server side: Registry key: HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Lsa Registry value: LmCompatibilityLevel It must be set to at least 3 or higher (best practice is to set it to 5 which is: Send NTLMv2 response only. Refuse LM & NTLM ). It's also possible to delete this value to enforce the system default. If it's not set, we treat it as if it is set to 3 (on Windows Server 2008 R2 and later) which is: Send NTLMv2 response only . If you want to manage the setting centrally, you can do so via Group Policy: Policy location: Computer Configuration\\Windows Settings\\Security Settings\\Local Policies\\Security Options More information: Network security: LAN Manager authentication level","title":"NTLMv1 is not supported when Extended Protection is enabled"},{"location":"Security/Extended-Protection/#ssl-offloading-scenarios-are-not-supported","text":"Extended Protection is not supported in environments that use SSL offloading. SSL termination during SSL offloading causes Extended Protection to fail. To enable Extended Protection in your Exchange environment, you must not be using SSL offloading with your Load Balancers.","title":"SSL Offloading scenarios are not supported"},{"location":"Security/Extended-Protection/#ssl-bridging-supported-scenarios","text":"Extended Protection is supported in environments that use SSL Bridging under certain conditions. To enable Extended Protection in your Exchange environment using SSL Bridging, you must use the same SSL certificate on Exchange and your Load Balancers . If not this will cause Extended Protection to fail.","title":"SSL Bridging supported scenarios"},{"location":"Security/Extended-Protection/#tls-configuration-must-be-consistent-across-all-exchange-servers","text":"Before enabling Extended Protection, you must ensure that all TLS configurations are consistent across all Exchange servers. For example, if one of the servers uses TLS 1.2, you must ensure that all the servers in the organization are configured using TLS 1.2. Any variation in TLS version use across servers can cause client connections to fail. In addition to this, the value of SchUseStrongCrypto registry value must be set to 1 across all the Exchange Servers in the organization. If this value is not explicitly set to 1, the default value of this key may be interpreted as 0 or 1 depending on the .NET version in use by the Exchange binaries. The same applies to the SystemDefaultTlsVersions registry value which must also be explicitly set to 1. If they aren't set as expected, this can cause TLS mismatch and so, leading to client connectivity issues. Please refer to this guide to configure the required TLS settings on your Exchange servers.","title":"TLS configuration must be consistent across all Exchange servers"},{"location":"Security/Extended-Protection/#third-party-software-compatibility","text":"Please ensure to test all third-party products in your Exchange Server environment to ensure that they work properly when Extended Protection is enabled. For example we have seen AntiVirus solutions send connections through a proxy in order to protect the client machine, this would prevent communication to the Exchange Server and would need to be disabled.","title":"Third-party software compatibility"},{"location":"Security/Extended-Protection/#enabling-extended-protection","text":"Extended Protection can be enabled manually through IIS Manager or via a script (strongly recommended). To correctly configure Extended Protection, each virtual directory on all Exchange servers in the organization (excluding Edge Transport servers) should be set to prescribed value of Extended Protection as well as sslFlags. The following table summarizes the settings needed for each virtual directory on the supported versions of Microsoft Exchange. Enabling Extended Protection involves making many changes on all Exchange servers, so we strongly recommend using the ExchangeExtendedProtectionManagement.ps1 script that can be downloaded from https://aka.ms/ExchangeEPScript . IIS Website Virtual Directory Recommended Extended Protection Recommended sslFlags Default Website API Required Ssl,Ssl128 Default Website AutoDiscover Off Ssl,Ssl128 Default Website ECP Required Ssl,Ssl128 Default Website EWS Accept (UI) /Allow (Script) Ssl,Ssl128 Default Website MAPI Required Ssl,Ssl128 Default Website Microsoft-Server-ActiveSync Accept (UI) /Allow (Script) Ssl,Ssl128 Default Website OAB Required Ssl,Ssl128 Default Website OWA Required Ssl,Ssl128 Default Website PowerShell Required SslNegotiateCert Default Website RPC Required Ssl,Ssl128 Exchange Backend API Required Ssl,Ssl128 Exchange Backend AutoDiscover Off Ssl,Ssl128 Exchange Backend ECP Required Ssl,Ssl128 Exchange Backend EWS Required Ssl,Ssl128 Exchange Backend Microsoft-Server-ActiveSync Required Ssl,Ssl128 Exchange Backend OAB Required Ssl,Ssl128 Exchange Backend OWA Required Ssl,Ssl128 Exchange Backend PowerShell Required Ssl,SslNegotiateCert,Ssl128 Exchange Backend RPC Required Ssl,Ssl128 Exchange Backend PushNotifications Required Ssl,Ssl128 Exchange Backend RPCWithCert Required Ssl,Ssl128 Exchange Backend MAPI/emsmdb Required Ssl,Ssl128 Exchange Backend MAPI/nspi Required Ssl,Ssl128 SSL offloading for Outlook Anywhere is enabled by default and must be disabled for extended protection by following the steps shown here .","title":"Enabling Extended Protection"},{"location":"Security/Extended-Protection/#enabling-extended-protection-using-the-script","text":"Before enabling Extended Protection in your Exchange environment, ensure you meet all the prerequisites listed in this document. To enable Extended Protection on all your Exchange Servers, you can use the ExchangeExtendedProtectionManagement.ps1 script, which is hosted on the Microsoft Exchange-CSS repository on GitHub. It\u2019s not required to run the script directly on any specific Exchange Server in your environment. Just copy it to a machine that has the Exchange Management Shell (EMS) installed. Note: Over time, we will be updating the script and documentation. The script will attempt to auto-update when it is run. If the computer where the script is run is not connected to the Internet, this update check will fail. You should always check for the latest version of the script before running it.","title":"Enabling Extended Protection using the script"},{"location":"Security/Extended-Protection/#parameters","text":"If the script is executed without any parameters, it will enable Extended Protection on any Exchange Server that can be reached from the machine where the script was run. You can use the following parameters to specify the scope of script operations: Parameter Usage ExchangeServerNames Used to specify which Exchange servers should be included in the scope of script execution . It can be either a single Exchange server hostname or a comma separated list of hostnames. Parameter values: Exchange Server Hostname (NetBIOS or FQDN) SkipExchangeServerNames Used to specify which Exchange servers should be excluded from the scope of script execution . It can be either a single Exchange Server hostname or a comma separated list of hostnames. Parameter values: Exchange Server Hostname (NetBIOS or FQDN) RollbackType Used to revert changes made by the Extended Protection script. Parameter Values: \"RestoreIISAppConfig, RestrictTypeEWSBackend\" \" ShowExtendedProtection Used to display the current Extended Protection configuration state in your organization or on a specific computer (use the ExchangeServerNames or SkipExchangeServerNames parameter to show the configuration for a subset of Exchange servers). RestrictType Used to restrict incoming IP connections on specified vDir Parameter Value: EWSBackend : This parameter should be used to restrict incoming IP connections to a specified allow list of IP addresses or Subnets. This will also turn off EP on EWSBackend. Note: This parameter should only be used if automated archiving via retention tags is enabled in the Exchange environment. IPRangeFilePath This is a mandatory parameter which must be used to provide an allow list of IP ranges when RestrictType parameter is used. The filepath provides should be of a .TXT file with IP addresses or subnets. ValidateType Used to cross check allow list of IP addresses on vDir against IPList file provided in IPRangeFilePath. Parameter Value: RestrictTypeEWSBackend : should be used to cross check allow list of IP addresses on EWS Backend vDir against IPList file provided in IPRangeFilePath. FindExchangeServerIPAddresses Used to create list of IPv4 and IPv6 addresses of all Exchange Servers in the organization.","title":"Parameters"},{"location":"Security/Extended-Protection/#enabling-extended-protection-on-all-exchange-servers","text":"After copying the script to a suitable machine, create a directory to store the script and move the script there. Then open the Exchange Management Shell (EMS) and go to the respective directory where the script is stored. Make sure that the account you are using is a member of the Organization Management role group. Execute the script as follows: .\\ExchangeExtendedProtectionManagement.ps1 In case that you have Modern Hybrid configuration, you need to skip Exchange servers published using the Hybrid Agent. This can be done by using the SkipExchangeServerNames parameter: .\\ExchangeExtendedProtectionManagement.ps1 -SkipExchangeServerNames HybridServer1, HybridServer2 The script will check to ensure that all Exchange servers in scope have the minimum CU and SU required to enable Extended Protection. The script will also check if all Exchange servers in scope have the same TLS configuration. An inconsistent (or invalid) TLS configuration will cause client connections or connections to Exchange Online to fail. After the prerequisites checks have been passed, the script will enable Extended Protection and add the required SSL flags on all virtual directories of all Exchange servers in scope.","title":"Enabling Extended Protection on all Exchange servers"},{"location":"Security/Extended-Protection/#scenario-2-using-retention-policies-for-automated-archiving-of-mailboxes","text":"If you are using a Retention Policy containing Retention Tags which perform Move to Archive actions, you should use the script as follows: .\\ExchangeExtendedProtectionManagement.ps1 -RestrictType EWSBackend -IPRangeFilePath \"IPList.txt\" Executing the script this way, configures extended protection on all vDirs like scenario 1 barring Exchange Back End/EWS vDir, where it sets the Extended Protection setting to OFF. The Extended Protection setting is required to be turned OFF to ensure automated archiving works without any hinderance. As turning OFF Extended Protection settings in Backend EWS vDir is not recommended, this command mitigates the risk by limiting the incoming connections to Backend EWS vDir. The script does this by installing an IIS module called IP Address and Domain Restriction and adding allow rules for IP addresses of Exchange Servers. It then adds a deny rule for any incoming connections which is not present in the list. While using this command customers must provide the list of IPv4 addresses (and IPv6 if used) of all Exchange Servers in the organization. This list of addresses should be provided in a TXT file in this way: 10.68.12.48 2001:4898:5808:14:3938:7838:67ab:cdfb 10.128.4.204 10.231.234.140/20 File should contain only IP addresses or IP subnets of Exchange servers separated by newline character. For customers who have more than 100 servers, it is recommended to use IP subnets instead of IP addresses, so that the list is short and efficient. To help get all the IP addresses of all Exchange Servers in the organization, customers can use the following command. .\\ExchangeExtendedProtectionManagement.ps1 -FindExchangeServerIPAddresses The above command will generate a file IPList.txt in the directory where script is stored. Important Note: Customers with many Exchange Servers are expected to modify this list and use IP subnets to reduce the number of allow rules to be added.","title":"Scenario 2: Using Retention Policies for automated archiving of mailboxes"},{"location":"Security/Extended-Protection/#scenario-3-using-modern-hybrid-configuration-or-hybrid-agent","text":"In case you have Modern Hybrid configuration, you need to skip Exchange servers published using the Hybrid Agent. This can be done by using the SkipExchangeServerNames parameter: .\\ExchangeExtendedProtectionManagement.ps1 -SkipExchangeServerNames HybridServer1, HybridServer2 Or .\\ExchangeExtendedProtectionManagement.ps1 -RestrictType EWSBackend -IPRangeFilePath \"IPList.txt\" -SkipExchangeServerNames HybridServer1, HybridServer2","title":"Scenario 3: Using Modern Hybrid Configuration or Hybrid Agent"},{"location":"Security/Extended-Protection/#troubleshooting-warnings-and-errors-during-script-execution","text":"Script gives a cursory warning of known issues before enabling Extended Protection To prevent a scenario where existing Exchange functions are disrupted due to enabling Extended Protection, the script provides a list of scenarios that have known issues. You should read and evaluate this list carefully before enabling Extended Protection. You can proceed to turn on Extended Protection by pressing Y. Script does not enable Extended Protection because of Failed Prerequisite Check No Exchange server runs an Extended Protection supported build: If no Exchange server in the organization is running a CU that supports Extended Protection, the script will not enable Extended Protection on unsupported servers thereby ensuring server-to-server communication does not fail. To resolve this, upgrade all servers to the latest CU and SU and re-run the script to enable Extended Protection. TLS mismatch A valid and consistent TLS configuration is required on all Exchange servers in scope. If the TLS settings on all servers in scope are not the same, enabling Extended Protection will disrupt client connections to mailbox servers. To resolve this, configure the TLS settings on all servers in the organization to be the same and then re-run the script. You can find an overview of the Exchange Server TLS configuration best practices here . Some Exchange servers are not reachable Cause The script performs multiple tests against all Exchange servers in scope. If one or more of these servers aren\u2019t reachable, the script will exclude them and not configure Extended Protection on them. If the server is offline, you should enable Extended Protection on it once it is back online. If the server was unreachable for other reasons, you should run the script directly on the servers to enable Extended Protection.","title":"Troubleshooting warnings and errors during script execution"},{"location":"Security/Extended-Protection/#rolling-back-extended-protection-settings","text":"You can also use the script to roll back the Extended Protection settings and any IP restriction rules added via script from one or more servers. When Extended Protection settings are modified by the script, an applicationHost.cep.*.bak file is created on each server, which contains a backup of pre-existing settings before the script is run. Those files are going to be local to each individual server that the script modifies. Therefore, the rollback of Extended Protection settings can be rolled back from any machine where the script will run using the earliest version of the .bak file to roll back the changes. The following command initiates a full rollback of Extended Protection settings and IP restriction rules on any Exchange server where it was enabled using the script: .\\ExchangeExtendedProtectionManagement.ps1 \u2013RollbackType RestoreIISAppConfig","title":"Rolling back Extended Protection settings"},{"location":"Security/Extended-Protection/#rolling-back-ip-restriction-settings","text":"You can use the script to only roll back Allow and Deny rules set in Backend EWS vDir\u2019s IP Address and Domain Restriction module in the following way. .\\ExchangeExtendedProtectionManagement.ps1 -RollbackType RestrictTypeEWSBackend Note: To safeguard Backend EWS vDir against NTLM relay, executing above command will set Extended Protection setting back to Required. If automated archiving is enabled, executing this command can cause automated archiving to stop working till the time Allow and Deny rules are not added back using the following command. .\\ExchangeExtendedProtectionManagement.ps1 -RestrictType EWSBackend -IPRangeFilePath \"IPList.txt\" .\\ExchangeExtendedProtectionManagement.ps1 \u2013RollbackType \"RestoreIISAppConfig\"","title":"Rolling back IP Restriction settings"},{"location":"Security/Extended-Protection/#enabling-extended-protection-manually-via-iis-settings","text":"If you want to enable Extended Protection in your environment manually without using the script, you can use the following steps. Note: When manually enabling Extended Protection, ensure that all virtual directories on the Exchange servers have Extended Protected configured according to the table above.","title":"Enabling Extended Protection manually via IIS settings"},{"location":"Security/Extended-Protection/#set-extended-protection-to-either-required-or-accept-for-an-exchange-virtual-directory","text":"Launch IIS Manager on the Exchange server where you want to configure Extended Protection. Go to Sites and select either the Default Web Site or Exchange Back End. Select the Virtual Directory for which you want to change. Go to Authentication. If Windows Authentication is enabled, then select Windows Authentication. Select Advanced Settings (on the right side) and in Advanced Settings window, select the suitable value from the Extended Protection Dropdown.","title":"Set Extended Protection to either Required or Accept for an Exchange Virtual Directory"},{"location":"Security/Extended-Protection/#set-require-ssl-settings-to-either-required-or-accept-for-an-exchange-virtual-directory","text":"Go to the Virtual Directory\u2019s home page. Go to SSL Settings . Check the Require SSL checkbox to make sure that Require SSL is enabled for this Virtual Directory. Click Apply .","title":"Set Require SSL settings to either Required or Accept for an Exchange Virtual Directory"},{"location":"Security/Extended-Protection/#known-issues-and-workarounds","text":"Customers using a Retention Policy containing Retention Tags which perform Move to Archive can now configure Extended Protection with this update. We are actively working on a permanent solution to resolve this issue. Once we ship the solution you will be required to run this script again and rollback the changes. In Exchange Server 2013, 2016 and 2019 the following probes will show FAILED status after running the script which switches on Extended Protection with required SSL flags on various vDirs as per recommended guidelines: OutlookMapiHttpCtpProbe OutlookRpcCtpProbe OutlookRpcDeepTestProbe OutlookRpcSelfTestProbe ComplianceOutlookLogonToArchiveMapiHttpCtpProbe ComplianceOutlookLogonToArchiveRpcCtpProbe You will also notice that some Health Mailbox logins fail with event ID: 4625 and failure reason \" An Error occurred during Logon \" and status 0xC000035B which is related to the failed probes. Get-ServerHealth command will also show RPC and Mapi monitors as Unhealthy. Impact of these failures : Due to this probe failure, the Mapi and Rpc App pools will get restarted once. There should be no other impact. You can also turn off any of the above probes temporarily (till the fix is provided) by going through steps mentioned in Configure managed availability overrides | Microsoft Docs . Fixed: This issue has been addressed with the October 2022 (and later) Exchange Server Security Updates .","title":"Known issues and workarounds"},{"location":"Security/Extended-Protection/#troubleshooting-issues-after-enabling-extended-protection","text":"","title":"Troubleshooting issues after enabling Extended Protection"},{"location":"Security/Extended-Protection/#users-cannot-access-their-mailbox-through-one-or-more-clients","text":"There may be multiple reasons why some or all clients may start giving authentication errors to users after enabling Extended Protection. If this happens, check the following: If the TLS configuration across the Exchange organization is not the same (e.g., the TLS configuration was changed on one of the Exchange servers after Extended Protection was enabled), this may cause client connections to fail. To resolve this, refer to earlier instructions to configure the same TLS version across all Exchange servers and then use the script to configure Extended Protection again. Check if SSL offload is enabled. Any SSL termination causes the Extended Protection to fail for client connections. Usually if this is the case, users will be able to access their mailbox using Outlook on the Web but Outlook for Windows, Mac or mobile will fail. To resolve this issue, disable SSL offloading and then use the script to configure Extended Protection. Users can access their emails using Outlook for Windows and Outlook on the Web, but not through non-Windows clients like Outlook for Mac, Outlook on iOS, the iOS native email app, etc. This can happen if the Extended Protection setting for EWS and/or Exchange ActiveSync is set to Required on one or all Front-End servers. To resolve this issue, either run the ExchangeExtendedProtectionManagement.ps1 script with the \u2013ExchangeServerNames parameter and pass the name of the Exchange server which has the problem. You can also run the script without any parameter and configure Extended Protection for all servers. .\\ExchangeExtendedProtectionManagement.ps1 or .\\ExchangeExtendedProtectionManagement.ps1 -ExchangeServerNames Server1, Server2 Alternatively, you can also use InetMgr.exe and change the Extended Protection setting for those virtual Directories to the \"Accept\" value. However, we recommend using the script as it checks for the correct values and automatically performs a reconfiguration if the values are not set as expected. If after doing the above, some clients are still not working properly, you can rollback Extended Protection temporarily and report the issue to us. If script was used to configure Extended Protection, you can use the -RollbackType \"RestoreIISAppConfig\" parameter to revert any changes. If Extended Protection was enabled manually (through IIS Manager) you need to revert the settings manually.","title":"Users cannot access their mailbox through one or more clients"},{"location":"Security/Extended-Protection/#hybrid-freebusy-or-mailbox-migration-is-not-working","text":"If you are using Modern Hybrid or the Hybrid Agent enabling Extended Protection will cause Hybrid features like Free/Busy and mailbox migration to stop working. To resolve this issue, identify the hybrid servers that are published using Hybrid Agent and disable Extended Protection on the Front-End EWS endpoints for these servers.","title":"Hybrid Free/Busy or mailbox migration is not working"},{"location":"Security/Extended-Protection/#public-folders-are-not-accessible","text":"There are two issues that currently impact Public Folders Connectivity:","title":"Public Folders are not accessible"},{"location":"Security/Extended-Protection/#exchange-2013","text":"If Public Folders exist on Exchange 2013 servers and Extended Protection is enabled, they will no longer appear and end users will be unable to access them. To resolve the issue in a coexistence environment, migrate all Public Folders to Exchange Server 2016 or Exchange Server 2019. If you have an environment containing only Exchange 2013 servers with Public Folders, you can manually remove the SSL flag from the Backend RPC virtual directory to make Public Folders accessible.","title":"Exchange 2013"},{"location":"Security/Extended-Protection/#exchange-server-2016-cu22-exchange-server-2019-cu11-or-older","text":"If you have an environment containing Exchange Server 2016 CU22 or Exchange Server 2019 CU11 or older and are utilizing Public Folders, before enabling extended protection you must confirm the version of the server hosting the Public Folder hierarchy. Ensure the server hosting the Public Folder hierarchy is upgraded to Exchange Server 2016 CU23 or Exchange Server 2019 CU12 with the latest Security Updates or move the hierarchy to one with these latest versions and updates.","title":"Exchange Server 2016 CU22 / Exchange Server 2019 CU11 or Older"},{"location":"Security/Extended-Protection/#faqs","text":"Q: Is it required to install the August 2022 Security Update (SU) if it was already installed on the previous Cumulative Update (CU)? A: Yes, it's required to install the August 2022 SU again if you update to a newer CU build (e.g., Exchange Server 2019 CU11 --> Exchange Server 2019 CU12). Please remember: If you plan to do the update immediately (means CU + SU installation) Extended Protection does not need to be switched off. If you plan to stay on the CU without installing the SU immediately, you must disable Extended Protection (find the required steps above) as the CU without the SU being installed doesn't support Extended Protection and therefore, you'll experience client connectivity issues. Q: Is it safe to enable Windows Extended Protection on an environment that uses Active Directory Federation Services (ADFS) for OWA? A: Yes, ADFS is not impacted by this change. Q: Is it safe to enable Windows Extended Protection on an environment that uses Hybrid Modern Auth (HMA)? A: Yes, HMA is not impacted by this change. While EP does not further enhance HMA, windows auth may still be used for applications that do not support Hybrid Modern Auth. Considering this, the enablement of Extended Protection would be recommended in any environment eligible that still has Exchange on-premises services. Q: Does Extended Protection Impact Hybrid Modern Auth or Teams Integration? A: Extended Protection will not influence Teams Integration or Hybrid Modern Auth. Q: While we understand that preventing MitM attacks is important, can we have our own devices in the middle with our own certificates? A: If the device uses the same certificate as the Exchange Server, they can be used.","title":"FAQs"},{"location":"Security/Test-CVE-2021-34470/","text":"Test-CVE-2021-34470 Download the latest release: Test-CVE-2021-34470.ps1 Environments running supported versions of Exchange Server should address CVE-2021-34470 by applying the CU and/or SU for the respective versions of Exchange, as described in Released: July 2021 Exchange Server Security Updates . Environments where the latest version of Exchange Server is any version before Exchange 2013, or environments where all Exchange servers have been removed, can use this script to address the vulnerability. Examples Check for the vulnerability: .\\Test-CVE-2021-34470.ps1 Fix the vulnerability if found: .\\Test-CVE-2021-34470.ps1 -ApplyFix Note that the user must be a Schema Admin to use the -ApplyFix switch.","title":"Test-CVE-2021-34470"},{"location":"Security/Test-CVE-2021-34470/#test-cve-2021-34470","text":"Download the latest release: Test-CVE-2021-34470.ps1 Environments running supported versions of Exchange Server should address CVE-2021-34470 by applying the CU and/or SU for the respective versions of Exchange, as described in Released: July 2021 Exchange Server Security Updates . Environments where the latest version of Exchange Server is any version before Exchange 2013, or environments where all Exchange servers have been removed, can use this script to address the vulnerability.","title":"Test-CVE-2021-34470"},{"location":"Security/Test-CVE-2021-34470/#examples","text":"Check for the vulnerability: .\\Test-CVE-2021-34470.ps1 Fix the vulnerability if found: .\\Test-CVE-2021-34470.ps1 -ApplyFix Note that the user must be a Schema Admin to use the -ApplyFix switch.","title":"Examples"},{"location":"Security/Test-ProxyLogon/","text":"Test-ProxyLogon.ps1 Download the latest release: Test-ProxyLogon.ps1 Formerly known as Test-Hafnium, this script automates all four of the commands found in the Hafnium blog post . It also has a progress bar and some performance tweaks to make the CVE-2021-26855 test run much faster. Usage The most typical usage of this script is to check all Exchange servers and save the reports, by using the following syntax from Exchange Management Shell: Get-ExchangeServer | .\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs To check the local server only, just run the script: .\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs To check the local server and copy the identified logs and files to the OutPath: .\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs -CollectFiles To display the results without saving them, pass -DisplayOnly: .\\Test-ProxyLogon.ps1 -DisplayOnly Frequently Asked Questions The script says it found suspicious files, and it lists a bunch of zip files. What does this mean? The script will flag any zip/7x/rar files that it finds in ProgramData. As noted in this blog post , web shells have been observed using such files for exfiltration. An administrator should review the files to determine if they are valid. Determining if a zip file is a valid part of an installed product is outside the scope of this script, and whitelisting files by name would only encourage the use of those specific names by attackers. I'm having trouble running the script on Exchange 2010. If PowerShell 3 is present, the script can be run on Exchange 2010. It will not run-on PowerShell 2. One can also enable PS Remoting and run the script remotely against Exchange 2010. However, the script has minimal functionality in these scenarios, as Exchange 2010 is only affected by one of the four announced exploits - CVE-2021-26857. Further, this exploit is only available if the Unified Messaging role is present. As a result, it is often easier to simply run the Get-EventLog command from the blog post , rather than using Test-ProxyLogon.","title":"Test-ProxyLogon"},{"location":"Security/Test-ProxyLogon/#test-proxylogonps1","text":"Download the latest release: Test-ProxyLogon.ps1 Formerly known as Test-Hafnium, this script automates all four of the commands found in the Hafnium blog post . It also has a progress bar and some performance tweaks to make the CVE-2021-26855 test run much faster.","title":"Test-ProxyLogon.ps1"},{"location":"Security/Test-ProxyLogon/#usage","text":"The most typical usage of this script is to check all Exchange servers and save the reports, by using the following syntax from Exchange Management Shell: Get-ExchangeServer | .\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs To check the local server only, just run the script: .\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs To check the local server and copy the identified logs and files to the OutPath: .\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs -CollectFiles To display the results without saving them, pass -DisplayOnly: .\\Test-ProxyLogon.ps1 -DisplayOnly","title":"Usage"},{"location":"Security/Test-ProxyLogon/#frequently-asked-questions","text":"The script says it found suspicious files, and it lists a bunch of zip files. What does this mean? The script will flag any zip/7x/rar files that it finds in ProgramData. As noted in this blog post , web shells have been observed using such files for exfiltration. An administrator should review the files to determine if they are valid. Determining if a zip file is a valid part of an installed product is outside the scope of this script, and whitelisting files by name would only encourage the use of those specific names by attackers. I'm having trouble running the script on Exchange 2010. If PowerShell 3 is present, the script can be run on Exchange 2010. It will not run-on PowerShell 2. One can also enable PS Remoting and run the script remotely against Exchange 2010. However, the script has minimal functionality in these scenarios, as Exchange 2010 is only affected by one of the four announced exploits - CVE-2021-26857. Further, this exploit is only available if the Unified Messaging role is present. As a result, it is often easier to simply run the Get-EventLog command from the blog post , rather than using Test-ProxyLogon.","title":"Frequently Asked Questions"},{"location":"Setup/CopyMissingDlls/","text":"CopyMissingDlls Download the latest release: CopyMissingDlls.ps1 This script is used to copy over missing dlls that might have occurred during a CU install. This script has a mapping of the location of where the .dll should be on the server and where it should be on the ISO and will attempt to copy it over if the file is detected to be missing on the install location. Parameter Type Description IsoRoot string The Root location of the ISO. Example: D:","title":"CopyMissingDlls"},{"location":"Setup/CopyMissingDlls/#copymissingdlls","text":"Download the latest release: CopyMissingDlls.ps1 This script is used to copy over missing dlls that might have occurred during a CU install. This script has a mapping of the location of where the .dll should be on the server and where it should be on the ISO and will attempt to copy it over if the file is detected to be missing on the install location. Parameter Type Description IsoRoot string The Root location of the ISO. Example: D:","title":"CopyMissingDlls"},{"location":"Setup/FixInstallerCache/","text":"FixInstallerCache Download the latest release: FixInstallerCache.ps1 This script is used to copy over the missing MSI files from the installer cache. Parameter Type Description CurrentCuRootDirectory string The root location of the current CU that you are on. MachineName string array One or more machine names from which to copy the required MSI files.","title":"FixInstallerCache"},{"location":"Setup/FixInstallerCache/#fixinstallercache","text":"Download the latest release: FixInstallerCache.ps1 This script is used to copy over the missing MSI files from the installer cache. Parameter Type Description CurrentCuRootDirectory string The root location of the current CU that you are on. MachineName string array One or more machine names from which to copy the required MSI files.","title":"FixInstallerCache"},{"location":"Setup/Set-ExchAVExclusions/","text":"Set-ExchAVExclusions Download the latest release: Set-ExchAVExclusions.ps1 The Script will assist in setting the Antivirus Exclusions according to our documentation for Microsoft Exchange Server. AV Exclusions Exchange 2016/2019 AV Exclusions Exchange 2013 If you use Windows Defender you can Set the exclusions executing the script without parameters but if you have any other Antivirus solution you can get the full list of Expected Exclusions. Requirements Supported Exchange Server Versions: The script can be used to validate the configuration of the following Microsoft Exchange Server versions: - Microsoft Exchange Server 2013 - Microsoft Exchange Server 2016 - Microsoft Exchange Server 2019 The server must have Microsoft Defender to set it and enable it to be effective. Required Permissions: Please make sure that the account used is a member of the Local Administrator group. This should be fulfilled on Exchange servers by being a member of the Organization Management group. How To Run This script must be run as Administrator in Exchange Management Shell on an Exchange Server. You do not need to provide any parameters and the script will set the Windows Defender exclusions for the local Exchange server. If you want to get the full list of expected exclusions you should use the parameter ListRecommendedExclusions You can export the Exclusion List with the parameter FileName Examples: This will run Set-ExchAVExclusions Script against the local server. .\\Set-ExchAVExclusions.ps1 This will run Set-ExchAVExclusions Script against the local server and show in screen the expected exclusions on screen without setting them. .\\Set-ExchAVExclusions.ps1 -ListRecommendedExclusions This will run Set-ExchAVExclusions Script against the local server and show in screen the expected exclusions on screen without setting them and write them in the defined FileName . .\\Set-ExchAVExclusions.ps1 -ListRecommendedExclusions -FileName .\\Exclusions.txt This will run Set-ExchAVExclusions Script against the local server and write them in the defined FileName . .\\Set-ExchAVExclusions.ps1 -FileName .\\Exclusions.txt Outputs Exclusions List File: FileName Log file: $env:LOCALAPPDATA\\SetExchAvExclusions.log","title":"Set-ExchAVExclusions"},{"location":"Setup/Set-ExchAVExclusions/#set-exchavexclusions","text":"Download the latest release: Set-ExchAVExclusions.ps1 The Script will assist in setting the Antivirus Exclusions according to our documentation for Microsoft Exchange Server. AV Exclusions Exchange 2016/2019 AV Exclusions Exchange 2013 If you use Windows Defender you can Set the exclusions executing the script without parameters but if you have any other Antivirus solution you can get the full list of Expected Exclusions.","title":"Set-ExchAVExclusions"},{"location":"Setup/Set-ExchAVExclusions/#requirements","text":"","title":"Requirements"},{"location":"Setup/Set-ExchAVExclusions/#supported-exchange-server-versions","text":"The script can be used to validate the configuration of the following Microsoft Exchange Server versions: - Microsoft Exchange Server 2013 - Microsoft Exchange Server 2016 - Microsoft Exchange Server 2019 The server must have Microsoft Defender to set it and enable it to be effective.","title":"Supported Exchange Server Versions:"},{"location":"Setup/Set-ExchAVExclusions/#required-permissions","text":"Please make sure that the account used is a member of the Local Administrator group. This should be fulfilled on Exchange servers by being a member of the Organization Management group.","title":"Required Permissions:"},{"location":"Setup/Set-ExchAVExclusions/#how-to-run","text":"This script must be run as Administrator in Exchange Management Shell on an Exchange Server. You do not need to provide any parameters and the script will set the Windows Defender exclusions for the local Exchange server. If you want to get the full list of expected exclusions you should use the parameter ListRecommendedExclusions You can export the Exclusion List with the parameter FileName","title":"How To Run"},{"location":"Setup/Set-ExchAVExclusions/#examples","text":"This will run Set-ExchAVExclusions Script against the local server. .\\Set-ExchAVExclusions.ps1 This will run Set-ExchAVExclusions Script against the local server and show in screen the expected exclusions on screen without setting them. .\\Set-ExchAVExclusions.ps1 -ListRecommendedExclusions This will run Set-ExchAVExclusions Script against the local server and show in screen the expected exclusions on screen without setting them and write them in the defined FileName . .\\Set-ExchAVExclusions.ps1 -ListRecommendedExclusions -FileName .\\Exclusions.txt This will run Set-ExchAVExclusions Script against the local server and write them in the defined FileName . .\\Set-ExchAVExclusions.ps1 -FileName .\\Exclusions.txt","title":"Examples:"},{"location":"Setup/Set-ExchAVExclusions/#outputs","text":"Exclusions List File: FileName Log file: $env:LOCALAPPDATA\\SetExchAvExclusions.log","title":"Outputs"},{"location":"Setup/SetupLogReviewer/","text":"SetupLogReviewer Download the latest release: SetupLogReviewer.ps1 This script is meant to be run against the Exchange Setup Logs located at C:\\ExchangeSetupLogs\\ExchangeSetup.log . You can run this on the server, or on a personal computer. It currently checks for common prerequisite issues, clearly calling out if you need up run /PrepareAD in your environment and calls out where it needs to be run. It also checks for some other common issue that we have seen in support that we call out and display the actions to the screen. Parameter Description [string]SetupLog The location of the Exchange Setup Log that needs to be reviewed [switch]DelegatedSetup Use this switch if you are troubleshooting Prerequisites of a Delegated Setup issue","title":"SetupLogReviewer"},{"location":"Setup/SetupLogReviewer/#setuplogreviewer","text":"Download the latest release: SetupLogReviewer.ps1 This script is meant to be run against the Exchange Setup Logs located at C:\\ExchangeSetupLogs\\ExchangeSetup.log . You can run this on the server, or on a personal computer. It currently checks for common prerequisite issues, clearly calling out if you need up run /PrepareAD in your environment and calls out where it needs to be run. It also checks for some other common issue that we have seen in support that we call out and display the actions to the screen. Parameter Description [string]SetupLog The location of the Exchange Setup Log that needs to be reviewed [switch]DelegatedSetup Use this switch if you are troubleshooting Prerequisites of a Delegated Setup issue","title":"SetupLogReviewer"},{"location":"Setup/SetupAssist/","text":"SetupAssist Download the latest release: SetupAssist.ps1 This script is meant to be run on the system where you are running setup from. It currently checks and displays the following when just running it: Current Logged on User and SID Are you running as an Administrator Member of Domain Admins Member of Schema Admins Member of Enterprise Admins Member of Organization Management Current PowerShell Execution Policy setting Checks to see if you are missing files in the installer cache (only checks to see if they are there, not if they are valid) More than 1 powershell.exe process up and running If reboot pending. (Add -Verbose to see where) The current AD level of readiness for CU upgrading. Displays warnings if a mismatch is detected. Additional Parameters are used for when they are called out from the SetupLogReviewer.ps1 Parameter Type Description OtherWellKnownObjects switch Tests for deleted objects in the otherWellKnownObjects attribute","title":"SetupAssist"},{"location":"Setup/SetupAssist/#setupassist","text":"Download the latest release: SetupAssist.ps1 This script is meant to be run on the system where you are running setup from. It currently checks and displays the following when just running it: Current Logged on User and SID Are you running as an Administrator Member of Domain Admins Member of Schema Admins Member of Enterprise Admins Member of Organization Management Current PowerShell Execution Policy setting Checks to see if you are missing files in the installer cache (only checks to see if they are there, not if they are valid) More than 1 powershell.exe process up and running If reboot pending. (Add -Verbose to see where) The current AD level of readiness for CU upgrading. Displays warnings if a mismatch is detected. Additional Parameters are used for when they are called out from the SetupLogReviewer.ps1 Parameter Type Description OtherWellKnownObjects switch Tests for deleted objects in the otherWellKnownObjects attribute","title":"SetupAssist"},{"location":"Setup/SetupAssist/ComputersContainer/","text":"Computers container renamed or missing When the CN=Computers container has been renamed or removed from the root of an Active Directory domain, /PrepareAD will fail for certain Cumulative Updates. Please see https://support.microsoft.com/help/5005319 for details.","title":"ComputersContainer"},{"location":"Setup/SetupAssist/ComputersContainer/#computers-container-renamed-or-missing","text":"When the CN=Computers container has been renamed or removed from the root of an Active Directory domain, /PrepareAD will fail for certain Cumulative Updates. Please see https://support.microsoft.com/help/5005319 for details.","title":"Computers container renamed or missing"},{"location":"Setup/SetupAssist/ReadOnlyDomainControllerContainer/","text":"Read Only Domain Controller - Domain Controllers OU A Read Only Domain Controller appears to be in the container other than CN=Domain Controllers. This will cause setup to fail if we attempt to domain prep that domain. The path to the RODC must be CN=DCName,CN=Domain Controllers....","title":"ReadOnlyDomainControllerContainer"},{"location":"Setup/SetupAssist/ReadOnlyDomainControllerContainer/#read-only-domain-controller-domain-controllers-ou","text":"A Read Only Domain Controller appears to be in the container other than CN=Domain Controllers. This will cause setup to fail if we attempt to domain prep that domain. The path to the RODC must be CN=DCName,CN=Domain Controllers....","title":"Read Only Domain Controller - Domain Controllers OU"},{"location":"Setup/SetupAssist/RebootPending/","text":"Reboot Pending It is best to reboot the server to address these issues. It may take some time after a reboot to have the keys automatically removed. However, if they don't remove automatically, follow these steps to address the issue for the keys that were provided to be a problem. Open regedit to the desired location. Delete the key. If unable to delete the key, follow these steps: Right click on it Open permissions Click on Advanced Change ownership to your account Close Advanced window Give your account Full Control in Permissions window Delete the key NOTE: With Component Based Servicing\\RebootPending you need to do the same for Component Based Servicing\\PackagesPending prior to RebootPending NOTE: Follow the steps in this section carefully. Serious problems might occur if you modify the registry incorrectly. Before you modify it, back up the registry for restoration in case problems occur.","title":"RebootPending"},{"location":"Setup/SetupAssist/RebootPending/#reboot-pending","text":"It is best to reboot the server to address these issues. It may take some time after a reboot to have the keys automatically removed. However, if they don't remove automatically, follow these steps to address the issue for the keys that were provided to be a problem. Open regedit to the desired location. Delete the key. If unable to delete the key, follow these steps: Right click on it Open permissions Click on Advanced Change ownership to your account Close Advanced window Give your account Full Control in Permissions window Delete the key NOTE: With Component Based Servicing\\RebootPending you need to do the same for Component Based Servicing\\PackagesPending prior to RebootPending NOTE: Follow the steps in this section carefully. Serious problems might occur if you modify the registry incorrectly. Before you modify it, back up the registry for restoration in case problems occur.","title":"Reboot Pending"},{"location":"Transport/Compute-TopExoRecipientsFromMessageTrace/","text":"Compute-TopExoRecipientsFromMessageTrace Download the latest release: Compute-TopExoRecipientsFromMessageTrace.ps1 This script aggregates message trace events hourly and generates a report with the top o365 recipients Parameters -StartDate The StartDate parameter specifies the end date of the date range -EndDate The EndDate parameter specifies the end date of the date range. It is recommended to limit the start-end date range to a range of hours. i.e. an ~ 5 to 7 hours. -TimeoutAfter The TimeoutAfter parameter specifies the number of minutes before the script stop working. This is to make sure that the script does not run for infinity. The default value is 30 minutes. -Threshold The Threshold parameter specifies the min threshold for the received limit. It is used to filter the hourly aggregation. The default value is 3600 messages. Examples $results = Compute-TopExoRecipientsFromMessageTrace -StartDate ( Get-Date ). AddHours (- 7 ) -EndDate ( Get-Date ) Output $results.TopRecipients : hourly report for top recipients over the threshold $results.HourlyReport : hourly aggregated message events without applying the threshold $results.MessageTraceEevents: all downloaded message trace events without aggregations","title":"Compute-TopExoRecipientsFromMessageTrace"},{"location":"Transport/Compute-TopExoRecipientsFromMessageTrace/#compute-topexorecipientsfrommessagetrace","text":"Download the latest release: Compute-TopExoRecipientsFromMessageTrace.ps1 This script aggregates message trace events hourly and generates a report with the top o365 recipients","title":"Compute-TopExoRecipientsFromMessageTrace"},{"location":"Transport/Compute-TopExoRecipientsFromMessageTrace/#parameters","text":"-StartDate The StartDate parameter specifies the end date of the date range -EndDate The EndDate parameter specifies the end date of the date range. It is recommended to limit the start-end date range to a range of hours. i.e. an ~ 5 to 7 hours. -TimeoutAfter The TimeoutAfter parameter specifies the number of minutes before the script stop working. This is to make sure that the script does not run for infinity. The default value is 30 minutes. -Threshold The Threshold parameter specifies the min threshold for the received limit. It is used to filter the hourly aggregation. The default value is 3600 messages.","title":"Parameters"},{"location":"Transport/Compute-TopExoRecipientsFromMessageTrace/#examples","text":"$results = Compute-TopExoRecipientsFromMessageTrace -StartDate ( Get-Date ). AddHours (- 7 ) -EndDate ( Get-Date )","title":"Examples"},{"location":"Transport/Compute-TopExoRecipientsFromMessageTrace/#output","text":"$results.TopRecipients : hourly report for top recipients over the threshold $results.HourlyReport : hourly aggregated message events without applying the threshold $results.MessageTraceEevents: all downloaded message trace events without aggregations","title":"Output"},{"location":"Transport/ReplayQueueDatabases/","text":"ReplayQueueDatabases Download the latest release: ReplayQueueDatabases.ps1 When Transport crashes, in some scenarios it will move the current queue database to Messaging.old- and create a new empty database. The old database is usually not needed, unless shadow redundancy was failing. In that case, it can be useful to drain the old queue file to recover those messages. This script automates the process of replaying many old queue files created by a series of crashes. Syntax ReplayQueueDatabases . ps1 [ -MaxAgeInDays < int >] [ -RemoveDeliveryDelayedMessages ] Parameters -MaxAgeInDays <Int32> Only replay queue databases newer than this date Required? false Position? 1 Default value 7 -RemoveDeliveryDelayedMessages [<SwitchParameter>] Attempt to remove delivery delay notifications so user mailboxes do not fill up with these while we replay old messages Required? false Position? named Default value False Usage The script must be run from Exchange Management Shell locally on the server where queue databases are being replayed. Active mailbox databases should be moved off and the server placed in maintenance mode prior to running the script. When the script is run, it takes the following actions. Read the QueueDatabasePath and QueueDatabaseLoggingPath from the EdgeTransport.exe.config file. If these do not match, the script exits. That type of configuration is not yet supported by this script. Search the QueueDatabasePath for any folders with names matching Message.old-*. Parse the date string in the folder name to determine if this folder is under the MaxAgeInDays. Any folders over the MaxAgeInDays are moved to the ReplaySkipped folder in the QueueDatabasePath. The EdgeTransport.exe.config is copied to EdgeTransport.exe.config.before-replay. Begin looping over the folders that were under MaxAgeInDays, starting with the most deeply nested folder. Check if the HubTransport component is in Draining state, and switch it to Draining if it is not. Stop the Transport services (MSExchangeTransport and MSExchangeFrontEndTransport). Move the current folder to be replayed to OldReplayQueue in the QueueDatabasePath. Start the Transport services. Check every 5 seconds if the queues clear. While waiting, run Remove-Message once a minute to remove any \"Delivery Delayed\" messages. Once queues are cleared, stop the transport services. Move OldQueueReplay to a folder inside of Replayed in the QueueDatabasePath, named Replayed-\\<original date on the folder>. Continue to the next folder. When finished with all the folders, stop the Transport services. Overwrite EdgeTransport.exe.config with EdgeTransport.exe.config.before-replay. Start the Transport services. Notify the user that they must run the command to take the HubTransport component out of the Draining state when ready. Note that when the script is run without -Confirm:$false, it will prompt for nearly every step of this process. This is probably the best approach for most scenarios, so that each step of the script is visible and understood by the user. \"Yes to All\" can be used to remove most of the prompting within the script. However, even with \"Yes to All\", prompts to start and stop services between replays of each database will occur. If there are many databases to replay, -Confirm:$false can be used to remove all prompting. Cleanup If the script fails out or is terminated in the middle, the following steps may be needed in order to run the script again and/or return the environment to a normal state. OldQueueReplay may have been left in place. If it is not clear whether this database was already replayed, Transport services should be started while QueueDatabasePath and QueueDatabaseLoggingPath in EdgeTransport.exe.config still point to OldQueueReplay. Once the queues have drained, Transport can be stopped, and OldQueueReplay can be moved to the Replayed folder. The EdgeTransport.exe.config may be left pointing to OldQueueReplay. To fix it, replace EdgeTransport.exe.config with the EdgeTransport.exe.config.before-replay, which was the backup of the file prior to any changes. MSExchangeTransport and MSExchangeFrontEndTransport may need to be started. The HubTransport component must be set back to Active.","title":"ReplayQueueDatabases"},{"location":"Transport/ReplayQueueDatabases/#replayqueuedatabases","text":"Download the latest release: ReplayQueueDatabases.ps1 When Transport crashes, in some scenarios it will move the current queue database to Messaging.old- and create a new empty database. The old database is usually not needed, unless shadow redundancy was failing. In that case, it can be useful to drain the old queue file to recover those messages. This script automates the process of replaying many old queue files created by a series of crashes.","title":"ReplayQueueDatabases"},{"location":"Transport/ReplayQueueDatabases/#syntax","text":"ReplayQueueDatabases . ps1 [ -MaxAgeInDays < int >] [ -RemoveDeliveryDelayedMessages ]","title":"Syntax"},{"location":"Transport/ReplayQueueDatabases/#parameters","text":"-MaxAgeInDays <Int32> Only replay queue databases newer than this date Required? false Position? 1 Default value 7 -RemoveDeliveryDelayedMessages [<SwitchParameter>] Attempt to remove delivery delay notifications so user mailboxes do not fill up with these while we replay old messages Required? false Position? named Default value False","title":"Parameters"},{"location":"Transport/ReplayQueueDatabases/#usage","text":"The script must be run from Exchange Management Shell locally on the server where queue databases are being replayed. Active mailbox databases should be moved off and the server placed in maintenance mode prior to running the script. When the script is run, it takes the following actions. Read the QueueDatabasePath and QueueDatabaseLoggingPath from the EdgeTransport.exe.config file. If these do not match, the script exits. That type of configuration is not yet supported by this script. Search the QueueDatabasePath for any folders with names matching Message.old-*. Parse the date string in the folder name to determine if this folder is under the MaxAgeInDays. Any folders over the MaxAgeInDays are moved to the ReplaySkipped folder in the QueueDatabasePath. The EdgeTransport.exe.config is copied to EdgeTransport.exe.config.before-replay. Begin looping over the folders that were under MaxAgeInDays, starting with the most deeply nested folder. Check if the HubTransport component is in Draining state, and switch it to Draining if it is not. Stop the Transport services (MSExchangeTransport and MSExchangeFrontEndTransport). Move the current folder to be replayed to OldReplayQueue in the QueueDatabasePath. Start the Transport services. Check every 5 seconds if the queues clear. While waiting, run Remove-Message once a minute to remove any \"Delivery Delayed\" messages. Once queues are cleared, stop the transport services. Move OldQueueReplay to a folder inside of Replayed in the QueueDatabasePath, named Replayed-\\<original date on the folder>. Continue to the next folder. When finished with all the folders, stop the Transport services. Overwrite EdgeTransport.exe.config with EdgeTransport.exe.config.before-replay. Start the Transport services. Notify the user that they must run the command to take the HubTransport component out of the Draining state when ready. Note that when the script is run without -Confirm:$false, it will prompt for nearly every step of this process. This is probably the best approach for most scenarios, so that each step of the script is visible and understood by the user. \"Yes to All\" can be used to remove most of the prompting within the script. However, even with \"Yes to All\", prompts to start and stop services between replays of each database will occur. If there are many databases to replay, -Confirm:$false can be used to remove all prompting.","title":"Usage"},{"location":"Transport/ReplayQueueDatabases/#cleanup","text":"If the script fails out or is terminated in the middle, the following steps may be needed in order to run the script again and/or return the environment to a normal state. OldQueueReplay may have been left in place. If it is not clear whether this database was already replayed, Transport services should be started while QueueDatabasePath and QueueDatabaseLoggingPath in EdgeTransport.exe.config still point to OldQueueReplay. Once the queues have drained, Transport can be stopped, and OldQueueReplay can be moved to the Replayed folder. The EdgeTransport.exe.config may be left pointing to OldQueueReplay. To fix it, replace EdgeTransport.exe.config with the EdgeTransport.exe.config.before-replay, which was the backup of the file prior to any changes. MSExchangeTransport and MSExchangeFrontEndTransport may need to be started. The HubTransport component must be set back to Active.","title":"Cleanup"}]}