# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

<#
.SYNOPSIS
    This script can be used to remove vulnerable file types from the FIP-FS configuration.xml file.
.DESCRIPTION
    The script removes vulnerable file types from the FIP-FS configuration.xml file.
    It can also be used to add these file types back. It also allows you to completely disable the usage of the OutsideInModule
    or enable it back.
.PARAMETER Configuration
    Use this parameter to specify the configuration that should be changed.
    Values that can be passed with this parameter are: ConfigureOutsideIn and ConfigureFileTypes
.PARAMETER Action
    Use this parameter to specify the action that should be performed.
    Values that can be passed with this parameter are: Allow, Block
.PARAMETER ScriptUpdateOnly
    This optional parameter allows you to only update the script without performing any other actions.
.PARAMETER SkipVersionCheck
    This optional parameter allows you to skip the automatic version check and script update.
.EXAMPLE
    PS C:\> .\CVE-2024-xxxxx.ps1 -Configuration ConfigureFileTypes -Action Block
    It will block the vulnerable file types in the FIP-FS configuration file.
.EXAMPLE
    PS C:\> .\CVE-2024-xxxxx.ps1 -Configuration ConfigureFileTypes -Action Allow
    It will add the vulnerable file types back to the the FIP-FS configuration file.
.EXAMPLE
    PS C:\> .\CVE-2024-xxxxx.ps1 -Configuration ConfigureOutsideIn -Action Block
    It will disable the OutsideInModule in the FIP-FS configuration file.
.EXAMPLE
    PS C:\> .\CVE-2024-xxxxx.ps1 -Configuration ConfigureOutsideIn -Action Allow
    It will enable the OutsideInModule in the FIP-FS configuration file.
#>

[CmdletBinding(DefaultParameterSetName = "Default", SupportsShouldProcess = $true, ConfirmImpact = 'High')]
param(
    [Parameter(Mandatory = $false, ParameterSetName = "Default")]
    [ValidateSet("ConfigureOutsideIn", "ConfigureFileTypes")]
    [string]$Configuration = "ConfigureFileTypes",

    [Parameter(Mandatory = $false, ParameterSetName = "Default")]
    [ValidateSet("Allow", "Block")]
    [string]$Action = "Block",

    [Parameter(Mandatory = $false, ParameterSetName = "ScriptUpdateOnly")]
    [switch]$ScriptUpdateOnly,

    [Parameter(Mandatory = $false, ParameterSetName = "Default")]
    [switch]$SkipVersionCheck
)

begin {
    $BuildVersion = ""

    . $PSScriptRoot\ConfigurationAction\Invoke-OutsideInModuleAction.ps1
    . $PSScriptRoot\..\..\..\Shared\OutputOverrides\Write-Host.ps1
    . $PSScriptRoot\..\..\..\Shared\OutputOverrides\Write-Verbose.ps1
    . $PSScriptRoot\..\..\..\Shared\ScriptUpdateFunctions\Test-ScriptVersion.ps1
    . $PSScriptRoot\..\..\..\Shared\Confirm-Administrator.ps1
    . $PSScriptRoot\..\..\..\Shared\LoggerFunctions.ps1
    . $PSScriptRoot\..\..\..\Shared\Show-Disclaimer.ps1

    function Write-VerboseLog ($Message) {
        $Script:Logger = $Script:Logger | Write-LoggerInstance $Message
    }

    function Write-HostLog ($Message) {
        $Script:Logger = $Script:Logger | Write-LoggerInstance $Message
    }

    $loggerInstanceParams = @{
        LogName                  = "CVE-2024-xxxxx-$((Get-Date).ToString("yyyyMMddhhmmss"))-Debug"
        AppendDateTimeToFileName = $false
        ErrorAction              = "SilentlyContinue"
    }

    $Script:Logger = Get-NewLoggerInstance @loggerInstanceParams

    SetWriteHostAction ${Function:Write-HostLog}
    SetWriteVerboseAction ${Function:Write-VerboseLog}

    $fileTypesDictionary = New-Object 'System.Collections.Generic.Dictionary[string, array]'

    # Add all vulnerable file types here that should be blocked
    $fileTypesDictionary.Add("Excel", @("ExcelStorage"))
    $fileTypesDictionary.Add("PreferOutsideIn", @("Html", "Pdf"))
} end {
    if (-not(Confirm-Administrator)) {
        Write-Host "The script needs to be executed in elevated mode. Start the PowerShell as an administrator." -ForegroundColor Yellow
        exit
    }

    $versionsUrl = "https://aka.ms/CVE-2024-xxxxx-VersionsUrl"
    Write-Host ("CVE-2024-xxxxx script version $($BuildVersion)") -ForegroundColor Green

    if ($ScriptUpdateOnly) {
        switch (Test-ScriptVersion -AutoUpdate -VersionsUrl $versionsUrl -Confirm:$false) {
            ($true) { Write-Host ("Script was successfully updated") -ForegroundColor Green }
            ($false) { Write-Host ("No update of the script performed") -ForegroundColor Yellow }
            default { Write-Host ("Unable to perform ScriptUpdateOnly operation") -ForegroundColor Red }
        }
        return
    }

    if ((-not($SkipVersionCheck)) -and
        (Test-ScriptVersion -AutoUpdate -VersionsUrl $versionsUrl -Confirm:$false)) {
        Write-Host ("Script was updated. Please re-run the command") -ForegroundColor Yellow
        return
    }

    try {
        $invokeOutsideInModuleActionParams = @{
            Configuration = $Configuration
            Action        = $Action
        }

        if ($Configuration -eq "ConfigureFileTypes") {
            $invokeOutsideInModuleActionParams.Add("FileTypesDictionary", $fileTypesDictionary)
        }

        Invoke-OutsideInModuleAction @invokeOutsideInModuleActionParams
    } finally {
        Write-Host ""
        Write-Host "Do you have feedback regarding the script? Please let us know: ExToolsFeedback@microsoft.com."
    }
}
