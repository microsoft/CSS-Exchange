<?xml version="1.0" encoding="iso-8859-1"?>
<Definition xsi:noNamespaceSchemaLocation="..\..\WorkItemDefinition.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <MaintenanceDefinition
    AssemblyPath="Microsoft.Exchange.Monitoring.ActiveMonitoring.Local.Components.dll"
    TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Antimalware.AntimalwareDiscovery"
    Name="Antimalware.Maintenance.Workitem"
    ServiceName="Antimalware"
    RecurrenceIntervalSeconds="0"
    TimeoutSeconds="600"
    MaxRetryAttempts="3"
    Enabled ="true" >
    <!-- To override the default values, add/modify the corresponding extension attributes.
    <ExtensionAttributes
      CleanupFolderResponderFolderPaths = "D:\ExchangeTemp\TransportCts\UnifiedContent;C:\Windows\Temp;C:\TransportRoles\data\Temp"
      CleanupFolderResponderFileRetentionPeriod = "05:00:00"
      CleanupFolderResponderRecurrenceIntervalSeconds = "00:10:00"
    />-->
    <ExtensionAttributes
      CleanupFolderResponderFolderPaths = "D:\ExchangeTemp\TransportCts\UnifiedContent;C:\Windows\Temp\UnifiedContent;D:\Program Files\Microsoft\Exchange Server\V15\TransportRoles\data\Temp\UnifiedContent"
      CleanupFolderResponderFileRetentionPeriod = "1.00:00:00"
      CleanupFolderResponderRecurrenceIntervalSeconds = "04:00:00"
    />
  </MaintenanceDefinition>

  <!--
  For OverallConsecutiveSampleValueAboveThresholdMonitor,
            TimeoutSeconds = 30;
            SecondaryMonitoringThreshold = numberOfSamples;
            MonitoringIntervalSeconds = (numberOfSamples + 1) * 300; ////EDS sends data to us every 5 minutes
            RecurrenceIntervalSeconds = monitor.MonitoringIntervalSeconds / 2;
  -->
  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-Malware Agent"
      Counter="Messages with Fewer Engine Scans than Minimum Threshold"
      Instance="*"
      FfoDataCenter="true"
      ExoDataCenter="true"
      OnPremise="false">
      <Monitor
         TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
         Name="MessagesWithFewerEngineScansThanMinimumMonitor"
         ComponentName="AMScanners"
         MonitoringThreshold="60"
         SecondaryMonitoringThreshold="3"
         Enabled="true">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="450"/>
        </StateTransitions>
      </Monitor>

      <Responder
         TypeName="RestartServiceResponder"
         Name="MessagesWithFewerEngineScansThanMinimumRestartServiceResponder"
         ComponentName="AMScanners"
         AlertMask = "MessagesWithFewerEngineScansThanMinimumMonitor"
         RecurrenceIntervalSeconds= "30"
         TimeoutSeconds="30"
         WaitIntervalSeconds="600"
         TargetHealthState="Degraded"
         TargetResource="FIPS"
         Enabled="false">
          <ExtensionAttributes
            WindowsServiceName="FMS"
            ServiceStopTimeout="60"
            ServiceStartTimeout="120"
            ServiceStartDelay="2"
            MinimumSecondsBetweenRestarts="7200"
            MaximumAllowedRestartsInAnHour="2"
            MaximumAllowedRestartsInADay="10"/>
      </Responder>

      <Responder
         TypeName="EscalateResponder"
         Name="MessagesWithFewerEngineScansThanMinimumEscalateResponder"
         ComponentName="AMScanners"
         AlertTypeId="MessagesWithFewerEngineScansThanMinimumMonitor"
         AlertMask="MessagesWithFewerEngineScansThanMinimumMonitor"
         TargetHealthState="Unhealthy"
         EscalationTeam="FIPS"
         EscalationLevel="Urgent"
         EscalationSubjectUnhealthy="AntimalwareAgent Alert: The messages are being scanned by fewer engines than minimum."
         EscalationMessageUnhealthy="AntimalwareAgent Alert: The messages are being scanned by fewer engines than minimum." />

      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="MessagesWithFewerEngineScansThanMinimumCollectFIPSLogsResponder"
        ComponentName="AMScanners"
        AlertTypeId="MessagesWithFewerEngineScansThanMinimumMonitor"
        AlertMask="MessagesWithFewerEngineScansThanMinimumMonitor"
        TargetHealthState="Unhealthy"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-Malware Agent"
      Counter="Messages with Fewer Engine Scans than Expected"
      Instance="*"
      FfoDataCenter="true"
      ExoDataCenter="true"
      OnPremise="false">
      <Monitor
         TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
         Name="MessagesWithFewerEngineScansThanExpectedMonitor"
         ComponentName="AM_Scheduled"
         MonitoringThreshold="60"
         SecondaryMonitoringThreshold="3"
         Enabled="true">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="450"/>
        </StateTransitions>
      </Monitor>

      <Responder
         TypeName="RestartServiceResponder"
         Name="MessagesWithFewerEngineScansThanExpectedRestartServiceResponder"
         ComponentName="AM_Scheduled"
         AlertMask = "MessagesWithFewerEngineScansThanExpectedMonitor"
         RecurrenceIntervalSeconds= "30"
         TimeoutSeconds="30"
         WaitIntervalSeconds="600"
         TargetHealthState="Degraded"
         TargetResource="FIPS"
         Enabled="false">
        <ExtensionAttributes
          WindowsServiceName="FMS"
          ServiceStopTimeout="60"
          ServiceStartTimeout="120"
          ServiceStartDelay="2"
          MinimumSecondsBetweenRestarts="7200"
          MaximumAllowedRestartsInAnHour="2"
          MaximumAllowedRestartsInADay="10"/>
      </Responder>

      <Responder
         TypeName="EscalateResponder"
         Name="MessagesWithFewerEngineScansThanExpectedEscalateResponder"
         ComponentName="AM_Scheduled"
         AlertTypeId="MessagesWithFewerEngineScansThanExpectedMonitor"
         AlertMask="MessagesWithFewerEngineScansThanExpectedMonitor"
         TargetHealthState="Unhealthy"
         TargetResource="FIPS"
         EscalationTeam="FIPS"
         EscalationLevel="Scheduled"
         EscalationSubjectUnhealthy="AntimalwareAgent Alert: The messages are being scanned by fewer engines than expected."
         EscalationMessageUnhealthy="AntimalwareAgent Alert: The messages are being scanned by fewer engines than expected." />

      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="MessagesWithFewerEngineScansThanExpectedCollectFIPSLogsResponder"
        ComponentName="AMScanners"
        AlertTypeId="MessagesWithFewerEngineScansThanExpectedMonitor"
        AlertMask="MessagesWithFewerEngineScansThanExpectedMonitor"
        TargetHealthState="Unhealthy"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-malware Agent"
      Counter="Scan Time per Message - 90th Percentile"
      Instance="*">
      <Monitor
        TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
        Name="ScanTimeMonitor"
        ComponentName="AM_Scheduled"
        MonitoringThreshold="5000"
        SecondaryMonitoringThreshold="3"
        Enabled="false">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="450"/>
        </StateTransitions>
      </Monitor>
      <Responder
        TypeName="RestartServiceResponder"
        Name="ScanTimeRestartServiceResponder"
        ComponentName="AM_Scheduled"
        AlertMask="ScanTimeMonitor"
        TargetHealthState="Degraded"
        TargetResource="FIPS"
        WaitIntervalSeconds="600"
        Enabled="false">
        <ExtensionAttributes
          WindowsServiceName="FMS"
          ServiceStopTimeout="60"
          ServiceStartTimeout="120"
          ServiceStartDelay="2"
          MinimumSecondsBetweenRestarts="7200"
          MaximumAllowedRestartsInAnHour="2"
          MaximumAllowedRestartsInADay="10"/>
      </Responder>
      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="ScanTimeCollectFIPSLogsResponder"
        ComponentName="AM_Scheduled"
        AlertTypeId="ScanTimeMonitor"
        AlertMask="ScanTimeMonitor"
        TargetHealthState="Unhealthy"/>
      <Responder
        TypeName="EscalateResponder"
        Name="ScanTimeEscalateResponder"
        ComponentName="AM_Scheduled"
        AlertTypeId="ScanTimeMonitor"
        AlertMask="ScanTimeMonitor"
        TargetHealthState="Unhealthy"
        TargetResource="FIPS"
        EscalationTeam="FIPS"
        EscalationSubjectUnhealthy="Malware filtering is taking too long (90th percentile)"
        EscalationMessageUnhealthy="Malware filtering is taking too long (90th percentile)"
        EscalationLevel="Scheduled"
        Enabled="true"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-malware Agent"
      Counter="Messages with Scan Error Percentage"
      Instance="*">
      <Monitor
        TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
        Name="ScanErrorsMonitor"
        ComponentName="AMScanError"
        MonitoringThreshold="25"
        SecondaryMonitoringThreshold="8"
        Enabled="true">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="780"/>
        </StateTransitions>
      </Monitor>
      <Responder
        TypeName="RestartServiceResponder"
        Name="ScanErrorsRestartServiceResponder"
        ComponentName="AMScanError"
        AlertMask="ScanErrorsMonitor"
        TargetHealthState="Degraded"
        TargetResource="FIPS"
        WaitIntervalSeconds="600"
        Enabled="true">
        <ExtensionAttributes
          WindowsServiceName="FMS"
          ServiceStopTimeout="60"
          ServiceStartTimeout="180"
          ServiceStartDelay="2"
          MinimumSecondsBetweenRestarts="7200"
          MaximumAllowedRestartsInAnHour="2"
          MaximumAllowedRestartsInADay="10"/>
      </Responder>
      <Responder
        TypeName="EscalateResponder"
        Name="ScanErrorsEscalateResponder"
        ComponentName="AMScanError"
        AlertTypeId="ScanErrorsMonitor"
        AlertMask="ScanErrorsMonitor"
        TargetHealthState="Unhealthy"
        TargetResource="FIPS"
        EscalationTeam="FIPS"
        EscalationSubjectUnhealthy="Malware filtering is returning too many scan errors"
        EscalationMessageUnhealthy="Malware filtering is returning too many scan errors"
        EscalationLevel="Urgent"
        Enabled="true"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-malware Agent"
      Counter="Messages Containing Malware Percentage"
      Instance="*">
      <Monitor
        TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
        Name="MessagesWithMalwareMonitor"
        ComponentName="AMScanError"
        MonitoringThreshold="90"
        SecondaryMonitoringThreshold="4"
        Enabled="true">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="600"/>
        </StateTransitions>
      </Monitor>
      <Responder
        TypeName="RestartServiceResponder"
        Name="MessagesWithMalwareRestartServiceResponder"
        ComponentName="AMScanError"
        AlertMask="MessagesWithMalwareMonitor"
        TargetHealthState="Degraded"
        TargetResource="FIPS"
        WaitIntervalSeconds="600"
        Enabled="true">
        <ExtensionAttributes
          WindowsServiceName="FMS"
          ServiceStopTimeout="60"
          ServiceStartTimeout="120"
          ServiceStartDelay="2"
          MinimumSecondsBetweenRestarts="7200"
          MaximumAllowedRestartsInAnHour="2"
          MaximumAllowedRestartsInADay="10"/>
      </Responder>
      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="MessagesWithMalwareCollectFIPSLogsResponder"
        ComponentName="AMScanError"
        AlertTypeId="MessagesWithMalwareMonitor"
        AlertMask="MessagesWithMalwareMonitor"
        TargetHealthState="Unhealthy"/>
      <Responder
        TypeName="EscalateResponder"
        Name="MessagesWithMalwareEscalateResponder"
        ComponentName="AMScanError"
        AlertTypeId="MessagesWithMalwareMonitor"
        AlertMask="MessagesWithMalwareMonitor"
        TargetHealthState="Unhealthy"
        TargetResource="FIPS"
        EscalationTeam="FIPS"
        EscalationSubjectUnhealthy="An abnormally high rate of malware is being detected"
        EscalationMessageUnhealthy="An abnormally high rate of malware is being detected"
        EscalationLevel="Urgent"
        Enabled="true"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-malware Agent"
      Counter="Messages Deferred Percentage"
      Instance="*">
      <Monitor
        TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
        Name="MessagesDeferredMonitor"
        ComponentName="AMScanningDown"
        MonitoringThreshold="25"
        SecondaryMonitoringThreshold="10"
        Enabled="true">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="450"/>
        </StateTransitions>
      </Monitor>
      <Responder
        TypeName="RestartServiceResponder"
        Name="MessagesDeferredRestartServiceResponder"
        ComponentName="AMScanningDown"
        AlertMask="MessagesDeferredMonitor"
        TargetHealthState="Degraded"
        TargetResource="FIPS"
        WaitIntervalSeconds="600"
        Enabled="false">
        <ExtensionAttributes
          WindowsServiceName="FMS"
          ServiceStopTimeout="60"
          ServiceStartTimeout="120"
          ServiceStartDelay="2"
          MinimumSecondsBetweenRestarts="7200"
          MaximumAllowedRestartsInAnHour="2"
          MaximumAllowedRestartsInADay="10"/>
      </Responder>
      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="MessagesDeferredCollectFIPSLogsResponder"
        ComponentName="AMScanningDown"
        AlertTypeId="MessagesDeferredMonitor"
        AlertMask="MessagesDeferredMonitor"
        TargetHealthState="Unhealthy"/>
      <Responder
        TypeName="EscalateResponder"
        Name="MessagesDeferredEscalateResponder"
        ComponentName="AMMessagesDeferred"
        AlertTypeId="MessagesDeferredMonitor"
        AlertMask="MessagesDeferredMonitor"
        TargetHealthState="Unhealthy"
        TargetResource="FIPS"
        EscalationTeam="FIPS"
        EscalationSubjectUnhealthy="Malware filtering is deferring too many messages"
        EscalationMessageUnhealthy="Malware filtering is deferring too many messages"
        EscalationLevel="Urgent"
        Enabled="true"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-malware Agent"
      Counter="Messages Deferred Percentage"
      Instance="*">
      <Monitor
        TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
        Name="MessagesSlowDefersMonitor"
        ComponentName="AMMessagesDeferred"
        MonitoringThreshold="15"
        SecondaryMonitoringThreshold="20"
        Enabled="true" />
      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="MessagesSlowDefersCollectFIPSLogsResponder"
        ComponentName="AMMessagesDeferred"
        AlertTypeId="MessagesSlowDefersMonitor"
        AlertMask="MessagesSlowDefersMonitor"
        TargetHealthState="Unhealthy"/>
      <Responder
        TypeName="EscalateResponder"
        Name="MessagesSlowDefersEscalateResponder"
        ComponentName="AMMessagesDeferred"
        AlertTypeId="MessagesSlowDefersMonitor"
        AlertMask="MessagesSlowDefersMonitor"
        TargetHealthState="Unhealthy"
        TargetResource="FIPS"
        EscalationTeam="FIPS"
        EscalationSubjectUnhealthy="Malware filtering has been deferring 15% of messages for more than 1.5 hours"
        EscalationMessageUnhealthy="Malware filtering has been deferring 15% of messages for more than 1.5 hours"
        EscalationLevel="Urgent"
        Enabled="true"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-malware Agent"
      Counter="Recovery Store Percentage Full"
      Instance="*">
      <Monitor
        TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
        Name="RecoveryStoreFullMonitor"
        ComponentName="AMScanError"
        MonitoringThreshold="90"
        SecondaryMonitoringThreshold="3"
        Enabled="false">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="450"/>
        </StateTransitions>
      </Monitor>
      <Responder
        TypeName="RestartServiceResponder"
        Name="RecoveryStoreFullRestartServiceResponder"
        ComponentName="AMScanError"
        AlertMask="RecoveryStoreFullMonitor"
        TargetHealthState="Degraded"
        TargetResource="FIPS"
        WaitIntervalSeconds="600"
        Enabled="false">
        <ExtensionAttributes
          WindowsServiceName="FMS"
          ServiceStopTimeout="60"
          ServiceStartTimeout="120"
          ServiceStartDelay="2"
          MinimumSecondsBetweenRestarts="7200"
          MaximumAllowedRestartsInAnHour="2"
          MaximumAllowedRestartsInADay="10"/>
      </Responder>
      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="RecoveryStoreFullCollectFIPSLogsResponder"
        ComponentName="AMScanError"
        AlertTypeId="RecoveryStoreFullMonitor"
        AlertMask="RecoveryStoreFullMonitor"
        TargetHealthState="Unhealthy"/>
      <Responder
        TypeName="EscalateResponder"
        Name="RecoveryStoreFullEscalateResponder"
        ComponentName="AMScanError"
        AlertTypeId="RecoveryStoreFullMonitor"
        AlertMask="RecoveryStoreFullMonitor"
        TargetHealthState="Unhealthy"
        TargetResource="FIPS"
        EscalationTeam="FIPS"
        EscalationSubjectUnhealthy="Malware filtering recovery store is getting too full"
        EscalationMessageUnhealthy="Malware filtering recovery store is getting too full"
        EscalationLevel="Urgent"
        Enabled="true"/>
    </Counter>
  </PerformanceCounters>

  <PerformanceCounters>
    <Counter
      Object="MSExchange Anti-malware Agent"
      Counter="Messages Written to Recovery Store"
      Instance="*">
      <Monitor
        TypeName="OverallConsecutiveSampleValueAboveThresholdMonitor"
        Name="MessagesInRecoveryStoreMonitor"
        ComponentName="AMScanError"
        MonitoringThreshold="25"
        SecondaryMonitoringThreshold="3"
        Enabled="false">
        <StateTransitions>
          <Transition ToState="Degraded" TimeoutInSeconds="0"/>
          <Transition ToState="Unhealthy" TimeoutInSeconds="450"/>
        </StateTransitions>
      </Monitor>
      <Responder
        TypeName="RestartServiceResponder"
        Name="MessagesInRecoveryStoreRestartServiceResponder"
        ComponentName="AMScanError"
        AlertMask="MessagesInRecoveryStoreMonitor"
        TargetHealthState="Degraded"
        TargetResource="FIPS"
        WaitIntervalSeconds="600"
        Enabled="false">
        <ExtensionAttributes
          WindowsServiceName="FMS"
          ServiceStopTimeout="60"
          ServiceStartTimeout="120"
          ServiceStartDelay="2"
          MinimumSecondsBetweenRestarts="7200"
          MaximumAllowedRestartsInAnHour="2"
          MaximumAllowedRestartsInADay="10"/>
      </Responder>
      <Responder
        TypeName="Microsoft.Exchange.Monitoring.ActiveMonitoring.Fips.Responders.CollectFIPSLogsResponder"
        Name="MessagesInRecoveryStoreCollectFIPSLogsResponder"
        ComponentName="AMScanError"
        AlertTypeId="MessagesInRecoveryStoreMonitor"
        AlertMask="MessagesInRecoveryStoreMonitor"
        TargetHealthState="Unhealthy"/>
      <Responder
        TypeName="EscalateResponder"
        Name="MessagesInRecoveryStoreEscalateResponder"
        ComponentName="AMScanError"
        AlertTypeId="MessagesInRecoveryStoreMonitor"
        AlertMask="MessagesInRecoveryStoreMonitor"
        TargetHealthState="Unhealthy"
        TargetResource="FIPS"
        EscalationTeam="FIPS"
        EscalationSubjectUnhealthy="Malware filtering is sending too many messages to the recovery store"
        EscalationMessageUnhealthy="Malware filtering is sending too many messages to the recovery store"
        EscalationLevel="Urgent"
        Enabled="true"/>
    </Counter>
  </PerformanceCounters>

  <CustomWorkItem
      RecipientFeatureTag="AntimalwareClean"
      SenderFeatureTag="AntimalwareClean"
      FfoDataCenter="true"
      ExoDataCenter="true"
      OnPremise="false"
      DataCenterDedicated="false">
    <Probe
        TypeName="Microsoft.Forefront.Monitoring.ActiveMonitoring.Smtp.Probes.TransportSmtpProbe"
        Name="AntimalwareCleanProbe"
        ComponentName="AMSMTPProbe"
        RecurrenceIntervalSeconds="1800"
        TimeoutSeconds="300"
        MaxRetryAttempts="1"
        Enabled ="true">
      <ExtensionAttributes>
        <WorkContext>
          <SendMail SmtpServerUri="127.0.0.1" SLA="00:03:00" Port="25" Timeout="240" Direction="Incoming" IgnoreSendMailFailure="true">
            <MailFrom Select="1"/> <!-- select sender as per feature tag-->
            <MailTo Select="1"/> <!-- select any one mailbox -->
            <!--let the GenericWorkItem populate automatically from test tenant-->
            <Message Subject="TestCleanMail" Body="test">
              <Header Tag="X-Exchange-Probe-Drop-Message" Value="FrontEnd-CAT-250" />
            </Message>
          </SendMail>
          <Match>
            <Notification Type="AgentInfo" MatchType="SubString" Value="AMA[SUM|v=0" Mandatory="false"/>
          </Match>
        </WorkContext>
      </ExtensionAttributes>
    </Probe>
    <Monitor
        TypeName="OverallConsecutiveProbeFailuresMonitor"
        ComponentName="AMSMTPProbe"
        Name="AntimalwareCleanMonitor"
        SampleMask="AntimalwareCleanProbe"
        RecurrenceIntervalSeconds= "0"
        MonitoringIntervalSeconds="5400"
        MaxRetryAttempts = "0"
        MonitoringThreshold = "3"/>
    <Responder
        TypeName="EscalateResponder"
        Name="AntimalwareCleanResponder"
        ComponentName="AMSMTPProbe"
        AlertTypeId="AntimalwareCleanMonitor"
        AlertMask="AntimalwareCleanMonitor"
        TargetResource="AMAgent"
        TargetHealthState="None"
        EscalationTeam="FIPS"
        EscalationLevel="Urgent"
        EscalationSubjectUnhealthy="Antimalware Alert: AntimalwareClean failed"
        EscalationMessageUnhealthy="Antimalware Alert: AntimalwareClean failed
        &lt;br/&gt;Error:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;
        &lt;br/&gt;Exception:&lt;pre&gt;{Probe.Exception}&lt;/pre&gt;
        &lt;br/&gt;FailureContext:&lt;pre&gt;{Probe.FailureContext}&lt;/pre&gt;
        &lt;br/&gt;ExecutionContext:&lt;pre&gt;{Probe.ExecutionContext}&lt;/pre&gt;"
        Enabled="true"/>
  </CustomWorkItem>

  <CustomWorkItem
      RecipientFeatureTag="AntimalwareBlockAction"
      SenderFeatureTag="AntimalwareBlockAction"
      FfoDataCenter="true"
      ExoDataCenter="true"
      OnPremise="false"
      DataCenterDedicated="false">
    <Probe
        TypeName="Microsoft.Forefront.Monitoring.ActiveMonitoring.Smtp.Probes.TransportSmtpProbe"
        Name="AntimalwareBlockActionProbe"
        ComponentName="AMSMTPProbe"
        RecurrenceIntervalSeconds="1800"
        TimeoutSeconds="300"
        MaxRetryAttempts="1"
        Enabled ="true">
      <ExtensionAttributes>
        <WorkContext>
          <SendMail SmtpServerUri="127.0.0.1" SLA="00:03:00" Port="25" Timeout="240" Direction="Incoming" IgnoreSendMailFailure="true">
            <MailFrom Select="1"/> <!-- select sender as per feature tag-->
            <MailTo Select="1"/> <!-- select any one mailbox -->
            <!--let the GenericWorkItem populate automatically from test tenant-->
            <Message Subject="TestBlockAction" Body="test">
              <Attachment Filename="eicar" />
              <Header Tag="X-Exchange-Probe-Drop-Message" Value="FrontEnd-CAT-250" />
            </Message>
          </SendMail>
          <Match>
            <Notification Type="AgentInfo" MatchType="SubString" Value="AMA[SUM|v=1|action=b" Mandatory="false"/>
          </Match>
        </WorkContext>
      </ExtensionAttributes>
    </Probe>
    <Monitor
        TypeName="OverallConsecutiveProbeFailuresMonitor"
        ComponentName="AMSMTPProbe"
        Name="AntimalwareBlockActionMonitor"
        SampleMask="AntimalwareBlockActionProbe"
        RecurrenceIntervalSeconds= "0"
        MonitoringIntervalSeconds="5400"
        MonitoringThreshold = "3"/>
    <Responder
        TypeName="EscalateResponder"
        Name="AntimalwareBlockActionResponder"
        ComponentName="AMSMTPProbe"
        AlertTypeId="AntimalwareBlockActionMonitor"
        AlertMask="AntimalwareBlockActionMonitor"
        TargetResource="AMAgent"
        TargetHealthState="None"
        EscalationTeam="FIPS"
        EscalationLevel="Urgent"
        EscalationSubjectUnhealthy="Antimalware Alert: AntimalwareBlockAction failed"
        EscalationMessageUnhealthy="Antimalware Alert: AntimalwareBlockAction failed
        &lt;br/&gt;Error:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;
        &lt;br/&gt;Exception:&lt;pre&gt;{Probe.Exception}&lt;/pre&gt;
        &lt;br/&gt;FailureContext:&lt;pre&gt;{Probe.FailureContext}&lt;/pre&gt;
        &lt;br/&gt;ExecutionContext:&lt;pre&gt;{Probe.ExecutionContext}&lt;/pre&gt;"
        Enabled="true"/>
  </CustomWorkItem>

  <NTEvent>
    <Monitor
      TypeName="OverallXFailuresMonitor"
      Name="AMAgentNDRUrgentMonitor"
      ComponentName="AMScanError"
      EventNotificationServiceName="Antimalware"
      EventNotificationComponent="AntimalwareAgent.NDR"
      MonitoringIntervalSeconds="300"
      MonitoringThreshold="5"
      TimeoutSeconds="30"
      RecurrenceIntervalSeconds="300"
      Enabled="true"/>
    <Responder
      TypeName="EscalateResponder"
      Name="AMAgentNDRUrgentEscalateResponder"
      ComponentName="AMScanError"
      AlertTypeId="AMAgentNDRUrgentMonitor"
      AlertMask="AMAgentNDRUrgentMonitor"
      TargetHealthState="None"
      EscalationTeam="FIPS"
      EscalationSubjectUnhealthy="Antimalware Agent rejected more than 5 messages."
      EscalationMessageUnhealthy="
      &lt;br/&gt;Messages NDR'd in the last minute:&lt;pre&gt;{Monitor.TotalFailedCount}&lt;/pre&gt;
      &lt;br/&gt;Details:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;"
      EscalationLevel="Urgent"/>
  </NTEvent>

  <NTEvent>
    <Monitor
      TypeName="OverallXFailuresMonitor"
      Name="AMAgentPolicyDiscoveryMonitor"
      ComponentName="AMADError"
      EventNotificationServiceName="Antimalware"
      EventNotificationComponent="AntimalwareAgent.MalwareFilterPolicyDiscovery"
      MonitoringIntervalSeconds="60"
      MonitoringThreshold="1"
      TimeoutSeconds="30"
      RecurrenceIntervalSeconds="60"
      Enabled="true"/>
    <Responder
      TypeName="EscalateResponder"
      Name="AMAgentPolicyDiscoveryEscalateResponder"
      ComponentName="AMADError"
      AlertTypeId="AMAgentPolicyDiscoveryMonitor"
      AlertMask="AMAgentPolicyDiscoveryMonitor"
      TargetHealthState="None"
      EscalationTeam="FIPS"
      EscalationSubjectUnhealthy="Malware Filter Policy discovery failed."
      EscalationMessageUnhealthy="
      &lt;br/&gt;Malware Filter Policy discovery failed. Total number of errors during the last minute: &lt;pre&gt;{Monitor.TotalFailedCount}&lt;/pre&gt;
      &lt;br/&gt;Details:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;"
      EscalationLevel="Scheduled"/>
  </NTEvent>

  <NTEvent>
    <Monitor
      TypeName="OverallXFailuresMonitor"
      Name="AMAgentTenantConfigErrorMonitor"
      ComponentName="AMTenantConfigError"
      EventNotificationServiceName="Antimalware"
      EventNotificationComponent="AntimalwareAgent.TenantConfigurationError"
      MonitoringIntervalSeconds="300"
      MonitoringThreshold="1"
      TimeoutSeconds="30"
      RecurrenceIntervalSeconds="300"
      Enabled="true"/>
    <Responder
      TypeName="EscalateResponder"
      Name="AMAgentTenantConfigErrorEscalateResponder"
      ComponentName="AMTenantConfigError"
      AlertTypeId="AMAgentTenantConfigErrorMonitor"
      AlertMask="AMAgentTenantConfigErrorMonitor"
      TargetHealthState="None"
      EscalationTeam="FIPS"
      EscalationSubjectUnhealthy="Tenant Configuration Error"
      EscalationMessageUnhealthy="
      &lt;br/&gt;A tenant has atleast two Malware Filter Policies with the same name.&lt;pre&gt;{Monitor.TotalFailedCount}&lt;/pre&gt;
      &lt;br/&gt;Details:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;"
      EscalationLevel="UrgentInTraining"/>
  </NTEvent>

  <NTEvent>
    <Monitor
      TypeName="OverallXFailuresMonitor"
      Name="FlightingFailureMonitor"
      ComponentName="AMService"
      EventNotificationServiceName="Antimalware"
      EventNotificationComponent="AntimalwareAgent.FlightingFailure"
      MonitoringIntervalSeconds="60"
      MonitoringThreshold="1"
      TimeoutSeconds="30"
      RecurrenceIntervalSeconds="60"
      Enabled="true"/>
    <Responder
      TypeName="EscalateResponder"
      Name="FlightingFailureEscalateResponder"
      ComponentName="AMService"
      AlertTypeId="FlightingFailureMonitor"
      AlertMask="FlightingFailureMonitor"
      TargetHealthState="None"
      EscalationTeam="FIPS"
      EscalationSubjectUnhealthy="Failed to determine if AM agent is enabled or not."
      EscalationMessageUnhealthy="
      &lt;br/&gt;Failed to determine if AM agent V2 is enabled or not.
      &lt;br/&gt;Details:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;"
      EscalationLevel="Scheduled"/>
  </NTEvent>

  <NTEvent>
    <Monitor
      TypeName="OverallXFailuresMonitor"
      Name="AMAgentCategoryErrorMonitor"
      ComponentName="AMScanError"
      EventNotificationServiceName="Antimalware"
      EventNotificationComponent="AntimalwareAgent.CategoryError"
      MonitoringIntervalSeconds="300"
      MonitoringThreshold="5"
      TimeoutSeconds="30"
      RecurrenceIntervalSeconds="300"
      Enabled="true"/>
    <Responder
      TypeName="EscalateResponder"
      Name="AMAgentCategoryErrorEscalateResponder"
      ComponentName="AMScanError"
      AlertTypeId="AMAgentCategoryErrorMonitor"
      AlertMask="AMAgentCategoryErrorMonitor"
      TargetHealthState="None"
      EscalationTeam="FIPS"
      EscalationSubjectUnhealthy="Antimalware: All engine errors"
      EscalationMessageUnhealthy="
      &lt;br/&gt;All engines threw an error for atleast 5 messages in the last 5 mins:&lt;pre&gt;{Monitor.TotalFailedCount}&lt;/pre&gt;
      &lt;br/&gt;Details:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;"
      EscalationLevel="Urgent"/>
  </NTEvent>

  <NTEvent>
    <Monitor
      TypeName="OverallXFailuresMonitor"
      Name="ReputationFileHashPublisherFailureMonitor"
      ComponentName="AMService"
      EventNotificationServiceName="Antimalware"
      EventNotificationComponent="ReputationFileHashPublisher.PublishFailure"
      MonitoringIntervalSeconds="60"
      MonitoringThreshold="5"
      TimeoutSeconds="30"
      RecurrenceIntervalSeconds="60"
      Enabled="true"/>
    <Responder
      TypeName="EscalateResponder"
      Name="ReputationFileHashPublisherFailureEscalateResponder"
      ComponentName="AMService"
      AlertTypeId="ReputationFileHashPublisherFailureMonitor"
      AlertMask="ReputationFileHashPublisherFailureMonitor"
      TargetHealthState="None"
      EscalationTeam="FIPS"
      EscalationSubjectUnhealthy="Failed to publish file hashes to reputation service."
      EscalationMessageUnhealthy="
      &lt;br/&gt;Details:&lt;pre&gt;{Probe.Error}&lt;/pre&gt;"
      EscalationLevel="Scheduled"/>
  </NTEvent>

   <NTEvent>
    <Monitor
      TypeName="OverallXFailuresMonitor"
      Name="HygieneDataSummaryGenerator.LogExceptionMonitor"
      ComponentName="AntiSpam"
      EventNotificationServiceName="AntiSpam"
      EventNotificationComponent="HygieneDataSummaryGenerator.LogException"
      MonitoringIntervalSeconds="1800"
      MonitoringThreshold="3"
      RecurrenceIntervalSeconds="900"
      Enabled="true"/>
    <Responder
      TypeName="EscalateResponder"
      Name="HygieneDataSummaryGenerator.LogExceptionResponder"
      ComponentName="AntiSpam"
      AlertTypeId="HygieneDataSummaryGenerator.LogExceptionMonitor"
      AlertMask="HygieneDataSummaryGenerator.LogExceptionMonitor"
      EscalationTeam="AntiSpam"
      EscalationSubjectUnhealthy="HygieneDataSummaryGenerator - Log Creation Exception Occurred."
      EscalationMessageUnhealthy="{Probe.Error}"
      EscalationLevel="Scheduled"/>
  </NTEvent>

</Definition>
