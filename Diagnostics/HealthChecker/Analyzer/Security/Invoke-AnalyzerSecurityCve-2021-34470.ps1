# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

. $PSScriptRoot\..\Add-AnalyzedResultInformation.ps1
. $PSScriptRoot\..\..\..\..\Shared\CompareExchangeBuildLevel.ps1
function Invoke-AnalyzerSecurityCve-2021-34470 {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ref]$AnalyzeResults,

        [Parameter(Mandatory = $true)]
        [object]$SecurityObject,

        [Parameter(Mandatory = $true)]
        [object]$DisplayGroupingKey
    )

    Write-Verbose "Calling: $($MyInvocation.MyCommand)"
    #Description: Check for CVE-2021-34470 rights elevation vulnerability
    #Affected Exchange versions: 2013, 2016, 2019
    #Fix:
    ##Exchange 2013 CU23 + July 2021 SU + /PrepareSchema,
    ##Exchange 2016 CU20 + July 2021 SU + /PrepareSchema or CU21,
    ##Exchange 2019 CU9 + July 2021 SU + /PrepareSchema or CU10
    #Workaround: N/A

    if (($SecurityObject.MajorVersion -eq "Exchange2013") -or
        ((Test-ExchangeBuildLessThanBuild -CurrentExchangeBuild $SecurityObject.BuildInformation -Version "Exchange2016" -CU "CU21") -or
            (Test-ExchangeBuildLessThanBuild -CurrentExchangeBuild $SecurityObject.BuildInformation -Version "Exchange2019" -CU "CU10")) -and
        $SecurityObject.IsEdgeServer -eq $false) {
        Write-Verbose "Testing CVE: CVE-2021-34470"

        $displayWriteTypeColor = $null
        if ($SecurityObject.MajorVersion -eq "Exchange2013") {
            TestVulnerabilitiesByBuildNumbersForDisplay -ExchangeBuildRevision "$($SecurityObject.ExchangeInformation.BuildInformation.ExchangeSetup.FileBuildPart).$($SecurityObject.ExchangeInformation.BuildInformation.ExchangeSetup.FilePrivatePart)" -SecurityFixedBuilds "1497.23" -CVENames "CVE-2021-34470"
        }

        if ($SecurityObject.OrgInformation.SecurityResults.CVE202134470.Unknown -or
            $SecurityObject.OrgInformation.SecurityResults.CVE202134470.IsVulnerable.ToString() -eq "Unknown") {
            Write-Verbose "Unable to query classSchema: 'ms-Exch-Storage-Group' information"
            $details = "CVE-2021-34470`r`n`t`tWarning: Unable to query classSchema: 'ms-Exch-Storage-Group' to perform testing."
            $displayWriteTypeColor = "Yellow"
        } elseif ($SecurityObject.OrgInformation.SecurityResults.CVE202134470.IsVulnerable -eq $true) {
            Write-Verbose "Attribute: 'possSuperiors' with value: 'computer' detected in classSchema: 'ms-Exch-Storage-Group'"
            $details = "CVE-2021-34470`r`n`t`tPrepareSchema required: https://aka.ms/HC-July21SU"
            $displayWriteTypeColor = "Red"
        } else {
            Write-Verbose "System NOT vulnerable to CVE-2021-34470"
        }

        if ($null -ne $displayWriteTypeColor) {
            $params = @{
                AnalyzedInformation = $AnalyzeResults
                DisplayGroupingKey  = $DisplayGroupingKey
                Name                = "Security Vulnerability"
                Details             = $details
                DisplayWriteType    = $displayWriteTypeColor
                DisplayTestingValue = "CVE-2021-34470"
                AddHtmlDetailRow    = $false
            }
            Add-AnalyzedResultInformation @params
        }
    } else {
        Write-Verbose "System NOT vulnerable to CVE-2021-34470"
    }
}
