# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

. $PSScriptRoot\..\Add-AnalyzedResultInformation.ps1
function Invoke-AnalyzerSecurityCve-2022-21979 {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ref]$AnalyzeResults,

        [Parameter(Mandatory = $true)]
        [object]$SecurityObject,

        [Parameter(Mandatory = $true)]
        [object]$DisplayGroupingKey
    )

    Write-Verbose "Calling: $($MyInvocation.MyCommand)"
    $printSpoolerConfig = $SecurityObject.ExchangeInformation.PrintSpoolerConfiguration

    $baseParams = @{
        AnalyzedInformation = $AnalyzeResults
        DisplayGroupingKey  = $DisplayGroupingKey
    }

    if ($null -ne $printSpoolerConfig) {
        Write-Verbose "Print spooler information found - performing vulnerability testing"

        # Description: Check for CVE-2022-21979 vulnerability
        # Affected Exchange versions: 2013, 2016 and 2019
        # Fix: Stop and disable print spooler service
        Write-Verbose "Testing CVE: CVE-2022-21979"
        if ($printSpoolerConfig.SpoolerConfigSecure -eq $false) {
            $spoolerCveParams = $baseParams + @{
                Name             = "Security Vulnerability"
                Details          = "CVE-2022-21979"
                DisplayWriteType = "Red"
            }
            $spoolerBasicParams = $baseParams + @{
                DisplayWriteType       = "Red"
                DisplayCustomTabNumber = 2
                Details                = "Print spooler should be: 'Stopped' and set to: 'Disabled'. Current config:"
            }
            Add-AnalyzedResultInformation @spoolerCveParams
            Add-AnalyzedResultInformation @spoolerBasicParams

            $spoolerOutputObjectDisplayValue = New-Object System.Collections.Generic.List[object]
            $spoolerOutputObjectDisplayValue.Add(([PSCustomObject]@{
                        ServiceStatus = $printSpoolerConfig.SpoolerStatus
                        StartupType   = $printSpoolerConfig.SpoolerStartType
                    })
            )

            $spoolerConfig = {
                param ($o, $p)
                if ($p -eq "ServiceStatus") {
                    if ($o.$p -ne "Stopped") {
                        "Red"
                    } else {
                        "Green"
                    }
                } else {
                    if ($o.$p -ne "Disabled") {
                        "Red"
                    } else {
                        "Green"
                    }
                }
            }

            $spoolerParams = $baseParams + @{
                Name                = "Security Vulnerability"
                OutColumns          = ([PSCustomObject]@{
                        DisplayObject      = $spoolerOutputObjectDisplayValue
                        ColorizerFunctions = @($spoolerConfig)
                        IndentSpaces       = 8
                    })
                DisplayTestingValue = "CVE-2022-21979"
            }
            Add-AnalyzedResultInformation @spoolerParams
        } else {
            Write-Verbose "System NOT vulnerable to CVE-2022-21979"
        }
    } else {
        Write-Verbose "No print spooler configuration found - check will be skipped"
    }
}
